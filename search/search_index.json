{"config":{"lang":["en"],"separator":"[\\s\\-,:!=\\[\\]()\"/]+|(?!\\b)(?=[A-Z][a-z])","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"NILS - Neuroimaging Intelligent Linked System","text":"<p> A comprehensive system for DICOM classification, sorting, anonymization, and BIDS export </p> <p> Developed at Karolinska Institutet   Department of Clinical Neuroscience, Neuroradiology </p>"},{"location":"#what-is-nils","title":"What is NILS?","text":"<p>NILS (Neuroimaging Intelligent Linked System) is a full-stack application designed for research institutions to efficiently manage neuroimaging data. It provides a complete pipeline from raw DICOM ingestion to BIDS-compliant export.</p>"},{"location":"#core-capabilities","title":"Core Capabilities","text":""},{"location":"#six-axis-classification-system","title":"Six-Axis Classification System","text":"<p>NILS classifies MRI series using six orthogonal axes:</p> Axis Description Examples Base Contrast weighting T1w, T2w, PD, DWI, BOLD, SWI Technique Pulse sequence family MPRAGE, TSE, FLASH, EPI, GRASE Modifier Acquisition enhancements FLAIR, FatSat, MT, IR, PhaseContrast Construct Derived/map type ADC, FA, MD, T1Map, T2Map, CBF Provenance Processing pipeline SyMRI, SWIRecon, DTIRecon, RawRecon Acceleration Parallel imaging GRAPPA, SMS, CAIPIRINHA"},{"location":"#data-hierarchy","title":"Data Hierarchy","text":"<p>NILS organizes imaging data in a 4-level hierarchy:</p> <pre><code>Subject (Patient)\n\u2514\u2500\u2500 Study (Imaging Session)\n    \u2514\u2500\u2500 Series (Acquisition)\n        \u2514\u2500\u2500 SeriesStack (Homogeneous Instance Group)\n</code></pre> <p>SeriesStack is a key concept - it represents a group of instances within a series that share identical acquisition parameters. This handles multi-echo, multi-flip-angle, and other complex acquisitions.</p>"},{"location":"#documentation","title":"Documentation","text":"<ul> <li>Concepts - Core data models, entities, and terminology</li> <li>Cohort Operations - Extraction, Sorting, Anonymization, Export</li> <li>Classification - The six-axis detection system</li> <li>QC &amp; Viewer - Quality control and image review</li> </ul>"},{"location":"#quick-start","title":"Quick Start","text":"<pre><code># Clone and start\ngit clone https://github.com/NeuroGranberg/NILS.git\ncd NILS\n./scripts/manage.sh start\n\n# Access web interface\nopen http://localhost:5173\n</code></pre>"},{"location":"#requirements","title":"Requirements","text":"<ul> <li>Docker &amp; Docker Compose</li> <li>4GB RAM minimum (8GB recommended)</li> <li>Modern web browser</li> </ul>"},{"location":"#license","title":"License","text":"<p>MIT License - See LICENSE</p>"},{"location":"#citation","title":"Citation","text":"<p>If you use NILS in your research, please cite:</p> <p>Chamyani, N. (2025). NILS - Neuroimaging Intelligent Linked System. Karolinska Institutet, Department of Clinical Neuroscience. https://github.com/NeuroGranberg/NILS</p>"},{"location":"changelog/","title":"Changelog","text":"<p>All notable changes to NILS will be documented in this file.</p> <p>The format is based on Keep a Changelog, and this project adheres to Semantic Versioning.</p>"},{"location":"changelog/#020-2025-12-25","title":"[0.2.0] - 2025-12-25","text":""},{"location":"changelog/#added","title":"Added","text":"<ul> <li>Extraction Retry with Exponential Backoff: Transient database errors (OOM, timeouts) now trigger automatic retry</li> <li>Retries indefinitely until all data is written - never skips data</li> <li>Adaptive batch size reduction during memory pressure</li> <li>Initial delay of 2s, max delay capped at 2 minutes</li> <li>Periodic Cache Pruning: In-memory lookup caches are pruned during long-running extractions</li> <li>Prevents unbounded memory growth over multi-day extractions (previously could reach several GB)</li> <li>Prunes after every 100 subjects processed</li> <li>Orphaned Job Recovery on Startup: Jobs that were running when backend crashed/restarted are now marked as failed</li> <li>Clear error message explaining the interruption and how to resume</li> <li>Enables resume from where extraction left off</li> <li>Metrics Caching: Cohort metrics cached for 30 seconds to avoid repeated expensive COUNT queries</li> <li>Fast approximate counts using PostgreSQL statistics for instant response</li> <li>Cache invalidation after extraction completes</li> <li>Parents-First Write Pattern: New insertion strategy that prevents orphan database records</li> <li>Pre-filters duplicates before creating parent records (subject/study/series)</li> <li>Eliminates dead rows from PostgreSQL MVCC overhead (~50% storage savings on large extractions)</li> <li>Comprehensive test suite validates no orphan records are created</li> <li>Database Foreign Key Constraints: Added explicit FK constraints with CASCADE delete</li> <li>Ensures referential integrity across subject \u2192 study \u2192 series \u2192 instance hierarchy</li> <li>Frontend Query Garbage Collection: Unused cached queries now garbage collected after 5 minutes</li> </ul>"},{"location":"changelog/#fixed","title":"Fixed","text":"<ul> <li>PostgreSQL Out-of-Memory During Large Extractions (30M+ instances)</li> <li>Reduced work memory from 256MB to 32MB per query</li> <li>Disabled parallel query workers during extraction</li> <li>Added 48GB memory limit to metadata database container</li> <li>Increased shared memory allocation to 4GB</li> <li>Memory Growth in Extraction Writer</li> <li>Eliminated reverse lookup cache that could grow to ~850MB for large cohorts</li> <li>Stack queries now use efficient JOIN instead of in-memory lookup</li> <li>Frontend Memory Growth</li> <li>Removed aggressive polling on cohorts list (now manual refresh)</li> <li>Reduced job list polling from 5s to 15s</li> <li>Disabled automatic polling on administrative pages (backups, database info)</li> <li>Disabled polling on health/readiness endpoints</li> <li>Cohort Detail API Performance: Metrics now fetched once and reused for all job history entries</li> <li>Modality Details Conflict Handling: Fixed edge case where series processed after rollback could fail</li> </ul>"},{"location":"changelog/#changed","title":"Changed","text":"<ul> <li>PostgreSQL Configuration optimized for large extraction workloads</li> <li>Shared buffers: 2GB \u2192 4GB</li> <li>Work memory: 256MB \u2192 32MB (conservative for concurrent writes)</li> <li>Effective cache size: 4GB \u2192 32GB</li> <li>Added connection limit of 50</li> <li>Added query timeout of 120s to kill runaway queries</li> <li>Added idle transaction timeout of 5 minutes</li> <li>Added slow query logging (&gt;10s)</li> <li>Frontend Independence: Frontend container no longer waits for backend to be healthy</li> <li>Prevents frontend restarts from interrupting long-running backend extraction jobs</li> <li>Frontend gracefully handles backend unavailability</li> <li>Production Build Optimization: Removes debugger statements and console.log in production builds</li> </ul>"},{"location":"changelog/#010-2025-12-18","title":"[0.1.0] - 2025-12-18","text":""},{"location":"changelog/#added_1","title":"Added","text":"<ul> <li>Initial release of NILS - Neuroimaging Intelligent Linked System</li> <li>DICOM Classification System: Rule-based classification with YAML configuration</li> <li>Base sequence detection (T1w, T2w, FLAIR, DWI, etc.)</li> <li>Technique detection (acceleration, contrast, orientation)</li> <li>Special case handling (EPIMix, SWI, SyMRI, Dixon, MP2RAGE)</li> <li>Sorting Pipeline: Automated DICOM organization and file management</li> <li>Pseudo-anonymization: Secure patient data de-identification</li> <li>Metadata Extraction: DICOM tag extraction and CSV/Excel import</li> <li>BIDS Export: Brain Imaging Data Structure compliant export</li> <li>Quality Control: Visual QC workflow with DICOM viewer integration</li> <li>Web Interface: React-based UI with dark theme</li> <li>Dashboard overview</li> <li>Database browser</li> <li>Cohort management</li> <li>Job monitoring</li> <li>Docker Compose Deployment: Containerized full-stack application</li> <li>Dual Database System: Separate application and metadata PostgreSQL databases</li> </ul>"},{"location":"classification/","title":"Classification System","text":"<p>NILS uses a provenance-first, six-axis classification system to identify MRI sequences. The classification is YAML-driven and extensible.</p> <p>Start Here: Detection Infrastructure</p> <p>Before diving into the six axes, understand how NILS detects MRI features by reading the Detection Infrastructure documentation. It covers:</p> <ul> <li>Stack Fingerprints - The extracted DICOM feature vectors</li> <li>DICOM Tag Parsers - Five parsers that tokenize DICOM fields</li> <li>107 Unified Flags - Vendor-agnostic boolean detection flags</li> <li>Text Search Blob - Normalized text from SeriesDescription</li> <li>Evidence System - Confidence scoring and audit trails</li> </ul>"},{"location":"classification/#the-six-axes","title":"The Six Axes","text":"<p>Classification results are stored in <code>SeriesClassificationCache</code> with six orthogonal axes:</p> Axis Question Answered Output Example Base What contrast weighting? Single value T1w, T2w, DWI Technique What pulse sequence? Single value MPRAGE, TSE, EPI Modifier What enhancements? CSV list FLAIR, FatSat, 3D Construct What derived maps? CSV list ADC, FA, T1Map Provenance What processing pipeline? Single value SyMRI, SWIRecon Acceleration What parallel imaging? CSV list GRAPPA, SMS"},{"location":"classification/#1-base-contrast-weighting","title":"1. Base (Contrast Weighting)","text":"<p>The fundamental contrast mechanism of the image. Full documentation \u2192</p> Value Description <code>T1w</code> T1-weighted (short TR/TE, anatomy) <code>T2w</code> T2-weighted (long TR/TE, pathology) <code>PDw</code> Proton density weighted <code>T2*w</code> T2-star weighted (susceptibility) <code>DWI</code> Diffusion-weighted imaging <code>PWI</code> Perfusion-weighted imaging <code>SWI</code> Susceptibility-weighted imaging <code>MTw</code> Magnetization transfer weighted"},{"location":"classification/#2-technique-pulse-sequence-family","title":"2. Technique (Pulse Sequence Family)","text":"<p>The acquisition pulse sequence type. Full documentation \u2192</p> Family Techniques Physics SE TSE, HASTE, SPACE, TIRM, MESE 180\u00b0 refocusing pulse GRE MPRAGE, FLASH, FIESTA, VIBE, TOF Gradient refocusing EPI EPI, RESOLVE Echo planar readout MIXED DWI-EPI, BOLD, ASL, GRASE Hybrid physics"},{"location":"classification/#3-modifier-acquisition-enhancements","title":"3. Modifier (Acquisition Enhancements)","text":"<p>Additional acquisition modifiers (comma-separated, additive). Full documentation \u2192</p> Category Modifiers Purpose IR Contrast FLAIR, STIR, DIR, PSIR Tissue nulling Fat Suppression FatSat, WaterExc, Dixon Fat signal removal Signal MT, FlowComp, MoCo Signal modification Trajectory Radial, Spiral Non-Cartesian k-space"},{"location":"classification/#4-construct-derivedmap-type","title":"4. Construct (Derived/Map Type)","text":"<p>Computed outputs from acquisitions (comma-separated, additive). Full documentation \u2192</p> Category Constructs Source Diffusion ADC, FA, Trace, MD DWI/DTI Perfusion CBF, CBV, MTT, Tmax, TTP DSC/ASL Quantitative T1map, T2map, R1map, PDmap Relaxometry MP2RAGE INV1, INV2, Uniform, Denoised MP2RAGE Synthetic SyntheticT1w, SyntheticFLAIR SyMRI Projection MIP, MinIP, MPR Post-processing"},{"location":"classification/#5-provenance-processing-pipeline","title":"5. Provenance (Processing Pipeline)","text":"<p>Identifies the source/processing pipeline. Detected first to determine classification branch. Full documentation \u2192</p> Provenance Branch Description SyMRI <code>symri</code> Synthetic MRI (MAGiC, QALAS) SWIRecon <code>swi</code> Susceptibility-weighted imaging EPIMix <code>epimix</code> Multicontrast EPI (NeuroMix) DTIRecon <code>rawrecon</code> Diffusion tensor maps PerfusionRecon <code>rawrecon</code> Perfusion parameter maps Localizer <code>rawrecon</code> Scout images RawRecon <code>rawrecon</code> Default (standard recon)"},{"location":"classification/#6-acceleration-parallel-imaging","title":"6. Acceleration (Parallel Imaging)","text":"<p>K-space acceleration methods (comma-separated, additive). Full documentation \u2192</p> Acceleration Abbreviation Mechanism ParallelImaging PI GRAPPA/SENSE/ARC coil encoding SimultaneousMultiSlice SMS Multiband excitation PartialFourier PF Half-Fourier reconstruction CompressedSensing CS Sparse reconstruction ViewSharing VS TWIST/TRICKS temporal sharing"},{"location":"classification/#classification-pipeline","title":"Classification Pipeline","text":"<p>The classification runs through 10 stages:</p> <pre><code>flowchart TB\n    subgraph stage0[\"Stage 0: Exclusion Check\"]\n        s0[\"Filter screenshots, secondary reformats, error maps\"]\n    end\n\n    subgraph stage1[\"Stage 1: Provenance Detection\"]\n        s1[\"Determines classification branch&lt;br/&gt;\u2192 SyMRI, SWIRecon, DTIRecon, RawRecon, etc.\"]\n    end\n\n    subgraph stage2[\"Stage 2: Technique Detection\"]\n        s2[\"Pulse sequence family identification\"]\n    end\n\n    subgraph stage3[\"Stage 3: Branch Logic\"]\n        s3a[\"SWI Branch \u2192 swi.py\"]\n        s3b[\"SyMRI Branch \u2192 symri.py\"]\n        s3c[\"EPIMix Branch \u2192 epimix.py\"]\n        s3d[\"RawRecon \u2192 standard detection\"]\n    end\n\n    subgraph stages49[\"Stages 4-9: Additional Detection\"]\n        s4[\"4: Modifier Detection\"]\n        s5[\"5: Acceleration Detection\"]\n        s6[\"6: Contrast Agent Detection\"]\n        s7[\"7: Body Part Detection\"]\n        s8[\"8: Intent Synthesis (BIDS)\"]\n        s9[\"9: Review Flag Aggregation\"]\n    end\n\n    stage0 --&gt; stage1\n    stage1 --&gt; stage2\n    stage2 --&gt; stage3\n    stage3 --&gt; stages49</code></pre>"},{"location":"classification/#provenance-first-detection","title":"Provenance-First Detection","text":"<p>Why provenance first?</p> <p>Different processing pipelines produce images that need different classification logic:</p> <ul> <li>SyMRI synthetic images should be classified as <code>T1w_synthetic</code>, <code>T2w_synthetic</code>, etc.</li> <li>SWI processed images need special handling for QSM, phase, magnitude</li> <li>DTI derived maps should have proper construct labels (ADC, FA, MD)</li> </ul> <p>By detecting provenance first, NILS routes to the correct classification branch.</p>"},{"location":"classification/#provenance-detection-logic","title":"Provenance Detection Logic","text":"<p>The <code>ProvenanceDetector</code> uses a four-tier matching system:</p> <ol> <li>Exclusive flag - A single unified flag that definitively identifies provenance</li> <li>Alternative flags - Any matching flag (OR logic)</li> <li>Keywords - Text pattern matching in series description</li> <li>Combination - All required flags must match (AND logic)</li> </ol>"},{"location":"classification/#classification-branches","title":"Classification Branches","text":"<p>Advanced MRI technologies produce multiple outputs from a single acquisition, requiring specialized classification logic. NILS uses branches to handle these cases. Full branches documentation \u2192</p> Branch Provenance Output Types Key Feature SyMRI <code>SyMRI</code> 17+ types (maps, synthetic contrasts) Quantitative maps have <code>base=NULL</code> SWI <code>SWIRecon</code> 6 types (magnitude, phase, QSM) All outputs have <code>base=SWI</code> EPIMix <code>EPIMix</code> 6+ types (T1-FLAIR to T2*w) 6 contrasts from 1-min scan RawRecon Default Standard classification Uses axis detectors directly"},{"location":"classification/#why-branches","title":"Why Branches?","text":"<p>Standard axis detectors cannot handle multi-output acquisitions because:</p> <ul> <li>All outputs share the same source sequence</li> <li>ImageType tokens have technology-specific meanings</li> <li>Some outputs have NO tissue contrast (<code>base=NULL</code>)</li> <li>Provenance determines the classification logic</li> </ul>"},{"location":"classification/#symri-branch-highlights","title":"SyMRI Branch Highlights","text":"<p>SyMRI (MAGiC, QALAS) produces 1-20+ DICOM series from a single 5-minute scan:</p> Output Category Examples Base Contrast Raw source Magnitude, Phase NULL Quantitative maps T1map, T2map, PDmap, MyelinMap NULL Synthetic weighted SyntheticT1w, SyntheticT2w T1w, T2w, PDw Synthetic IR SyntheticFLAIR, SyntheticDIR T2w with modifiers <p>Full SyMRI branch documentation \u2192</p>"},{"location":"classification/#detection-yaml-files","title":"Detection YAML Files","text":"<p>Classification rules are configured in YAML files located in <code>backend/src/classification/detection_yaml/</code>:</p> File Purpose <code>base-detection.yaml</code> Base contrast weighting rules <code>technique-detection.yaml</code> Pulse sequence identification <code>modifier-detection.yaml</code> Acquisition modifiers <code>construct-detection.yaml</code> Derived maps <code>provenance-detection.yaml</code> Processing pipeline detection <code>acceleration-detection.yaml</code> Parallel imaging schemes <code>contrast-detection.yaml</code> Contrast agent detection <code>body_part-detection.yaml</code> Anatomical region detection <code>unified-flags-reference.yaml</code> Reference for 55+ boolean flags"},{"location":"classification/#unified-flags","title":"Unified Flags","text":"<p>NILS parses DICOM <code>ImageType</code> and other fields into 55+ boolean flags:</p> <ul> <li><code>is_original</code>, <code>is_derived</code>, <code>is_primary</code>, <code>is_secondary</code></li> <li><code>is_magnitude</code>, <code>is_phase</code>, <code>is_real</code>, <code>is_imaginary</code></li> <li><code>is_diffusion</code>, <code>is_adc_map</code>, <code>is_fa_map</code></li> <li><code>is_perfusion</code>, <code>is_swi_combined</code>, <code>is_symri_source</code></li> <li>And many more...</li> </ul> <p>These flags drive the classification rules.</p>"},{"location":"classification/#classification-output","title":"Classification Output","text":"<p>Results are stored in <code>SeriesClassificationCache</code>:</p> <pre><code>{\n    \"base\": \"T1w\",\n    \"technique\": \"MPRAGE\",\n    \"modifier_csv\": \"3D\",\n    \"construct_csv\": None,\n    \"provenance\": \"RawRecon\",\n    \"acceleration_csv\": \"GRAPPA\",\n    \"post_contrast\": 0,\n    \"localizer\": 0,\n    \"spinal_cord\": 0,\n    \"directory_type\": \"anat\",\n    \"manual_review_required\": 0,\n    \"manual_review_reasons_csv\": None\n}\n</code></pre>"},{"location":"classification/#manual-review-triggers","title":"Manual Review Triggers","text":"<p>The system flags series for manual review when:</p> <ul> <li>Classification confidence is low</li> <li>Spinal cord is detected (special handling needed)</li> <li>Contrast agent status is ambiguous</li> <li>Provenance detection is uncertain</li> <li>Multiple conflicting signals are present</li> </ul> <p>Review reasons are stored in <code>manual_review_reasons_csv</code>:</p> <ul> <li><code>base:</code> - Base contrast issue</li> <li><code>provenance:</code> - Provenance detection issue</li> <li><code>technique:</code> - Technique detection issue</li> <li><code>body_part:spine</code> - Spinal cord detected</li> <li><code>contrast:</code> - Contrast agent ambiguity</li> <li><code>heuristic:</code> - Geometric/parameter heuristics</li> </ul>"},{"location":"classification/#extending-classification","title":"Extending Classification","text":"<p>To add new classification rules:</p> <ol> <li>Edit the appropriate YAML file in <code>detection_yaml/</code></li> <li>Define matching conditions using unified flags and/or keywords</li> <li>Restart the backend</li> </ol> <p>See the Detection Infrastructure documentation for YAML syntax details.</p>"},{"location":"classification/acceleration/","title":"Acceleration Axis","text":"<p>The Acceleration axis identifies k-space acceleration methods used to reduce scan time. It answers the question: \"How was the acquisition sped up?\"</p>"},{"location":"classification/acceleration/#overview","title":"Overview","text":"<p>Accelerations are additive - multiple methods can be used simultaneously in a single acquisition.</p> Acceleration Abbreviation Mechanism ParallelImaging PI Coil sensitivity encoding SimultaneousMultiSlice SMS Multiband excitation PartialFourier PF Incomplete k-space with reconstruction CompressedSensing CS Sparse reconstruction ViewSharing VS Temporal k-space reuse"},{"location":"classification/acceleration/#key-concepts","title":"Key Concepts","text":""},{"location":"classification/acceleration/#additive-logic","title":"Additive Logic","text":"<p>Multiple accelerations can coexist:</p> <pre><code>fMRI acquisition \u2192 acceleration_csv = \"ParallelImaging,PartialFourier,SimultaneousMultiSlice\"\nStandard T1w    \u2192 acceleration_csv = \"ParallelImaging\"\nDynamic MRA     \u2192 acceleration_csv = \"ParallelImaging,ViewSharing\"\n</code></pre>"},{"location":"classification/acceleration/#database-coverage","title":"Database Coverage","text":"<p>From 457K+ validated fingerprints:</p> Acceleration Stack Count Common Use Partial Fourier (Phase) 98,118 TSE, EPI Parallel Imaging 80,746 Nearly universal Multiband/SMS 37,982 fMRI, DWI Partial Fourier (Freq) 35,041 Less common HyperSense 12,969 GE specific Compressed Sensing ~200 Newer sequences"},{"location":"classification/acceleration/#detection-strategy","title":"Detection Strategy","text":"<p>Acceleration uses a five-tier detection priority:</p> <ol> <li>Unified flags (95%) - Pre-computed from multiple sources</li> <li>Scan options flags (90%) - Vendor-specific DICOM tags</li> <li>DICOM tag (90%) - MR Parallel Acquisition Technique</li> <li>Keywords (80%) - Text matching</li> <li>Sequence name patterns (75%) - Regex matching</li> </ol>"},{"location":"classification/acceleration/#parallelimaging-grappasensearc","title":"ParallelImaging (GRAPPA/SENSE/ARC)","text":"<p>Physics: Uses spatial sensitivity profiles of multiple receiver coils to reduce phase-encoding steps. Missing k-space data is reconstructed using coil sensitivity information.</p>"},{"location":"classification/acceleration/#vendor-names","title":"Vendor Names","text":"Vendor Names Siemens GRAPPA, mSENSE, iPAT GE ARC, ASSET Philips SENSE, SPEEDER Canon SPEEDER"},{"location":"classification/acceleration/#detection","title":"Detection","text":"<p>Unified flags: - <code>has_parallel_imaging</code></p> <p>Scan options: - <code>has_parallel_gems</code> (GE ACC_GEMS) - <code>has_hypersense</code> (GE HyperSense)</p> <p>DICOM tag: MR Parallel Acquisition Technique (0018,9078) - Values: SENSE, GRAPPA, SPEEDER, CSENSE</p> <p>Keywords: - <code>grappa</code>, <code>sense</code>, <code>asset</code>, <code>ipat</code>, <code>msense</code>, <code>accelerat</code> - Bounded patterns: <code>\\barc\\b</code>, <code>arc[</code>, <code>_arc_</code></p> <p>Exclusions: <code>hypersense</code> (separate category)</p>"},{"location":"classification/acceleration/#characteristics","title":"Characteristics","text":"<ul> <li>Typical R factor: 2-4x</li> <li>Requirement: Multi-channel coil arrays</li> <li>Trade-off: SNR reduction (\u221aR penalty)</li> <li>Nearly universal in modern clinical MRI</li> </ul>"},{"location":"classification/acceleration/#simultaneousmultislice-smsmultiband","title":"SimultaneousMultiSlice (SMS/Multiband)","text":"<p>Physics: Uses composite RF pulses to excite multiple slices at once. Slice separation uses coil sensitivity encoding (similar to parallel imaging).</p>"},{"location":"classification/acceleration/#aliases","title":"Aliases","text":"<ul> <li>Multiband (MB)</li> <li>SMS</li> <li>SMS-EPI</li> <li>HyperBand</li> </ul>"},{"location":"classification/acceleration/#detection_1","title":"Detection","text":"<p>Keywords: - <code>multiband</code>, <code>multib</code>, <code>hyperband</code> - Bounded patterns: <code>\\bmb\\d</code>, <code>mb[</code>, <code>\\bsms\\b</code>, <code>_sms_</code></p> <p>Sequence patterns: - <code>cmrr</code> (CMRR multiband sequences) - <code>hyperband</code></p> <p>Exclusions: <code>combat</code>, <code>ambig</code>, <code>membrane</code>, <code>chamber</code>, <code>number</code></p>"},{"location":"classification/acceleration/#characteristics_1","title":"Characteristics","text":"<ul> <li>Typical MB factor: 2-8x</li> <li>Primary use: EPI sequences (fMRI, DWI)</li> <li>Trade-off: SNR reduction, slice cross-talk</li> <li>Requires post-processing to separate slices</li> </ul>"},{"location":"classification/acceleration/#partialfourier-half-fourier","title":"PartialFourier (Half-Fourier)","text":"<p>Physics: Exploits Hermitian symmetry of k-space to acquire only slightly more than half of k-space. Missing data is estimated using homodyne/POCS reconstruction.</p>"},{"location":"classification/acceleration/#subtypes","title":"Subtypes","text":"Subtype Direction Scan Option PFP Phase-encoding More common PFF Frequency-encoding Less common"},{"location":"classification/acceleration/#aliases_1","title":"Aliases","text":"<ul> <li>Half-Fourier</li> <li>5/8, 6/8, 7/8 (fraction of k-space)</li> </ul>"},{"location":"classification/acceleration/#detection_2","title":"Detection","text":"<p>Unified flags: - <code>has_partial_fourier</code></p> <p>Scan options: - <code>has_partial_fourier_phase</code> (PFP) - <code>has_partial_fourier_freq</code> (PFF)</p> <p>Keywords: - <code>partial fourier</code>, <code>half fourier</code>, <code>half-fourier</code> - Bounded patterns: <code>\\bpf\\b</code>, <code>5/8</code>, <code>6/8</code>, <code>7/8</code></p>"},{"location":"classification/acceleration/#characteristics_2","title":"Characteristics","text":"<ul> <li>Time reduction: ~20-40%</li> <li>SNR penalty: Some due to reconstruction</li> <li>Essential for: HASTE/SS-FSE sequences</li> <li>Can specify both phase and frequency directions</li> </ul>"},{"location":"classification/acceleration/#compressedsensing-cs","title":"CompressedSensing (CS)","text":"<p>Physics: Exploits sparsity of MR images in transform domains (wavelets, etc.) to reconstruct from highly undersampled, incoherently sampled k-space. Uses iterative nonlinear reconstruction.</p>"},{"location":"classification/acceleration/#aliases_2","title":"Aliases","text":"<ul> <li>CS-SENSE</li> <li>Sparse MRI</li> <li>Wave-CAIPI</li> </ul>"},{"location":"classification/acceleration/#detection_3","title":"Detection","text":"<p>Scan options: - <code>has_cs_gems</code> (GE CS_GEMS)</p> <p>Keywords: - <code>compressed sensing</code>, <code>compressedsense</code>, <code>sparse</code> - <code>wave-caipi</code>, <code>caipi</code> - Bounded patterns: <code>\\bcs\\[</code>, <code>_cs_</code></p> <p>Exclusions: <code>csf</code> (cerebrospinal fluid), <code>csa</code></p>"},{"location":"classification/acceleration/#characteristics_3","title":"Characteristics","text":"<ul> <li>Clinically available: ~2015+</li> <li>Typical R factor: 4-10x+ possible</li> <li>Reconstruction: Computationally intensive</li> <li>Often combined with parallel imaging</li> </ul>"},{"location":"classification/acceleration/#viewsharing-twisttrickskeyhole","title":"ViewSharing (TWIST/TRICKS/Keyhole)","text":"<p>Physics: Updates only central (low-frequency) k-space frequently while reusing peripheral (high-frequency) data from adjacent time frames. Enables high temporal resolution for dynamic imaging.</p>"},{"location":"classification/acceleration/#aliases_3","title":"Aliases","text":"Vendor Name Siemens TWIST GE TRICKS, DISCO, 4D-TRAK Generic Keyhole"},{"location":"classification/acceleration/#detection_4","title":"Detection","text":"<p>Keywords: - <code>twist</code>, <code>tricks</code>, <code>keyhole</code> - <code>view sharing</code>, <code>disco</code>, <code>4d-trak</code> - <code>time-resolved</code>, <code>differential subsampling</code></p> <p>Sequence patterns: - <code>fldyn</code> (dynamic with view sharing)</p>"},{"location":"classification/acceleration/#characteristics_4","title":"Characteristics","text":"<ul> <li>Primary use: Dynamic/DCE imaging, time-resolved MRA</li> <li>Trade-off: Spatial resolution for temporal resolution</li> <li>Often combined with parallel imaging</li> </ul>"},{"location":"classification/acceleration/#output-format","title":"Output Format","text":"<p>Acceleration output is a list (can be empty or contain multiple):</p> <pre><code>{\n    \"acceleration_csv\": \"ParallelImaging,PartialFourier,SimultaneousMultiSlice\"\n}\n</code></pre> <p>Or as list: <pre><code>[\"ParallelImaging\", \"PartialFourier\", \"SimultaneousMultiSlice\"]\n</code></pre></p>"},{"location":"classification/acceleration/#common-combinations","title":"Common Combinations","text":"Sequence Type Typical Accelerations Standard T1 MPRAGE ParallelImaging T2 TSE ParallelImaging, PartialFourier DWI-EPI ParallelImaging, PartialFourier fMRI (multiband) ParallelImaging, PartialFourier, SimultaneousMultiSlice Time-resolved MRA ParallelImaging, ViewSharing 3D with CS ParallelImaging, CompressedSensing HASTE PartialFourier"},{"location":"classification/acceleration/#confidence-levels","title":"Confidence Levels","text":"Detection Method Confidence Unified flag 95% Scan options 90% DICOM tag 90% Keywords 80% Sequence pattern 75%"},{"location":"classification/acceleration/#examples","title":"Examples","text":"Series Description Detected Accelerations <code>t1_mprage_sag_p2_iso</code> ParallelImaging <code>ep2d_diff_mddw_30_mb3_p2</code> ParallelImaging, SimultaneousMultiSlice <code>tse_tra_fs_pf</code> PartialFourier <code>t1_space_sag_grappa2</code> ParallelImaging <code>ep_bold_mb4</code> SimultaneousMultiSlice <code>twist_mra_tra</code> ViewSharing <code>t1_mprage_cs</code> CompressedSensing"},{"location":"classification/acceleration/#detection-notes","title":"Detection Notes","text":""},{"location":"classification/acceleration/#false-positive-prevention","title":"False Positive Prevention","text":"<p>Several keywords have built-in exclusion patterns to prevent false positives:</p> Acceleration Exclusions ParallelImaging <code>hypersense</code> SMS <code>combat</code>, <code>ambig</code>, <code>membrane</code>, <code>chamber</code>, <code>number</code> CompressedSensing <code>csf</code>, <code>csa</code>"},{"location":"classification/acceleration/#word-boundary-patterns","title":"Word Boundary Patterns","text":"<p>Some keywords use word boundaries to avoid false matches: - <code>\\barc\\b</code> - Matches \"ARC\" but not \"search\" or \"march\" - <code>\\bmb\\d</code> - Matches \"mb2\", \"mb3\" but not \"symbol\" - <code>\\bsms\\b</code> - Matches standalone \"SMS\"</p>"},{"location":"classification/acceleration/#yaml-configuration","title":"YAML Configuration","text":"<p>Acceleration is configured in <code>backend/src/classification/detection_yaml/acceleration-detection.yaml</code>:</p> <pre><code>accelerations:\n  ParallelImaging:\n    name: \"ParallelImaging\"\n    abbreviation: \"PI\"\n    description: \"Coil-sensitivity-based acceleration\"\n\n    detection:\n      unified_flags:\n        - has_parallel_imaging\n      scan_options_flags:\n        - has_parallel_gems\n        - has_hypersense\n      dicom_tag:\n        tag: \"(0018,9078)\"\n        values: [\"SENSE\", \"GRAPPA\"]\n      keywords:\n        - \"grappa\"\n        - \"sense\"\n      exclude_keywords:\n        - \"hypersense\"\n\n  SimultaneousMultiSlice:\n    name: \"SimultaneousMultiSlice\"\n    abbreviation: \"SMS\"\n    detection:\n      keywords:\n        - \"multiband\"\n        - \"hyperband\"\n      sequence_name_patterns:\n        - \"cmrr\"\n      exclude_keywords:\n        - \"combat\"\n\ndetection_priority:\n  - unified_flags\n  - scan_options_flags\n  - dicom_tag\n  - keywords\n  - sequence_name_patterns\n\nconfidence_thresholds:\n  unified_flag: 0.95\n  scan_options: 0.90\n  keywords: 0.80\n</code></pre>"},{"location":"classification/acceleration/#convenience-methods","title":"Convenience Methods","text":"<pre><code># Check if any acceleration detected\noutput.has_acceleration  # True/False\n\n# Check specific acceleration\noutput.has(\"ParallelImaging\")  # True/False\n\n# Get all detected acceleration names\noutput.values  # [\"ParallelImaging\", \"PartialFourier\"]\n\n# Get specific acceleration result with details\nresult = output.get(\"PartialFourier\")\nresult.subtype  # \"phase\" or \"frequency\" or \"phase+frequency\"\nresult.confidence  # 0.95\nresult.detection_method  # \"unified_flag\"\n</code></pre>"},{"location":"classification/base/","title":"Base Contrast Axis","text":"<p>The Base axis represents the fundamental tissue contrast weighting of an MRI series. It answers the question: \"What physical contrast mechanism is this image based on?\"</p>"},{"location":"classification/base/#overview","title":"Overview","text":"<p>Base contrast is determined by the MRI physics parameters (TR, TE, TI) and acquisition type. Each base contrast emphasizes different tissue properties:</p> Base Full Name Primary Signal Clinical Use T1w T1-weighted Short TR/TE, WM bright Anatomy, Gd enhancement T2w T2-weighted Long TR/TE, fluid bright Pathology detection PDw Proton density Long TR, short TE Tissue composition T2*w T2-star weighted GRE, susceptibility Iron, blood products DWI Diffusion-weighted Water motion Stroke, tumors PWI Perfusion-weighted Blood flow Hemodynamics SWI Susceptibility-weighted Phase + magnitude Veins, microbleeds MTw Magnetization transfer Bound protons Myelin integrity T1rho T1-rho weighted Spin-lock Cartilage, research"},{"location":"classification/base/#detection-strategy","title":"Detection Strategy","text":"<p>NILS uses a four-tier detection approach (in priority order):</p>"},{"location":"classification/base/#tier-1-technique-inference","title":"Tier 1: Technique Inference","text":"<p>Some pulse sequences physics-lock to a specific base contrast:</p> Technique Implied Base Confidence MPRAGE, MEMPRAGE, MP2RAGE T1w 95% TOF-MRA T1w 90% ME-GRE, comb-ME-GRE T2*w 85-90% SWI SWI 95% DWI-EPI DWI 95% ASL-EPI, DSC-EPI PWI 90-95% <p>Why? These techniques have physics constraints that determine contrast. MPRAGE always has T1-weighting due to its IR-prepared 3D GRE design.</p>"},{"location":"classification/base/#tier-2-exclusive-flags","title":"Tier 2: Exclusive Flags","text":"<p>Definitive signals from <code>unified_flags</code> that immediately identify base:</p> <p>DWI indicators: - <code>is_dwi</code> - Diffusion sequence flag - <code>has_adc</code> - ADC map present - <code>has_fa</code> - FA map present - <code>has_trace</code> - Trace diffusion</p> <p>PWI indicators: - <code>is_perfusion</code> - Perfusion flag - <code>is_asl</code> - Arterial spin labeling - <code>has_cbf</code>, <code>has_cbv</code>, <code>has_mtt</code>, <code>has_tmax</code>, <code>has_ttp</code> - Perfusion maps</p> <p>SWI indicators: - <code>is_swi</code> - SWI sequence - <code>has_swi</code> - SWI processing</p> <p>MTw indicator: - <code>has_mtc</code> - Magnetization transfer contrast</p> <p>Synthetic MRI outputs: - <code>has_t1_synthetic</code> \u2192 T1w - <code>has_t2_synthetic</code> \u2192 T2w - <code>has_flair_synthetic</code> \u2192 T2w (FLAIR base) - <code>has_pd_synthetic</code> \u2192 PDw</p>"},{"location":"classification/base/#tier-3-keyword-matching","title":"Tier 3: Keyword Matching","text":"<p>Text search in series description for explicit contrast labels:</p> Keywords Base <code>t1w</code>, <code>t1 weighted</code>, <code>t1-w</code> T1w <code>t2w</code>, <code>t2 weighted</code>, <code>t2-w</code> T2w <code>pdw</code>, <code>proton density</code> PDw <code>t2*</code>, <code>t2star</code> T2*w <code>dwi</code>, <code>diffusion</code>, <code>dti</code> DWI <code>pwi</code>, <code>perfusion</code>, <code>dsc</code>, <code>dce</code> PWI <code>swi</code>, <code>swan</code>, <code>venobold</code> SWI <code>mtw</code>, <code>magnetization transfer</code> MTw"},{"location":"classification/base/#tier-4-physics-based-inference","title":"Tier 4: Physics-Based Inference","text":"<p>When other methods fail, use TR/TE/TI thresholds (validated against 400K+ fingerprints):</p>"},{"location":"classification/base/#spin-echo-se-family","title":"Spin Echo (SE) Family","text":"Contrast TR TE Notes T1w &lt; 1000ms &lt; 30ms Short TR/TE T2w &gt; 2000ms &gt; 50ms Long TR/TE PDw &gt; 2000ms &lt; 30ms Long TR, short TE"},{"location":"classification/base/#gradient-echo-gre-family","title":"Gradient Echo (GRE) Family","text":"Contrast TE Notes T1w &lt; 10ms Short TE T2*w &gt; 15ms Long TE for susceptibility"},{"location":"classification/base/#inversion-recovery-ir-family","title":"Inversion Recovery (IR) Family","text":"Contrast TI Notes T1w (standard IR) 300-1500ms Medium TI T2w (STIR-like) &lt; 300ms Short TI nulls fat"},{"location":"classification/base/#special-cases","title":"Special Cases","text":""},{"location":"classification/base/#flair-differentiation","title":"FLAIR Differentiation","text":"<p>FLAIR can be T1-FLAIR or T2-FLAIR, differentiated by TE:</p> Type TE Threshold Base Typical Use T1-FLAIR &lt; 40ms T1w Research T2-FLAIR \u2265 40ms T2w Clinical (most common) <p>Database validation shows: - 97% of series with \"t1\" keyword + FLAIR have TE &lt; 40ms - 99.9% of series with \"t2\" keyword + FLAIR have TE \u2265 80ms</p> <p>FLAIR Modifier</p> <p>The FLAIR modifier is detected on the Modifier axis separately. Here we only determine the underlying base contrast (T1w vs T2w).</p>"},{"location":"classification/base/#dual-echo-pdt2","title":"Dual-Echo PD+T2","text":"<p>Dual-echo sequences acquire both PD and T2 in a single acquisition. NILS splits these into separate stacks and uses TE to determine which echo:</p> Echo Type TE Base PD echo &lt; 40ms PDw T2 echo \u2265 40ms T2w <p>Detection triggers when BOTH \"pd\" and \"t2\" keywords appear in the series description.</p>"},{"location":"classification/base/#mp2rage-outputs","title":"MP2RAGE Outputs","text":"<p>MP2RAGE is fundamentally a T1-weighted technique. All outputs receive T1w base:</p> Output Flags Base INV1 <code>is_mp2rage_inv1</code> T1w INV2 <code>is_mp2rage_inv2</code> T1w UNI <code>has_uniform</code> T1w UNI-DEN <code>is_uniform_denoised</code> T1w T1 Map <code>has_t1_map</code> T1w"},{"location":"classification/base/#quantitative-maps","title":"Quantitative Maps","text":"<p>Relaxometry maps have an implied base from their measurement:</p> Map Base Rationale T1 Map, R1 T1w Measures T1 relaxation T2 Map, R2 T2w Measures T2 relaxation"},{"location":"classification/base/#primary-tissue-contrasts","title":"Primary Tissue Contrasts","text":""},{"location":"classification/base/#t1w-t1-weighted","title":"T1w (T1-Weighted)","text":"<p>Physics: Short TR (~500-800ms) allows incomplete T1 recovery, emphasizing T1 differences. Short TE (~10-20ms) minimizes T2 effects.</p> <p>Signal characteristics: - White matter: bright (short T1) - Gray matter: intermediate - CSF: dark (long T1) - Fat: bright</p> <p>Clinical applications: - Anatomy reference - Gadolinium enhancement - Post-contrast lesion detection</p>"},{"location":"classification/base/#t2w-t2-weighted","title":"T2w (T2-Weighted)","text":"<p>Physics: Long TR (&gt;2000ms) allows full T1 recovery, eliminating T1 contrast. Long TE (&gt;50ms) emphasizes T2 differences.</p> <p>Signal characteristics: - White matter: dark - Gray matter: intermediate - CSF: very bright (long T2) - Edema: bright</p> <p>Clinical applications: - Pathology detection - MS lesions - Tumor visualization - Infection/inflammation</p>"},{"location":"classification/base/#pdw-proton-density","title":"PDw (Proton Density)","text":"<p>Physics: Long TR (&gt;2000ms) removes T1 contrast. Short TE (&lt;30ms) minimizes T2 contrast. Signal primarily reflects hydrogen density.</p> <p>Signal characteristics: - Intermediate contrast - CSF: bright - Tissues differentiated by proton content</p> <p>Clinical applications: - Often paired with T2w (dual-echo) - Cartilage imaging - Research applications</p>"},{"location":"classification/base/#t2w-t2-star-weighted","title":"T2*w (T2-Star Weighted)","text":"<p>Physics: GRE sequence without 180\u00b0 refocusing pulse. Sensitive to microscopic field inhomogeneities (susceptibility effects).</p> <p>Signal characteristics: - Blood products: dark (paramagnetic) - Iron deposits: dark - Calcium: dark - Air-tissue interfaces: signal dropout</p> <p>Clinical applications: - Hemorrhage detection - Microbleed identification - Iron quantification - Basis for SWI and BOLD</p>"},{"location":"classification/base/#specialized-contrasts","title":"Specialized Contrasts","text":""},{"location":"classification/base/#dwi-diffusion-weighted","title":"DWI (Diffusion-Weighted)","text":"<p>Physics: Measures random motion of water molecules using diffusion gradients. Contrast depends on b-value.</p> <p>Signal characteristics: - Restricted diffusion: bright (acute stroke) - Free water: dark - High b-value \u2192 more diffusion weighting</p> <p>Derived maps: - ADC (Apparent Diffusion Coefficient) - FA (Fractional Anisotropy) - MD (Mean Diffusivity) - Trace</p>"},{"location":"classification/base/#pwi-perfusion-weighted","title":"PWI (Perfusion-Weighted)","text":"<p>Physics: Measures blood flow dynamics. Multiple methods: - DSC: Dynamic susceptibility contrast (T2-based) - DCE: Dynamic contrast-enhanced (T1-based) - ASL*: Arterial spin labeling (non-contrast)</p> <p>Outputs: - CBF (Cerebral Blood Flow) - CBV (Cerebral Blood Volume) - MTT (Mean Transit Time) - Tmax, TTP (time parameters)</p>"},{"location":"classification/base/#swi-susceptibility-weighted","title":"SWI (Susceptibility-Weighted)","text":"<p>Physics: Combines GRE magnitude and filtered phase images to enhance susceptibility contrast.</p> <p>Signal characteristics: - Paramagnetic substances: very dark - Veins: dark (deoxyhemoglobin) - Superior to T2* for small structures</p> <p>Applications: - Microbleed detection - Venous imaging - Iron quantification - QSM derivation</p>"},{"location":"classification/base/#mtw-magnetization-transfer","title":"MTw (Magnetization Transfer)","text":"<p>Physics: Off-resonance RF pulse saturates bound (macromolecular) protons. Saturation transfers to free water pool, reducing signal in tissues with bound protons.</p> <p>Signal characteristics: - Myelin-rich tissue: signal loss - Free water: minimal effect</p> <p>Applications: - MS lesion characterization - Myelin integrity assessment</p>"},{"location":"classification/base/#confidence-levels","title":"Confidence Levels","text":"<p>Detection confidence varies by method:</p> Method Confidence Rationale Technique inference 95% Physics-locked Exclusive flags 90% Definitive markers Keywords 85% Text-based FLAIR/Dual-echo TE 85% Physics threshold Physics ranges 70% Edge case fallback Unknown fallback 50% Could not determine"},{"location":"classification/base/#conflict-detection","title":"Conflict Detection","text":"<p>NILS checks for conflicts between detection method and text evidence:</p> <ul> <li>If physics predicts T1w but text contains \"t2w\" \u2192 conflict flagged</li> <li>Conflicts trigger manual review</li> <li>Authoritative methods (technique inference, exclusive flags) skip conflict check</li> </ul>"},{"location":"classification/base/#yaml-configuration","title":"YAML Configuration","text":"<p>Base detection is configured in <code>backend/src/classification/detection_yaml/base-detection.yaml</code>:</p> <pre><code>bases:\n  T1w:\n    name: \"T1w\"\n    description: \"T1-weighted; short TR/TE, white matter bright\"\n    keywords:\n      - \"t1w\"\n      - \"t1 weighted\"\n    physics:\n      se:\n        tr_max: 1000\n        te_max: 30\n      gre:\n        te_max: 10\n\ntechnique_inference:\n  MPRAGE: [\"T1w\", 0.95]\n  MP2RAGE: [\"T1w\", 0.95]\n  # ...\n\nrules:\n  allow_multiple: false  # Only one base per series\n  priority_order:\n    - \"DWI\"\n    - \"PWI\"\n    - \"SWI\"\n    # ... (specialized first, then primary)\n</code></pre>"},{"location":"classification/construct/","title":"Construct Axis","text":"<p>The Construct axis identifies computed/derived outputs from MRI acquisitions. It answers the question: \"What type of calculated map or derived image is this?\"</p>"},{"location":"classification/construct/#overview","title":"Overview","text":"<p>Constructs are computed outputs - not directly acquired, but calculated from raw acquisition data.</p> Category Constructs Source Diffusion ADC, eADC, FA, Trace, MD DWI/DTI Perfusion CBF, CBV, MTT, Tmax, TTP DSC/ASL Dixon Water, Fat, InPhase, OutPhase Dixon acquisition Quantitative T1map, T2map, R1map, R2map, PDmap Relaxometry MP2RAGE INV1, INV2, Uniform, Denoised MP2RAGE sequence Synthetic SyntheticT1w, SyntheticT2w, SyntheticFLAIR SyMRI/MAGiC SWI SWI, Phase, QSM SWI processing Projection MIP, MinIP, MPR Post-processing Field Maps B0map, B1map Calibration Components Magnitude, Real, Imaginary Complex data"},{"location":"classification/construct/#key-concepts","title":"Key Concepts","text":""},{"location":"classification/construct/#construct-vs-dicom-derived","title":"Construct vs DICOM DERIVED","text":"<p>These are not the same:</p> <ul> <li>DICOM DERIVED: Generic flag meaning \"pixels computed from other images\"</li> <li>Construct: The specific TYPE of computed output (ADC, FA, T1map, etc.)</li> </ul> <p>A DERIVED image could be an ADC map, an MPR reformat, or a subtraction image - the construct tells you which.</p>"},{"location":"classification/construct/#additive-logic","title":"Additive Logic","text":"<p>Like Modifiers, constructs are additive - multiple can apply:</p> <pre><code>DTI acquisition \u2192 construct_csv = \"ADC,FA\"\nMDME/SyMRI     \u2192 construct_csv = \"SyntheticT1w,T1map,T2map\"\n</code></pre>"},{"location":"classification/construct/#output-format","title":"Output Format","text":"<ul> <li>Comma-separated</li> <li>Alphabetically sorted</li> <li>Empty string for original acquisitions (no constructs)</li> </ul>"},{"location":"classification/construct/#detection-strategy","title":"Detection Strategy","text":"<p>Same three-tier approach:</p>"},{"location":"classification/construct/#tier-1-exclusive-flag-95-confidence","title":"Tier 1: Exclusive Flag (95% confidence)","text":"<pre><code>ADC:\n  detection:\n    exclusive: has_adc\n</code></pre>"},{"location":"classification/construct/#tier-2-keywords-match-85-confidence","title":"Tier 2: Keywords Match (85% confidence)","text":"<pre><code>ADC:\n  keywords:\n    - \"adc\"\n    - \"apparent diffusion coefficient\"\n</code></pre>"},{"location":"classification/construct/#tier-3-combination-75-confidence","title":"Tier 3: Combination (75% confidence)","text":"<pre><code>SWI:\n  detection:\n    combination:\n      - has_swi\n      - is_derived\n</code></pre>"},{"location":"classification/construct/#diffusion-constructs","title":"Diffusion Constructs","text":"<p>Derived from diffusion-weighted imaging (DWI/DTI/HARDI).</p>"},{"location":"classification/construct/#adc-apparent-diffusion-coefficient","title":"ADC (Apparent Diffusion Coefficient)","text":"<p>Units: mm\u00b2/s</p> <p>Detection: - Exclusive flag: <code>has_adc</code> - Keywords: <code>adc</code>, <code>apparent diffusion coefficient</code></p> <p>Computation: Fitted from multi-b-value DWI using: S(b) = S\u2080 \u00d7 exp(-b \u00d7 ADC)</p> <p>Clinical interpretation: - Low ADC = restricted diffusion (acute stroke, tumor cellularity) - High ADC = free water diffusion</p>"},{"location":"classification/construct/#eadc-exponential-adc","title":"eADC (Exponential ADC)","text":"<p>Formula: eADC = exp(-b \u00d7 ADC)</p> <p>Detection: - Exclusive flag: <code>has_eadc</code> - Keywords: <code>eadc</code>, <code>exponential adc</code></p> <p>Use: Some clinical applications prefer exponential form.</p>"},{"location":"classification/construct/#fa-fractional-anisotropy","title":"FA (Fractional Anisotropy)","text":"<p>Range: 0 (isotropic) to 1 (perfectly anisotropic)</p> <p>Detection: - Exclusive flag: <code>has_fa</code> - Keywords: <code>fractional anisotropy</code>, <code>fa map</code></p> <p>Clinical interpretation: - High FA in white matter tracts (organized fibers) - Low FA in gray matter, CSF - FA reduction indicates white matter damage</p>"},{"location":"classification/construct/#trace","title":"Trace","text":"<p>Description: Direction-independent diffusion-weighted image.</p> <p>Detection: - Exclusive flag: <code>has_trace</code> - Keywords: <code>trace</code>, <code>tracew</code>, <code>isodwi</code></p> <p>Computation: Combined DWI from multiple directions (geometric mean).</p>"},{"location":"classification/construct/#md-mean-diffusivity","title":"MD (Mean Diffusivity)","text":"<p>Description: Average diffusion in all directions.</p> <p>Detection: Keywords only: <code>mean diffusivity</code>, <code>md map</code></p> <p>Relationship: MD \u2248 ADC for isotropic diffusion.</p>"},{"location":"classification/construct/#perfusion-constructs","title":"Perfusion Constructs","text":"<p>Derived from DSC-MRI or ASL perfusion imaging.</p>"},{"location":"classification/construct/#cbf-cerebral-blood-flow","title":"CBF (Cerebral Blood Flow)","text":"<p>Units: ml/100g/min</p> <p>Detection: - Exclusive flag: <code>has_cbf</code> - Keywords: <code>cbf</code>, <code>cerebral blood flow</code></p> <p>Clinical use: Tissue perfusion assessment.</p>"},{"location":"classification/construct/#cbv-cerebral-blood-volume","title":"CBV (Cerebral Blood Volume)","text":"<p>Units: ml/100g</p> <p>Detection: - Exclusive flag: <code>has_cbv</code> - Keywords: <code>cbv</code>, <code>cerebral blood volume</code></p> <p>Clinical use: Vascular density, tumor grading.</p>"},{"location":"classification/construct/#mtt-mean-transit-time","title":"MTT (Mean Transit Time)","text":"<p>Units: seconds</p> <p>Detection: - Exclusive flag: <code>has_mtt</code> - Keywords: <code>mtt</code>, <code>mean transit time</code></p> <p>Relationship: MTT = CBV / CBF (central volume theorem).</p>"},{"location":"classification/construct/#tmax-time-to-maximum","title":"Tmax (Time to Maximum)","text":"<p>Description: Time to maximum of residue function.</p> <p>Detection: - Exclusive flag: <code>has_tmax</code> - Keywords: <code>tmax</code>, <code>time to max</code></p> <p>Clinical use: Stroke - penumbra identification (Tmax &gt; 6s threshold).</p>"},{"location":"classification/construct/#ttp-time-to-peak","title":"TTP (Time to Peak)","text":"<p>Description: Time to peak of contrast bolus.</p> <p>Detection: - Exclusive flag: <code>has_ttp</code> - Keywords: <code>ttp</code>, <code>time to peak</code></p>"},{"location":"classification/construct/#dixon-constructs","title":"Dixon Constructs","text":"<p>Fat-water separation outputs from Dixon acquisition.</p>"},{"location":"classification/construct/#water","title":"Water","text":"<p>Description: Water-only image (fat suppressed).</p> <p>Detection: - Exclusive flag: <code>has_water</code> - Keywords: <code>water only</code>, <code>dixon water</code></p> <p>Advantage: Better fat suppression near metal than spectral methods.</p>"},{"location":"classification/construct/#fat","title":"Fat","text":"<p>Description: Fat-only image (water suppressed).</p> <p>Detection: - Exclusive flag: <code>has_fat</code> - Keywords: <code>fat only</code>, <code>dixon fat</code></p> <p>Use: Fat quantification, lipid assessment.</p>"},{"location":"classification/construct/#inphase","title":"InPhase","text":"<p>Description: Echo where water and fat signals are in phase.</p> <p>Detection: - Exclusive flag: <code>has_in_phase</code> - Keywords: <code>in phase</code>, <code>inphase</code></p> <p>Note: Can be original acquisition, not necessarily derived.</p>"},{"location":"classification/construct/#outphase","title":"OutPhase","text":"<p>Description: Echo where water and fat signals are opposed.</p> <p>Detection: - Exclusive flag: <code>has_out_phase</code> - Keywords: <code>opposed phase</code>, <code>out of phase</code></p> <p>Use: Signal cancellation at fat-water interfaces reveals fat content.</p>"},{"location":"classification/construct/#quantitative-map-constructs","title":"Quantitative Map Constructs","text":"<p>Relaxometry and parameter maps.</p>"},{"location":"classification/construct/#t1map","title":"T1map","text":"<p>Units: milliseconds</p> <p>Detection: - Exclusive flag: <code>has_t1_map</code> - Keywords: <code>t1 map</code>, <code>t1 relaxation</code> - Combination: <code>is_qmap</code></p> <p>Acquisition methods: VFA-GRE, IR sequences, MP2RAGE.</p>"},{"location":"classification/construct/#t2map","title":"T2map","text":"<p>Units: milliseconds</p> <p>Detection: - Exclusive flag: <code>has_t2_map</code> - Keywords: <code>t2 map</code>, <code>t2 relaxation</code></p> <p>Acquisition method: Multi-echo SE.</p>"},{"location":"classification/construct/#r1map-r2map","title":"R1map / R2map","text":"<p>Description: Relaxation rate maps (1/T1 and 1/T2).</p> <p>Detection: - Exclusive flags: <code>has_r1</code>, <code>has_r2</code> - Keywords: <code>r1 map</code>, <code>r2 map</code></p>"},{"location":"classification/construct/#pdmap","title":"PDmap","text":"<p>Description: Quantitative proton density map.</p> <p>Detection: Keywords: <code>pd map</code>, <code>proton density map</code></p>"},{"location":"classification/construct/#mp2rage-constructs","title":"MP2RAGE Constructs","text":"<p>Outputs from MP2RAGE acquisition. All are fundamentally T1-weighted.</p>"},{"location":"classification/construct/#inv1-first-inversion","title":"INV1 (First Inversion)","text":"<p>TI: ~700-1000ms (short)</p> <p>Detection: - Exclusive flag: <code>is_mp2rage_inv1</code> - Keywords: <code>inv1</code>, <code>inv 1</code></p> <p>Characteristics: - Strong T1 weighting - Lower SNR than INV2 - Not derived (original acquisition)</p>"},{"location":"classification/construct/#inv2-second-inversion","title":"INV2 (Second Inversion)","text":"<p>TI: ~2500-3200ms (long)</p> <p>Detection: - Exclusive flag: <code>is_mp2rage_inv2</code> - Keywords: <code>inv2</code>, <code>inv 2</code></p> <p>Characteristics: - Higher SNR - Weaker T1 contrast - Not derived (original acquisition)</p>"},{"location":"classification/construct/#uniform","title":"Uniform","text":"<p>Description: Bias-corrected T1w image.</p> <p>Detection: - Exclusive flag: <code>has_uniform</code> - Keywords: <code>uni image</code>, <code>uniform image</code></p> <p>Computation: <pre><code>S_UNI = Re(INV1* \u00b7 INV2) / (|INV1|\u00b2 + |INV2|\u00b2)\n</code></pre></p> <p>Caveat: Has \"salt-and-pepper\" noise in background (division of small numbers in air).</p>"},{"location":"classification/construct/#denoised-uniformdenoised","title":"Denoised (UniformDenoised)","text":"<p>Description: Bias-corrected with clean background.</p> <p>Detection: - Exclusive flag: <code>is_uniform_denoised</code> - Keywords: <code>uni-den</code>, <code>uniform denoised</code></p> <p>Computation: <pre><code>S_UNI-DEN = Re(INV1* \u00b7 INV2) / (|INV1|\u00b2 + |INV2|\u00b2 + \u03b2)\n</code></pre></p> <p>The regularization term \u03b2 suppresses background noise.</p> <p>Use: Primary input for segmentation (FreeSurfer, FSL, SPM) - has clean dark background.</p>"},{"location":"classification/construct/#synthetic-mri-constructs","title":"Synthetic MRI Constructs","text":"<p>Generated from quantitative maps (SyMRI/MAGiC).</p>"},{"location":"classification/construct/#synthetict1w","title":"SyntheticT1w","text":"<p>Detection: - Exclusive flag: <code>has_t1_synthetic</code> - Keywords: <code>synthetic t1</code></p> <p>Source: Computed from T1, T2, PD maps using Bloch equations.</p>"},{"location":"classification/construct/#synthetict2w","title":"SyntheticT2w","text":"<p>Detection: - Exclusive flag: <code>has_t2_synthetic</code> - Keywords: <code>synthetic t2</code></p>"},{"location":"classification/construct/#syntheticflair","title":"SyntheticFLAIR","text":"<p>Detection: - Exclusive flag: <code>has_flair_synthetic</code> - Keywords: <code>synthetic flair</code></p> <p>Advantage: FLAIR contrast without additional scan time.</p>"},{"location":"classification/construct/#syntheticpdw","title":"SyntheticPDw","text":"<p>Detection: - Exclusive flag: <code>has_pd_synthetic</code> - Keywords: <code>synthetic pd</code></p>"},{"location":"classification/construct/#myelinmap","title":"MyelinMap","text":"<p>Description: Myelin content / myelin water fraction.</p> <p>Detection: - Exclusive flag: <code>has_myelin</code> - Keywords: <code>myelin map</code>, <code>mwf</code></p> <p>Use: White matter integrity assessment, MS research.</p>"},{"location":"classification/construct/#swi-constructs","title":"SWI Constructs","text":"<p>Susceptibility-weighted imaging outputs.</p>"},{"location":"classification/construct/#swi-processed","title":"SWI (Processed)","text":"<p>Description: Magnitude \u00d7 phase mask^n for maximum susceptibility sensitivity.</p> <p>Detection: - Keywords: <code>swi processed</code>, <code>swi combined</code> - Combination: <code>has_swi</code> + <code>is_derived</code></p> <p>Note: SWI branch (<code>branches/swi.py</code>) handles this directly for SWI provenance.</p>"},{"location":"classification/construct/#phase","title":"Phase","text":"<p>Description: Phase image (wrapped or unwrapped).</p> <p>Detection: - Exclusive flag: <code>has_phase</code> - Keywords: <code>phase</code>, <code>phase map</code></p> <p>Use: - QSM derivation - Iron vs calcium differentiation - Phase-contrast flow</p> <p>Note: Can be original acquisition, not necessarily derived.</p>"},{"location":"classification/construct/#qsm-quantitative-susceptibility-mapping","title":"QSM (Quantitative Susceptibility Mapping)","text":"<p>Units: ppm (parts per million)</p> <p>Detection: Keywords: <code>qsm</code>, <code>susceptibility map</code>, <code>chi map</code></p> <p>Computation: Derived from phase via dipole inversion.</p> <p>Clinical use: Iron quantification, calcification detection.</p>"},{"location":"classification/construct/#projection-constructs","title":"Projection Constructs","text":"<p>Post-processing reformats.</p>"},{"location":"classification/construct/#mip-maximum-intensity-projection","title":"MIP (Maximum Intensity Projection)","text":"<p>Detection: - Exclusive flag: <code>is_mip</code> - Keywords: <code>mip</code>, <code>maximum intensity projection</code></p> <p>Use: Angiography visualization, vessel overview.</p>"},{"location":"classification/construct/#minip-minimum-intensity-projection","title":"MinIP (Minimum Intensity Projection)","text":"<p>Detection: - Exclusive flag: <code>is_minip</code> - Keywords: <code>minip</code>, <code>minimum intensity projection</code></p> <p>Use: Airway visualization, SWI vein display.</p>"},{"location":"classification/construct/#mpr-multiplanar-reformation","title":"MPR (Multiplanar Reformation)","text":"<p>Detection: - Exclusive flag: <code>is_mpr</code> - Keywords: <code>multiplanar reformat</code>, <code>reformatted</code></p> <p>Note: Keyword \"mpr\" excluded to avoid false matches with \"mprage\".</p>"},{"location":"classification/construct/#field-map-constructs","title":"Field Map Constructs","text":"<p>Calibration maps.</p>"},{"location":"classification/construct/#b0map","title":"B0map","text":"<p>Description: Static field off-resonance map.</p> <p>Detection: Keywords: <code>b0 map</code>, <code>field map</code>, <code>fieldmap</code></p> <p>Use: Distortion correction, shimming.</p>"},{"location":"classification/construct/#b1map","title":"B1map","text":"<p>Description: RF transmit/receive field map.</p> <p>Detection: Keywords: <code>b1 map</code>, <code>b1+</code>, <code>b1-</code></p> <p>Use: RF inhomogeneity correction.</p>"},{"location":"classification/construct/#component-constructs","title":"Component Constructs","text":"<p>Complex data components.</p>"},{"location":"classification/construct/#magnitude","title":"Magnitude","text":"<p>Description: Magnitude from complex data.</p> <p>Detection: Keywords only: <code>magnitude image</code>, <code>magnitude only</code></p> <p>Note: <code>has_magnitude</code> flag not used for detection - most images are magnitude.</p>"},{"location":"classification/construct/#real","title":"Real","text":"<p>Detection: - Exclusive flag: <code>has_real</code> - Keywords: <code>real image</code>, <code>real component</code></p>"},{"location":"classification/construct/#imaginary","title":"Imaginary","text":"<p>Detection: - Exclusive flag: <code>has_imaginary</code> - Keywords: <code>imaginary image</code>, <code>imaginary component</code></p>"},{"location":"classification/construct/#original-vs-derived","title":"Original vs Derived","text":"<p>Most constructs require <code>is_derived=True</code> in DICOM ImageType:</p> Requires Derived Construct Examples Yes ADC, FA, CBF, T1map, SyntheticT1w, MIP No INV1, INV2, InPhase, OutPhase, Phase, Magnitude <p>Some outputs (like MP2RAGE inversions, Dixon echoes, phase images) are original acquisitions, not derived.</p>"},{"location":"classification/construct/#common-output-examples","title":"Common Output Examples","text":"Acquisition construct_csv Standard T1w MPRAGE <code>\"\"</code> (empty - no constructs) DTI with maps <code>\"ADC,FA\"</code> DSC perfusion <code>\"CBF,CBV,MTT\"</code> Dixon <code>\"Fat,Water\"</code> SyMRI/MAGiC <code>\"SyntheticFLAIR,SyntheticT1w,T1map,T2map\"</code> MP2RAGE <code>\"Denoised,T1map\"</code> or <code>\"INV1\"</code> TOF-MRA MIP <code>\"MIP\"</code> SWI <code>\"Phase,SWI\"</code>"},{"location":"classification/construct/#confidence-levels","title":"Confidence Levels","text":"Detection Method Confidence Exclusive flag 95% Keywords match 85% Combination (AND) 75%"},{"location":"classification/construct/#yaml-configuration","title":"YAML Configuration","text":"<p>Constructs are configured in <code>backend/src/classification/detection_yaml/construct-detection.yaml</code>:</p> <pre><code>constructs:\n  ADC:\n    name: \"ADC\"\n    category: \"diffusion\"\n    description: \"Apparent Diffusion Coefficient map\"\n    keywords:\n      - \"adc\"\n      - \"apparent diffusion coefficient\"\n    detection:\n      exclusive: has_adc\n    requires_derived: true\n\n  INV1:\n    name: \"INV1\"\n    category: \"mp2rage\"\n    detection:\n      exclusive: is_mp2rage_inv1\n    requires_derived: false  # Original acquisition\n\nrules:\n  allow_multiple: true\n  priority_order:\n    - \"ADC\"\n    - \"FA\"\n    # ... more specific first\n</code></pre>"},{"location":"classification/construct/#convenience-methods","title":"Convenience Methods","text":"<p>The detector provides helper methods:</p> <pre><code># Get all constructs by category\ndetector.get_constructs_by_category(\"diffusion\")  # [\"ADC\", \"FA\", \"MD\", \"Trace\", \"eADC\"]\n\n# Get all categories\ndetector.get_categories()  # [\"component\", \"diffusion\", \"dixon\", \"mp2rage\", ...]\n\n# Check if specific construct detected\noutput.has(\"ADC\")  # True/False\n\n# Get constructs by category from output\noutput.by_category(\"perfusion\")  # List of ConstructMatch objects\n</code></pre>"},{"location":"classification/foundations/","title":"Detection Infrastructure","text":"<p>Before understanding the six classification axes, it's essential to understand how NILS detects MRI features. This page describes the foundational detection infrastructure that powers all axis classifiers.</p>"},{"location":"classification/foundations/#overview","title":"Overview","text":"<p>NILS classification is built on a layered detection system:</p> <pre><code>flowchart TB\n    subgraph input[\"DICOM Files (Input)\"]\n        dicom[\"Raw DICOM data\"]\n    end\n\n    subgraph fingerprint[\"Stack Fingerprint Extraction\"]\n        f1[\"ImageType, ScanningSequence, SequenceVariant, ScanOptions\"]\n        f2[\"SeriesDescription, ProtocolName \u2192 text_search_blob\"]\n        f3[\"ContrastBolusAgent \u2192 contrast_search_blob\"]\n        f4[\"Physics: TR, TE, TI, Flip Angle, b-value\"]\n    end\n\n    subgraph context[\"ClassificationContext\"]\n        c1[\"5 DICOM tag parsers (tokenization + flags)\"]\n        c2[\"107 unified flags (vendor-agnostic detection)\"]\n        c3[\"Semantic token normalization\"]\n    end\n\n    subgraph detectors[\"Axis Detectors (6 total)\"]\n        d1[\"Use unified flags, text search, DICOM structures\"]\n        d2[\"Each axis outputs: value, confidence, evidence\"]\n    end\n\n    input --&gt; fingerprint\n    fingerprint --&gt; context\n    context --&gt; detectors</code></pre>"},{"location":"classification/foundations/#stack-fingerprints","title":"Stack Fingerprints","text":"<p>A stack fingerprint is the extracted feature vector for a series, containing all the raw information needed for classification.</p>"},{"location":"classification/foundations/#key-fingerprint-fields","title":"Key Fingerprint Fields","text":"Field Source Purpose <code>image_type</code> (0008,0008) Core image classification tokens <code>scanning_sequence</code> (0018,0020) Pulse sequence physics (SE, GR, IR, EP) <code>sequence_variant</code> (0018,0021) Sequence modifiers (SP, SS, SK, MP) <code>scan_options</code> (0018,0022) Acquisition options (FS, IR, PF, ACC) <code>stack_sequence_name</code> (0018,0024) Vendor-specific sequence name <code>text_search_blob</code> SeriesDescription + ProtocolName Normalized searchable text <code>contrast_search_blob</code> ContrastBolusAgent fields Contrast agent information <code>manufacturer</code> (0008,0070) Scanner vendor <code>mr_tr</code> (0018,0080) Repetition time (ms) <code>mr_te</code> (0018,0081) Echo time (ms) <code>mr_ti</code> (0018,0082) Inversion time (ms) <code>mr_flip_angle</code> (0018,1314) Flip angle (degrees) <code>mr_diffusion_b_value</code> (0018,9087) Diffusion b-value (s/mm\u00b2)"},{"location":"classification/foundations/#stack-keys","title":"Stack Keys","text":"<p>When a series contains multiple contrasts (e.g., multi-echo), NILS splits it into multiple \"stacks\":</p> Stack Key Description Example <code>multi_echo</code> Split by echo time Dual-echo, ME-GRE <code>multi_ti</code> Split by inversion time MP2RAGE (INV1, INV2) <code>multi_flip_angle</code> Split by flip angle VFA T1 mapping"},{"location":"classification/foundations/#dicom-tag-parsers","title":"DICOM Tag Parsers","text":"<p>NILS uses five specialized parsers to extract boolean flags from DICOM tags. Each parser tokenizes and normalizes its input, producing consistent flags regardless of vendor format.</p>"},{"location":"classification/foundations/#1-imagetype-parser","title":"1. ImageType Parser","text":"<p>Parses <code>ImageType</code> (0008,0008) into 100+ boolean flags.</p> <p>Input: <code>\"ORIGINAL\\\\PRIMARY\\\\M\\\\NORM\\\\DIS2D\"</code></p> <p>Output (examples): <pre><code>{\n    \"is_original\": True,\n    \"is_derived\": False,\n    \"is_primary\": True,\n    \"has_magnitude\": True,   # M token\n    \"is_normalized\": True,   # NORM token\n    \"is_2d_view\": True,      # DIS2D token\n    \"has_adc\": False,\n    \"has_swi\": False,\n    ...\n}\n</code></pre></p> <p>Token Categories:</p> Category Example Flags Core <code>is_original</code>, <code>is_derived</code>, <code>is_primary</code>, <code>is_secondary</code> Diffusion <code>has_diffusion</code>, <code>has_adc</code>, <code>has_fa</code>, <code>has_trace</code> Perfusion <code>has_perfusion</code>, <code>has_cbf</code>, <code>has_cbv</code>, <code>has_mtt</code> Quantitative <code>has_qmap</code>, <code>has_t1_map</code>, <code>has_t2_map</code> Dixon <code>has_dixon</code>, <code>has_water</code>, <code>has_fat</code>, <code>has_in_phase</code> Components <code>has_magnitude</code>, <code>has_phase</code>, <code>has_real</code>, <code>has_imaginary</code> Processing <code>is_mip</code>, <code>is_mpr</code>, <code>is_subtraction</code>, <code>is_normalized</code> Synthetic <code>is_synthetic</code>, <code>has_t1_synthetic</code>, <code>has_t2_synthetic</code>"},{"location":"classification/foundations/#2-scanningsequence-parser","title":"2. ScanningSequence Parser","text":"<p>Parses <code>ScanningSequence</code> (0018,0020) for pulse sequence physics.</p> <p>Input: <code>\"['SE', 'IR']\"</code> or <code>\"SE\\\\IR\"</code></p> <p>Output: <pre><code>{\n    \"has_se\": True,    # Spin Echo\n    \"has_gre\": False,  # Gradient Echo (GR, GE, FE)\n    \"has_ir\": True,    # Inversion Recovery\n    \"has_epi\": False,  # Echo Planar (EP)\n    \"has_fse\": False,  # Fast Spin Echo\n    ...\n}\n</code></pre></p>"},{"location":"classification/foundations/#3-sequencevariant-parser","title":"3. SequenceVariant Parser","text":"<p>Parses <code>SequenceVariant</code> (0018,0021) for sequence modifiers.</p> <p>Input: <code>\"SK\\\\SP\\\\MP\"</code></p> <p>Output: <pre><code>{\n    \"has_segmented_kspace\": True,  # SK - Echo train (TSE)\n    \"has_spoiled\": True,           # SP - RF/gradient spoiling\n    \"has_mag_prepared\": True,      # MP - Magnetization prepared\n    \"has_steady_state\": False,     # SS - Steady state\n    \"has_mtc\": False,              # MTC - Magnetization transfer\n    ...\n}\n</code></pre></p>"},{"location":"classification/foundations/#4-scanoptions-parser","title":"4. ScanOptions Parser","text":"<p>Parses <code>ScanOptions</code> (0018,0022) for acquisition options.</p> <p>Input: <code>\"ACC_GEMS\\\\PFP\\\\FS\"</code></p> <p>Output: <pre><code>{\n    \"has_parallel_gems\": True,       # GE parallel imaging\n    \"has_partial_fourier_phase\": True,  # Partial Fourier\n    \"has_fat_sat\": True,             # Fat saturation\n    \"has_flow_comp\": False,          # Flow compensation\n    \"has_ir\": False,                 # IR option\n    ...\n}\n</code></pre></p> <p>Vendor-Specific Options:</p> Vendor Options GE <code>ACC_GEMS</code>, <code>HYPERSENSE_GEMS</code>, <code>CS_GEMS</code>, <code>IDEAL_GEMS</code>, <code>MRF_GEMS</code> Standard <code>FS</code>, <code>FC</code>, <code>IR</code>, <code>MT</code>, <code>PFP</code>, <code>PFF</code>, <code>WE</code>"},{"location":"classification/foundations/#5-sequencename-parser","title":"5. SequenceName Parser","text":"<p>Parses <code>SequenceName</code> (0018,0024) using pattern matching.</p> <p>Input: <code>\"*tfl3d1_16\"</code> (Siemens MPRAGE)</p> <p>Output: <pre><code>{\n    \"is_tfl\": True,      # TurboFLASH\n    \"is_mprage\": True,   # MPRAGE pattern\n    \"is_tse\": False,\n    \"is_epi_diff\": False,\n    \"is_swi\": False,\n    ...\n}\n</code></pre></p> <p>Pattern Categories:</p> Category Patterns Detects Diffusion/EPI <code>ep_b*</code>, <code>re_b*</code>, <code>blade_b*</code> DWI, RESOLVE TSE <code>tse*</code>, <code>ts1</code>, <code>ts2</code>, <code>h2d*</code> TSE, HASTE GRE <code>fl*</code>, <code>tfl*</code>, <code>fgre*</code> FLASH, TurboFLASH 3D-TSE <code>spc*</code>, <code>spcir*</code> SPACE SWI <code>swi*</code>, <code>qswi*</code> SWI Quantitative <code>mdme*</code>, <code>qalas*</code> SyMRI source"},{"location":"classification/foundations/#unified-flags","title":"Unified Flags","text":"<p>The 107 unified flags aggregate evidence from all five parsers using OR logic, providing vendor-agnostic detection.</p>"},{"location":"classification/foundations/#flag-categories","title":"Flag Categories","text":""},{"location":"classification/foundations/#1-pulse-sequence-physics-6-flags","title":"1. Pulse Sequence Physics (6 flags)","text":"Flag Description Aggregates From <code>has_se</code> Spin Echo physics ScanningSequence, ImageType, SequenceName <code>has_gre</code> Gradient Echo physics ScanningSequence, ImageType, SequenceName <code>has_epi</code> Echo Planar readout ScanningSequence, SequenceName <code>has_ir</code> Inversion Recovery (any) ScanningSequence, ScanOptions, SequenceName <code>has_ir_se</code> SE-based IR only (not MPRAGE) For modifier detection <code>has_saturation</code> Saturation pulse ScanningSequence, ScanOptions"},{"location":"classification/foundations/#2-technique-indicators-27-flags","title":"2. Technique Indicators (27 flags)","text":"Flag Description Examples <code>is_tse</code> Turbo/Fast Spin Echo TSE, FSE <code>is_space</code> 3D TSE with variable flip SPACE, CUBE, VISTA <code>is_haste</code> Single-shot TSE HASTE, SSFSE <code>is_flash</code> Spoiled GRE FLASH, SPGR <code>is_mprage</code> IR-prepared 3D GRE MPRAGE, BRAVO <code>is_swi</code> Susceptibility-weighted SWI <code>is_tof</code> Time-of-flight MRA TOF <code>is_dwi</code> Diffusion-weighted DWI, DTI <code>is_bold</code> BOLD fMRI fMRI <code>is_asl</code> Arterial spin labeling ASL <code>is_mdme</code> SyMRI source (MDME) Multi-dynamic multi-echo <code>is_qalas</code> Quantitative QALAS 3D-QALAS"},{"location":"classification/foundations/#3-sequence-modifiers-12-flags","title":"3. Sequence Modifiers (12 flags)","text":"Flag Description <code>has_spoiled</code> RF/gradient spoiling <code>has_steady_state</code> Steady-state acquisition <code>has_segmented_kspace</code> Echo train (TSE) <code>has_mag_prepared</code> Magnetization preparation <code>has_fat_sat</code> Fat saturation <code>has_water_excitation</code> Water-only excitation <code>has_flow_comp</code> Flow compensation <code>has_partial_fourier</code> Partial Fourier <code>has_parallel_imaging</code> GRAPPA/SENSE/ARC <code>has_gating</code> Cardiac/respiratory gating"},{"location":"classification/foundations/#4-acquisition-properties-5-flags","title":"4. Acquisition Properties (5 flags)","text":"Flag Description Source <code>is_3d</code> 3D volumetric MRAcquisitionType, ImageType <code>is_2d</code> 2D multi-slice MRAcquisitionType, ImageType <code>is_multi_echo</code> Split by TE stack_key <code>is_multi_ti</code> Split by TI stack_key <code>is_multi_fa</code> Split by flip angle stack_key"},{"location":"classification/foundations/#5-derivedsynthetic-14-flags","title":"5. Derived/Synthetic (14 flags)","text":"Flag Description <code>is_derived</code> Not original acquisition <code>is_synthetic</code> Synthetic MRI output <code>is_qmap</code> Any quantitative map <code>has_t1_map</code>, <code>has_t2_map</code> Relaxometry maps <code>has_adc</code>, <code>has_fa</code>, <code>has_trace</code> Diffusion maps <code>has_cbf</code>, <code>has_cbv</code>, <code>has_mtt</code> Perfusion maps <code>has_t1_synthetic</code>, <code>has_t2_synthetic</code> Synthetic contrasts"},{"location":"classification/foundations/#6-image-typecomponent-15-flags","title":"6. Image Type/Component (15 flags)","text":"Flag Description <code>is_original</code>, <code>is_primary</code>, <code>is_secondary</code> Core image type <code>is_localizer</code> Localizer/scout <code>has_magnitude</code>, <code>has_phase</code> Complex components <code>has_dixon</code>, <code>has_water</code>, <code>has_fat</code> Dixon outputs <code>has_psir</code>, <code>has_stir</code> IR reconstructions"},{"location":"classification/foundations/#7-post-processing-10-flags","title":"7. Post-Processing (10 flags)","text":"Flag Description <code>is_mip</code>, <code>is_minip</code> Intensity projections <code>is_mpr</code> Multiplanar reconstruction <code>is_subtraction</code> Subtraction image <code>has_moco</code> Motion correction <code>is_normalized</code> Intensity normalization"},{"location":"classification/foundations/#8-exclusionqa-5-flags","title":"8. Exclusion/QA (5 flags)","text":"Flag Description <code>is_error</code> Error image <code>is_screenshot</code> Screenshot/pasted <code>is_qa</code> QA/QC image <code>is_tune</code> Calibration scan <code>is_wip</code> Work-in-progress"},{"location":"classification/foundations/#text-search-blob","title":"Text Search Blob","text":"<p>The <code>text_search_blob</code> combines and normalizes text from <code>SeriesDescription</code> and <code>ProtocolName</code> for keyword matching.</p>"},{"location":"classification/foundations/#normalization-pipeline","title":"Normalization Pipeline","text":"<pre><code>flowchart TB\n    A[\"Raw Input: 'T2 TSE FLAIR tra FS 3mm'\"] --&gt; B\n    B[\"1. Raw Removals: Remove vendor phrases\"] --&gt; C\n    C[\"2. Character Replacements&lt;br/&gt;\u2022 '*' \u2192 'star' (T2* \u2192 T2star)&lt;br/&gt;\u2022 '/' '\\' '(' ')' \u2192 space\"] --&gt; D\n    D[\"3. Lowercase\"] --&gt; E\n    E[\"4. Tokenize (split by space/underscore)\"] --&gt; F\n    F[\"5. Deduplicate\"] --&gt; G\n    G[\"6. Token Replacements&lt;br/&gt;\u2022 'ir' \u2192 'inversion-recovery'&lt;br/&gt;\u2022 'pd' \u2192 'proton-density'&lt;br/&gt;\u2022 'se' \u2192 'spin-echo'&lt;br/&gt;\u2022 't1' \u2192 't1w', 't2' \u2192 't2w'\"] --&gt; H\n    H[\"7. Conditional Replacements&lt;br/&gt;\u2022 'mpr' \u2192 'mprage' if 3d + t1\"] --&gt; I\n    I[\"Normalized: 't2w tse flair tra fatsat 3mm'\"]</code></pre>"},{"location":"classification/foundations/#token-replacement-rules","title":"Token Replacement Rules","text":"Canonical Form Replaced Tokens Purpose <code>inversion-recovery</code> ir Avoid \"ir\" substring matches <code>proton-density</code> pd, pdw Avoid \"pd\" substring matches <code>spin-echo</code> se Avoid \"se\" in \"sense\", \"rise\" <code>gradient-echo</code> gre Avoid \"gre\" in \"agree\" <code>t1w</code> t1 Standardize contrast names <code>t2w</code> t2 Standardize contrast names <code>localizer</code> loc, scout, surv Normalize localizer terms <code>phase</code> pha Expand abbreviation <code>magnitude</code> mag Expand abbreviation"},{"location":"classification/foundations/#preserved-keywords","title":"Preserved Keywords","text":"<p>These keywords are NOT replaced (they're meaningful in detection YAMLs):</p> <ul> <li>IR Modifiers: flair, stir, tirm, dir, psir</li> <li>Fat Suppression: fatsat, spair, chemsat</li> <li>Dixon: dixon, ideal, mdixon</li> <li>Trajectories: propeller, blade, radial, spiral</li> <li>Techniques: tse, fse, haste, space, mprage, dwi, swi, bold</li> <li>Constructs: adc, fa, cbf, cbv, mip, minip, qsm</li> </ul>"},{"location":"classification/foundations/#contrast-search-blob","title":"Contrast Search Blob","text":"<p>The <code>contrast_search_blob</code> contains normalized contrast agent information for post-contrast detection.</p> <p>Sources: - ContrastBolusAgent (0018,0010) - ContrastBolusRoute (0018,1040) - ContrastBolusVolume (0018,1041)</p>"},{"location":"classification/foundations/#evidence-system","title":"Evidence System","text":"<p>Detection decisions are tracked with evidence to provide confidence scores and audit trails.</p>"},{"location":"classification/foundations/#evidence-sources-by-confidence","title":"Evidence Sources (by confidence)","text":"Source Confidence Description <code>HIGH_VALUE_TOKEN</code> 95% Unified flag from DICOM tag parsing <code>DICOM_STRUCTURED</code> 95% Structured DICOM field (contrast blob) <code>TECHNIQUE_INFERENCE</code> 90% Base inferred from technique <code>MODIFIER_INFERENCE</code> 80% Base inferred from modifier + physics <code>TEXT_SEARCH</code> 75% Keyword match in text_search_blob <code>PHYSICS_DISTINCT</code> 70% Physics in non-overlapping range <code>PHYSICS_OVERLAP</code> 50% Physics in ambiguous range <code>GEOMETRY_HINT</code> 40% FOV/aspect ratio heuristic"},{"location":"classification/foundations/#detection-priority","title":"Detection Priority","text":"<p>When a detector has multiple evidence sources, it uses this priority:</p> <ol> <li>Unified flags (95%) - Pre-computed, vendor-agnostic</li> <li>Alternative flags (85-90%) - OR logic match</li> <li>DICOM structured (95%) - Specific DICOM tags</li> <li>Keywords (75-85%) - Text pattern matching</li> <li>Combination (75%) - AND logic of multiple conditions</li> <li>Fallback (50%) - Default/heuristic</li> </ol>"},{"location":"classification/foundations/#confidence-calculation","title":"Confidence Calculation","text":"<pre><code># Use max evidence weight, boost for multiple agreeing sources\nmax_weight = max(e.weight for e in evidence)\n\n# +5% per additional unique source type\nif len(source_types) &gt;= 2:\n    max_weight = min(max_weight + 0.05 * (len(source_types) - 1), 0.99)\n</code></pre>"},{"location":"classification/foundations/#classification-context","title":"Classification Context","text":"<p>The <code>ClassificationContext</code> dataclass encapsulates all fingerprint data with lazy-parsed flags.</p>"},{"location":"classification/foundations/#usage-example","title":"Usage Example","text":"<pre><code>from classification.core.context import ClassificationContext\n\n# Create from fingerprint\nctx = ClassificationContext.from_fingerprint(fingerprint_dict)\n\n# Access unified flags (vendor-agnostic)\nuf = ctx.unified_flags\n\nif uf[\"has_se\"] and uf[\"has_ir\"]:\n    if uf[\"is_tse\"]:\n        technique = \"IR-TSE\"\n    elif uf[\"is_space\"]:\n        technique = \"3D-IR-TSE\"\n\n# Access parsed DICOM tags (lower level)\nif ctx.parsed_image_type[\"has_adc\"]:\n    construct = \"ADC\"\n\n# Check text search blob\nif \"flair\" in ctx.text_search_blob.lower():\n    modifier = \"FLAIR\"\n\n# Get vendor\nif ctx.vendor == \"SIEMENS\":\n    # Siemens-specific logic\n    pass\n</code></pre>"},{"location":"classification/foundations/#key-properties","title":"Key Properties","text":"Property Type Description <code>parsed_image_type</code> Dict 100+ flags from ImageType parsing <code>parsed_scanning_sequence</code> Dict Flags from ScanningSequence <code>parsed_sequence_variant</code> Dict Flags from SequenceVariant <code>parsed_scan_options</code> Dict Flags from ScanOptions <code>parsed_sequence_name</code> Dict Flags from SequenceName patterns <code>unified_flags</code> Dict 107 aggregated vendor-agnostic flags <code>vendor</code> str Normalized vendor (SIEMENS, GE, PHILIPS, OTHER)"},{"location":"classification/foundations/#helper-methods","title":"Helper Methods","text":"<pre><code># Check for exclusion (screenshot, secondary, error)\nif ctx.should_exclude():\n    return create_excluded_result()\n\n# Check for diffusion constructs\nif ctx.has_any_diffusion_construct():\n    branch = \"dti_derived\"\n\n# Check for synthetic MRI\nif ctx.has_any_synthetic():\n    branch = \"symri\"\n</code></pre>"},{"location":"classification/foundations/#detection-flow","title":"Detection Flow","text":""},{"location":"classification/foundations/#three-tier-detection-pattern","title":"Three-Tier Detection Pattern","text":"<p>Most detectors use a three-tier approach:</p> <pre><code>flowchart TB\n    subgraph tier1[\"Tier 1: Exclusive Flag (95% confidence)\"]\n        t1a[\"Single unified flag definitively identifies the value\"]\n        t1b[\"Example: is_swi \u2192 provenance = SWIRecon\"]\n    end\n\n    subgraph tier2[\"Tier 2: Alternative Flags / Keywords (75-90%)\"]\n        t2a[\"Any matching condition triggers detection\"]\n        t2b[\"Example: has_t1_synthetic OR has_t2_synthetic \u2192 SyMRI\"]\n    end\n\n    subgraph tier3[\"Tier 3: Combination / Fallback (50-75%)\"]\n        t3a[\"Multiple conditions must match (AND logic)\"]\n        t3b[\"Example: is_derived AND is_synthetic \u2192 SyMRI\"]\n    end\n\n    tier1 --&gt; tier2 --&gt; tier3</code></pre>"},{"location":"classification/foundations/#detector-interface","title":"Detector Interface","text":"<p>All axis detectors follow this pattern:</p> <pre><code>class AxisDetector:\n    def detect(self, ctx: ClassificationContext) -&gt; AxisResult:\n        \"\"\"\n        Returns:\n            AxisResult with:\n                - value: The classification value\n                - confidence: 0.0 - 1.0\n                - evidence: List of Evidence objects\n                - alternatives: Other candidates considered\n        \"\"\"\n        pass\n</code></pre>"},{"location":"classification/foundations/#yaml-configuration","title":"YAML Configuration","text":"<p>Detection rules are configured in YAML files, making classification extensible without code changes.</p>"},{"location":"classification/foundations/#yaml-structure-example","title":"YAML Structure Example","text":"<pre><code># From technique-detection.yaml\ntechniques:\n  MPRAGE:\n    name: \"MPRAGE\"\n    category: \"GRE\"\n    physics: \"IR-prepared 3D spoiled GRE\"\n\n    detection:\n      # Tier 1: Exclusive flag\n      exclusive: is_mprage\n\n      # Tier 2: Alternative flags (any match)\n      alternative_flags:\n        - has_gre\n        - has_ir\n        - is_3d\n\n      # Tier 3: Keywords\n      keywords:\n        - \"mprage\"\n        - \"bravo\"\n        - \"ir-spgr\"\n\n      # Tier 4: Combination (all must match)\n      combination:\n        - has_gre\n        - has_ir\n        - is_3d\n        - has_mag_prepared\n\n    implied_base: \"T1w\"\n    confidence_weight: 0.95\n</code></pre>"},{"location":"classification/foundations/#yaml-files","title":"YAML Files","text":"File Purpose <code>base-detection.yaml</code> Contrast weighting rules <code>technique-detection.yaml</code> Pulse sequence identification <code>modifier-detection.yaml</code> Acquisition modifiers <code>construct-detection.yaml</code> Derived maps <code>provenance-detection.yaml</code> Processing pipeline detection <code>acceleration-detection.yaml</code> Parallel imaging <code>unified-flags-reference.yaml</code> Flag documentation"},{"location":"classification/foundations/#best-practices","title":"Best Practices","text":""},{"location":"classification/foundations/#1-use-unified-flags-first","title":"1. Use Unified Flags First","text":"<p>Always check unified flags before lower-level parsed flags:</p> <pre><code># GOOD: Vendor-agnostic\nif ctx.unified_flags[\"has_se\"]:\n    pass\n\n# AVOID: Vendor-specific (unless necessary)\nif ctx.parsed_scanning_sequence[\"has_se\"]:\n    pass\n</code></pre>"},{"location":"classification/foundations/#2-check-exclusions","title":"2. Check Exclusions","text":"<p>Most detectors check for excluded context:</p> <pre><code># Filter exclusions\nif ctx.parsed_image_type[\"is_secondary\"] and not ctx.parsed_image_type[\"is_primary\"]:\n    return None  # Workstation reformat\n\nif ctx.parsed_image_type[\"is_screenshot\"]:\n    return None  # Screenshot, not MRI\n</code></pre>"},{"location":"classification/foundations/#3-use-appropriate-evidence-sources","title":"3. Use Appropriate Evidence Sources","text":"<p>Match evidence source to detection method:</p> <pre><code># From unified flag\nEvidence.from_token(\"unified_flags\", \"has_se\", target=\"TSE\")\n\n# From text search\nEvidence.from_text_search(\"flair\", target=\"FLAIR\")\n\n# From technique inference\nEvidence.from_technique(\"MPRAGE\", implied_base=\"T1w\")\n</code></pre>"},{"location":"classification/foundations/#4-combine-evidence-for-confidence","title":"4. Combine Evidence for Confidence","text":"<p>Multiple independent sources increase confidence:</p> <pre><code>evidences = []\n\n# High-value token (95%)\nif ctx.unified_flags[\"has_adc\"]:\n    evidences.append(Evidence.from_token(\"unified_flags\", \"has_adc\", \"ADC\"))\n\n# Text search (75%)\nif \"adc\" in ctx.text_search_blob.lower():\n    evidences.append(Evidence.from_text_search(\"adc\", \"ADC\"))\n\n# Combined confidence: 95% + 5% boost = ~99%\n</code></pre>"},{"location":"classification/foundations/#see-also","title":"See Also","text":"<ul> <li>Base Axis - Contrast weighting detection</li> <li>Technique Axis - Pulse sequence identification</li> <li>Modifier Axis - Acquisition enhancements</li> <li>Construct Axis - Derived maps</li> <li>Provenance Axis - Processing pipeline</li> <li>Acceleration Axis - Parallel imaging</li> </ul>"},{"location":"classification/modifier/","title":"Modifier Axis","text":"<p>The Modifier axis identifies acquisition enhancements applied to the base technique. It answers the question: \"How was the acquisition modified from the standard technique?\"</p>"},{"location":"classification/modifier/#overview","title":"Overview","text":"<p>Modifiers are additive - multiple modifiers can apply to a single series. Output is a comma-separated list (alphabetically sorted).</p> Category Modifiers Purpose IR Contrast FLAIR, STIR, DIR, PSIR, IR Tissue nulling via inversion recovery Fat Suppression FatSat, WaterExc, Dixon Remove/separate fat signal Signal Modifiers MT, FlowComp, MoCo Modify tissue/flow signals Trajectory Radial, Spiral Non-Cartesian k-space Blood Signal BlackBlood, BrightBlood Vessel visualization"},{"location":"classification/modifier/#key-concepts","title":"Key Concepts","text":""},{"location":"classification/modifier/#additive-logic","title":"Additive Logic","text":"<p>Unlike Technique (single value), multiple modifiers can coexist:</p> <pre><code>T2-FLAIR + FatSat \u2192 modifier_csv = \"FatSat,FLAIR\"\nDixon + Radial    \u2192 modifier_csv = \"Dixon,Radial\"\n</code></pre>"},{"location":"classification/modifier/#mutual-exclusion-groups","title":"Mutual Exclusion Groups","text":"<p>Some modifiers are mutually exclusive within their group:</p> Group Members Rule IR_CONTRAST FLAIR, STIR, DIR, PSIR, IR Highest priority wins TRAJECTORY Radial, Spiral Highest priority wins <p>Within IR_CONTRAST, you can't have both FLAIR and STIR - they use different TI values for different tissue nulling.</p>"},{"location":"classification/modifier/#output-format","title":"Output Format","text":"<p>Modifiers are output as <code>modifier_csv</code>: - Comma-separated - Alphabetically sorted - Empty string if no modifiers</p> <p>Examples: - <code>\"FLAIR\"</code> - Single modifier - <code>\"Dixon,FatSat\"</code> - Multiple modifiers - <code>\"\"</code> - No modifiers detected</p>"},{"location":"classification/modifier/#detection-strategy","title":"Detection Strategy","text":"<p>Same three-tier approach as other axes (first match wins per modifier):</p>"},{"location":"classification/modifier/#tier-1-exclusive-flag-95-confidence","title":"Tier 1: Exclusive Flag (95% confidence)","text":"<pre><code>FLAIR:\n  detection:\n    exclusive: is_flair\n</code></pre>"},{"location":"classification/modifier/#tier-2-keywords-match-85-confidence","title":"Tier 2: Keywords Match (85% confidence)","text":"<pre><code>FLAIR:\n  keywords:\n    - \"flair\"\n    - \"dark fluid\"\n</code></pre>"},{"location":"classification/modifier/#tier-3-combination-75-confidence","title":"Tier 3: Combination (75% confidence)","text":"<pre><code>Dixon:\n  detection:\n    combination:\n      - has_in_phase\n      - has_out_phase\n</code></pre>"},{"location":"classification/modifier/#ir-contrast-modifiers","title":"IR Contrast Modifiers","text":"<p>Inversion Recovery modifiers use a 180\u00b0 inversion pulse with specific TI to null different tissues.</p>"},{"location":"classification/modifier/#flair-fluid-attenuated-ir","title":"FLAIR (Fluid-Attenuated IR)","text":"<p>TI: ~2000-2500ms at 3T (nulls CSF)</p> <p>Detection: - Exclusive flag: <code>is_flair</code> - Keywords: <code>flair</code>, <code>dark fluid</code>, <code>da fl</code></p> <p>Physics: Long TI nulls CSF signal, making periventricular lesions more visible.</p> <p>Clinical use: - MS lesion detection - Stroke imaging - Tumor visualization near ventricles</p> <p>T1-FLAIR vs T2-FLAIR</p> <p>FLAIR is a modifier, not a base contrast. The base (T1w vs T2w) is determined by TE. Most clinical FLAIR is T2-FLAIR.</p>"},{"location":"classification/modifier/#stir-short-ti-ir","title":"STIR (Short-TI IR)","text":"<p>TI: ~150-200ms at 3T (nulls fat)</p> <p>Detection: - Exclusive flag: <code>has_stir</code> - Keywords: <code>stir</code>, <code>short tau</code>, <code>tirm</code></p> <p>Physics: Short TI nulls fat signal regardless of B0 homogeneity.</p> <p>Clinical use: - Robust fat suppression - Bone marrow edema - Orbital imaging</p> <p>Caveat: Also suppresses gadolinium-enhanced tissue (short T1).</p>"},{"location":"classification/modifier/#dir-double-ir","title":"DIR (Double IR)","text":"<p>Physics: Two inversion pulses to null two tissue types.</p> <p>Detection: - Exclusive flag: <code>is_dir</code> - Keywords: <code>dir</code>, <code>double ir</code>, <code>dual ir</code></p> <p>Common configuration: CSF + white matter nulling \u2192 gray matter only visible.</p> <p>Clinical use: - Cortical lesion detection in MS - Gray matter imaging</p>"},{"location":"classification/modifier/#psir-phase-sensitive-ir","title":"PSIR (Phase-Sensitive IR)","text":"<p>Physics: Preserves magnetization sign (not just magnitude).</p> <p>Detection: - Exclusive flag: <code>has_psir</code> - Keywords: <code>psir</code>, <code>phase sensitive</code></p> <p>Benefit: Improved gray/white contrast and dynamic range.</p> <p>Clinical use: Often combined with MPRAGE for better tissue delineation.</p>"},{"location":"classification/modifier/#ir-generic","title":"IR (Generic)","text":"<p>Detection: - Exclusive flag: <code>has_ir_se</code> (SE-based IR only) - Keywords: <code>inversion recovery</code></p> <p>Note: Fallback when no specific IR variant matches. Uses <code>has_ir_se</code> to exclude GRE-based IR (MPRAGE, MP2RAGE) where IR is part of the technique, not a modifier.</p>"},{"location":"classification/modifier/#fat-suppression-modifiers","title":"Fat Suppression Modifiers","text":""},{"location":"classification/modifier/#fatsat-frequency-selective","title":"FatSat (Frequency-Selective)","text":"<p>Physics: Spectral saturation pulse at fat frequency before excitation.</p> <p>Detection: - Exclusive flag: <code>has_fat_sat</code> - Keywords: <code>fatsat</code>, <code>fat sat</code>, <code>chemsat</code>, <code>spair</code></p> <p>Vendor names: - Generic: FatSat - Philips: SPIR, SPAIR</p> <p>Requirement: Good B0 homogeneity for effective suppression.</p>"},{"location":"classification/modifier/#waterexc-water-only-excitation","title":"WaterExc (Water-Only Excitation)","text":"<p>Physics: Binomial or spectral-spatial pulse that excites only water protons.</p> <p>Detection: - Exclusive flag: <code>has_water_excitation</code> - Keywords: <code>water excitation</code>, <code>proset</code>, <code>wex</code></p> <p>Characteristics: - Faster than fat saturation - Less robust at air-tissue interfaces - Alternative to FatSat</p>"},{"location":"classification/modifier/#dixon-fat-water-separation","title":"Dixon (Fat-Water Separation)","text":"<p>Physics: Acquires in-phase and out-of-phase echoes to separate fat and water.</p> <p>Detection: - Exclusive flag: <code>has_dixon</code> - Keywords: <code>dixon</code>, <code>ideal</code>, <code>mdixon</code>, <code>lava-flex</code> - Combination: <code>has_in_phase</code> + <code>has_out_phase</code></p> <p>Outputs: - Water-only image - Fat-only image - In-phase image - Out-of-phase image</p> <p>Vendor names: - GE: IDEAL - Philips: mDixon - Siemens: Dixon</p>"},{"location":"classification/modifier/#signal-modifiers","title":"Signal Modifiers","text":""},{"location":"classification/modifier/#mt-magnetization-transfer","title":"MT (Magnetization Transfer)","text":"<p>Physics: Off-resonance RF saturates bound (macromolecular) protons. Saturation transfers to free water.</p> <p>Detection: - Exclusive flag: <code>has_mtc</code> - Keywords: <code>magnetization transfer</code>, <code>mtc</code></p> <p>Effect: Tissues with bound protons (myelin, collagen) show signal loss.</p> <p>Clinical use: - Myelin integrity assessment - MS lesion characterization</p>"},{"location":"classification/modifier/#flowcomp-flow-compensation","title":"FlowComp (Flow Compensation)","text":"<p>Physics: Gradient waveforms designed to null velocity-induced phase.</p> <p>Detection: - Exclusive flag: <code>has_flow_comp</code> - Keywords: <code>flow comp</code>, <code>flowcomp</code>, <code>gmn</code>, <code>fc</code></p> <p>Purpose: Reduces flow artifacts in vessels.</p> <p>Variants: - First-order (velocity) - Higher-order (acceleration)</p>"},{"location":"classification/modifier/#moco-motion-correction","title":"MoCo (Motion Correction)","text":"<p>Physics: Retrospective or prospective motion correction.</p> <p>Detection: - Exclusive flag: <code>has_moco</code> - Keywords: <code>moco</code>, <code>mocoseries</code>, <code>motion correct</code></p> <p>Applications: - fMRI - Diffusion imaging - Pediatric/uncooperative patients</p> <p>Note: Often indicated in DICOM ImageType as \"MOCO\" or \"MOTIONCORRECTION\".</p>"},{"location":"classification/modifier/#trajectory-modifiers","title":"Trajectory Modifiers","text":""},{"location":"classification/modifier/#radial-propellerblade","title":"Radial (PROPELLER/BLADE)","text":"<p>Physics: Radial k-space spokes through center.</p> <p>Detection: - Exclusive flag: <code>is_radial</code> - Keywords: <code>propeller</code>, <code>blade</code>, <code>multivane</code>, <code>radial</code></p> <p>Vendor names: - GE: PROPELLER - Siemens: BLADE - Philips: MultiVane</p> <p>Benefit: Motion-robust due to oversampled k-space center.</p>"},{"location":"classification/modifier/#spiral","title":"Spiral","text":"<p>Physics: Spiral readout from k-space center.</p> <p>Detection: - Exclusive flag: <code>is_spiral</code> - Keywords: <code>spiral</code></p> <p>Characteristics: - Very efficient k-space coverage - Sensitive to off-resonance artifacts - Used in ASL, fMRI research</p>"},{"location":"classification/modifier/#blood-signal-modifiers","title":"Blood Signal Modifiers","text":""},{"location":"classification/modifier/#blackblood","title":"BlackBlood","text":"<p>Physics: Double IR or motion-sensitizing prep to null flowing blood.</p> <p>Detection: Keywords only: <code>black blood</code>, <code>blackblood</code>, <code>dark blood</code></p> <p>Clinical use: - Vessel wall imaging - Cardiac imaging - Plaque characterization</p>"},{"location":"classification/modifier/#brightblood","title":"BrightBlood","text":"<p>Physics: Inflow enhancement (TOF-like) for bright arterial blood.</p> <p>Detection: Keywords only: <code>bright blood</code>, <code>brightblood</code></p> <p>Clinical use: - Cardiac imaging - Angiography variants</p>"},{"location":"classification/modifier/#exclusion-group-logic","title":"Exclusion Group Logic","text":"<p>When multiple modifiers from the same exclusion group match, highest priority wins:</p>"},{"location":"classification/modifier/#ir_contrast-group","title":"IR_CONTRAST Group","text":"Modifier Priority TI Range FLAIR 1 ~2000-2500ms (CSF null) STIR 2 ~150-200ms (fat null) DIR 3 Two TIs PSIR 4 Phase-sensitive IR 99 Generic fallback <p>If both FLAIR and STIR keywords appear, FLAIR wins (lower priority number = higher priority).</p>"},{"location":"classification/modifier/#trajectory-group","title":"TRAJECTORY Group","text":"Modifier Priority Radial 1 Spiral 2"},{"location":"classification/modifier/#confidence-levels","title":"Confidence Levels","text":"Detection Method Confidence Exclusive flag 95% Keywords match 85% Combination (AND) 75% No modifiers (valid) 80% <p>Note: \"No modifiers detected\" is a valid, confident result - many series have no modifiers.</p>"},{"location":"classification/modifier/#common-combinations","title":"Common Combinations","text":"Series Type Typical Modifiers T2-FLAIR <code>FLAIR</code> STIR <code>STIR</code> T1 post-contrast FatSat <code>FatSat</code> Dixon VIBE <code>Dixon</code> PROPELLER T2 <code>Radial</code> FLAIR with fat suppression <code>FatSat,FLAIR</code> Black blood TSE <code>BlackBlood</code>"},{"location":"classification/modifier/#modifier-vs-technique","title":"Modifier vs Technique","text":"<p>Some acquisitions could be viewed as either:</p> Acquisition Classification STIR Technique: TSE/IR-TSE, Modifier: STIR FLAIR Technique: TSE, Modifier: FLAIR MPRAGE Technique: MPRAGE (IR is part of technique) PROPELLER T2 Technique: TSE, Modifier: Radial <p>Rule: IR is a modifier for SE sequences, but part of the technique for GRE (MPRAGE, MP2RAGE).</p>"},{"location":"classification/modifier/#yaml-configuration","title":"YAML Configuration","text":"<p>Modifiers are configured in <code>backend/src/classification/detection_yaml/modifier-detection.yaml</code>:</p> <pre><code>exclusion_groups:\n  IR_CONTRAST:\n    description: \"IR-based contrast modifiers\"\n    members: [\"FLAIR\", \"STIR\", \"DIR\", \"PSIR\"]\n    fallback: \"IR\"\n\n  TRAJECTORY:\n    members: [\"Radial\", \"Spiral\"]\n\nmodifiers:\n  FLAIR:\n    name: \"FLAIR\"\n    group: \"IR_CONTRAST\"\n    priority: 1\n    keywords:\n      - \"flair\"\n      - \"dark fluid\"\n    detection:\n      exclusive: is_flair\n\n  FatSat:\n    name: \"FatSat\"\n    group: null  # Independent - can combine with any\n    keywords:\n      - \"fatsat\"\n      - \"spair\"\n    detection:\n      exclusive: has_fat_sat\n\nrules:\n  priority_order:\n    - \"FLAIR\"\n    - \"STIR\"\n    # ... IR group first\n    - \"FatSat\"\n    - \"Dixon\"\n    # ... independent modifiers\n</code></pre>"},{"location":"classification/modifier/#convenience-checks","title":"Convenience Checks","text":"<p>The detector provides helper methods:</p> <pre><code># Check if any IR modifier present\ndetector.has_ir_modifier(result)  # True if FLAIR, STIR, DIR, PSIR, or IR\n\n# Check if any fat suppression\ndetector.has_fat_suppression(result)  # True if FatSat, WaterExc, STIR, or Dixon\n\n# Check if trajectory modifier\ndetector.has_trajectory_modifier(result)  # True if Radial or Spiral\n</code></pre>"},{"location":"classification/provenance/","title":"Provenance Axis","text":"<p>The Provenance axis identifies the processing pipeline or source of an image. It answers the question: \"Where did this image come from and how should it be classified?\"</p>"},{"location":"classification/provenance/#overview","title":"Overview","text":"<p>Provenance is detected FIRST in the classification pipeline because it determines which classification branch to use.</p> Provenance Description Branch SyMRI Synthetic MRI (MAGiC, MDME, QALAS) <code>symri</code> SWIRecon Susceptibility-weighted imaging <code>swi</code> EPIMix Multicontrast EPI (NeuroMix) <code>epimix</code> DTIRecon Diffusion tensor maps <code>rawrecon</code> PerfusionRecon Perfusion parameter maps <code>rawrecon</code> ASLRecon Arterial spin labeling <code>rawrecon</code> BOLDRecon BOLD fMRI <code>rawrecon</code> ProjectionDerived MIP/MPR reformats <code>rawrecon</code> SubtractionDerived Pre-post subtraction <code>rawrecon</code> Localizer Scout/localizer images <code>rawrecon</code> RawRecon Standard reconstruction (default) <code>rawrecon</code>"},{"location":"classification/provenance/#why-provenance-first","title":"Why Provenance First?","text":"<p>Different processing pipelines produce images that need different classification logic:</p> Provenance Special Handling SyMRI Synthetic contrasts labeled as <code>T1w_synthetic</code>, <code>T2w_synthetic</code>, etc. SWIRecon Special taxonomy for magnitude, phase, mIP, QSM outputs EPIMix Multi-contrast detection from single acquisition DTIRecon Diffusion maps (ADC, FA) get construct labels <p>By detecting provenance first, NILS routes to the correct classification branch with specialized logic.</p>"},{"location":"classification/provenance/#classification-branches","title":"Classification Branches","text":""},{"location":"classification/provenance/#symri-branch","title":"<code>symri</code> Branch","text":"<p>Handles Synthetic MRI outputs from: - SyMRI (Siemens/Philips) - MAGiC (GE) - QALAS (GE) - MDME sequences</p> <p>Special handling: - Synthetic T1w, T2w, PD, FLAIR \u2192 labeled as synthetic - Quantitative maps (T1map, T2map, PDmap) - Myelin maps</p>"},{"location":"classification/provenance/#swi-branch","title":"<code>swi</code> Branch","text":"<p>Handles SWI reconstruction outputs: - Magnitude images - Phase images (filtered/unfiltered) - Processed SWI (magnitude \u00d7 phase mask) - MinIP (minimum intensity projection) - QSM (quantitative susceptibility mapping)</p> <p>Special handling: - SWI-specific construct assignment - Phase vs magnitude differentiation</p>"},{"location":"classification/provenance/#epimix-branch","title":"<code>epimix</code> Branch","text":"<p>Handles EPIMix/NeuroMix multicontrast sequences: - T1-FLAIR, T2-FLAIR, T2w, DWI, ADC, T2*w from single acquisition</p> <p>Special handling: - Output type detection from single acquisition - Temporal dimension handling</p>"},{"location":"classification/provenance/#rawrecon-branch","title":"<code>rawrecon</code> Branch","text":"<p>Default branch for standard scanner-reconstructed images and all other provenances.</p> <p>Used for: - Standard anatomical sequences - DTI-derived maps - Perfusion maps - ASL - BOLD fMRI - MIP/MPR reformats - Subtraction images - Localizers</p>"},{"location":"classification/provenance/#detection-strategy","title":"Detection Strategy","text":"<p>Provenance uses a four-tier detection approach (first match wins):</p>"},{"location":"classification/provenance/#tier-1-exclusive-flag-95-confidence","title":"Tier 1: Exclusive Flag (95% confidence)","text":"<p>Single unified flag that definitively identifies provenance:</p> <pre><code>SWIRecon:\n  detection:\n    exclusive: is_swi\n</code></pre>"},{"location":"classification/provenance/#tier-2-alternative-flags-85-90-confidence","title":"Tier 2: Alternative Flags (85-90% confidence)","text":"<p>Any of these flags triggers detection (OR logic):</p> <pre><code>SyMRI:\n  alternative_flags:\n    - has_t1_synthetic\n    - has_t2_synthetic\n    - is_mdme\n    - is_qalas\n</code></pre>"},{"location":"classification/provenance/#tier-3-keywords-match-85-confidence","title":"Tier 3: Keywords Match (85% confidence)","text":"<p>Text pattern matching in series description:</p> <pre><code>SyMRI:\n  detection:\n    keywords:\n      - \"symri\"\n      - \"magic\"\n      - \"synthetic\"\n</code></pre>"},{"location":"classification/provenance/#tier-4-combination-75-confidence","title":"Tier 4: Combination (75% confidence)","text":"<p>All flags must be True (AND logic):</p> <pre><code>SyMRI:\n  detection:\n    combination:\n      - is_synthetic\n      - is_derived\n</code></pre>"},{"location":"classification/provenance/#provenance-definitions","title":"Provenance Definitions","text":""},{"location":"classification/provenance/#symri-synthetic-mri","title":"SyMRI (Synthetic MRI)","text":"<p>Description: Synthetic contrasts from quantitative acquisition.</p> <p>Detection: - Keywords: <code>symri</code>, <code>magic</code>, <code>syntac</code>, <code>synthetic</code> - Alternative flags: <code>has_t1_synthetic</code>, <code>has_t2_synthetic</code>, <code>is_mdme</code>, <code>is_qalas</code> - Combination: <code>is_synthetic</code> + <code>is_derived</code></p> <p>Branch: <code>symri</code></p> <p>Vendor implementations: - Siemens/Philips: SyMRI - GE: MAGiC, QALAS</p> <p>Outputs: Synthetic T1w, T2w, FLAIR, PD + quantitative maps.</p>"},{"location":"classification/provenance/#swirecon-swi-reconstruction","title":"SWIRecon (SWI Reconstruction)","text":"<p>Description: Susceptibility-weighted imaging outputs.</p> <p>Detection: - Exclusive flag: <code>is_swi</code> - Keywords: <code>swi</code>, <code>swan</code>, <code>fsbb</code>, <code>susceptibility</code> - Combination: <code>has_swi</code> + <code>is_derived</code></p> <p>Branch: <code>swi</code></p> <p>Outputs: Magnitude, phase, processed SWI, mIP, QSM.</p>"},{"location":"classification/provenance/#epimix","title":"EPIMix","text":"<p>Description: Multicontrast EPI/NeuroMix sequence producing 6 contrasts from ~1min acquisition.</p> <p>Detection: - Keywords only: <code>epimix</code>, <code>neuromix</code>, <code>ksepimix</code>, <code>axepimix</code></p> <p>Branch: <code>epimix</code></p> <p>Outputs: T1-FLAIR, T2-FLAIR, T2w, isoDWI, ADC, T2*w.</p> <p>Note: EPIMix is checked before SWIRecon because NeuroMix can produce SWI-like outputs.</p>"},{"location":"classification/provenance/#dtirecon-diffusion-tensor","title":"DTIRecon (Diffusion Tensor)","text":"<p>Description: Diffusion tensor/model reconstruction maps.</p> <p>Detection: - Exclusive flag: <code>is_diffusion_derived</code> - Keywords: <code>adc map</code>, <code>fractional anisotropy</code>, <code>dti</code>, <code>tensor</code> - Alternative flags: <code>has_adc</code>, <code>has_eadc</code>, <code>has_fa</code>, <code>has_trace</code></p> <p>Branch: <code>rawrecon</code></p> <p>Outputs: ADC, eADC, FA, MD, Trace, color FA.</p>"},{"location":"classification/provenance/#perfusionrecon","title":"PerfusionRecon","text":"<p>Description: Perfusion parameter maps from DSC/DCE.</p> <p>Detection: - Exclusive flag: <code>is_perfusion_derived</code> - Keywords: <code>cerebral blood flow</code>, <code>mean transit time</code>, <code>perfusion map</code> - Alternative flags: <code>has_cbf</code>, <code>has_cbv</code>, <code>has_mtt</code>, <code>has_ttp</code>, <code>has_tmax</code></p> <p>Branch: <code>rawrecon</code></p> <p>Outputs: CBF, CBV, MTT, TTP, Tmax.</p>"},{"location":"classification/provenance/#aslrecon","title":"ASLRecon","text":"<p>Description: Arterial spin labeling perfusion.</p> <p>Detection: - Exclusive flag: <code>is_asl</code> - Keywords: <code>asl</code>, <code>pcasl</code>, <code>pasl</code>, <code>arterial spin</code></p> <p>Branch: <code>rawrecon</code></p>"},{"location":"classification/provenance/#boldrecon","title":"BOLDRecon","text":"<p>Description: BOLD fMRI timeseries.</p> <p>Detection: - Exclusive flag: <code>is_bold</code> - Keywords: <code>bold</code>, <code>fmri</code>, <code>resting state</code>, <code>functional mri</code></p> <p>Branch: <code>rawrecon</code></p>"},{"location":"classification/provenance/#projectionderived","title":"ProjectionDerived","text":"<p>Description: MIP/MPR/reformatted projections.</p> <p>Detection: - Keywords: <code>maximum intensity</code>, <code>minimum intensity</code>, <code>multiplanar reformat</code> - Alternative flags: <code>is_mip</code>, <code>is_minip</code>, <code>is_mpr</code>, <code>is_projection</code></p> <p>Branch: <code>rawrecon</code></p> <p>Note: Common for MRA visualization.</p>"},{"location":"classification/provenance/#subtractionderived","title":"SubtractionDerived","text":"<p>Description: Pre-post contrast subtraction or difference images.</p> <p>Detection: - Exclusive flag: <code>is_subtraction</code> - Keywords: <code>subtraction</code>, <code>subtracted</code>, <code>difference</code>, <code>pre post</code></p> <p>Branch: <code>rawrecon</code></p>"},{"location":"classification/provenance/#localizer","title":"Localizer","text":"<p>Description: Localizer/scout images for planning.</p> <p>Detection: - Exclusive flag: <code>is_localizer</code> - Keywords: <code>localizer</code>, <code>scout</code>, <code>survey</code>, <code>3 plan</code>, <code>autoalign</code>, <code>calibration</code></p> <p>Branch: <code>rawrecon</code></p> <p>Note: Checked before ProjectionDerived because scout MPR reformats should be classified as localizers.</p>"},{"location":"classification/provenance/#rawrecon-default","title":"RawRecon (Default)","text":"<p>Description: Standard scanner reconstruction - the default when no specific provenance matches.</p> <p>Detection: No detection rules - this is the fallback.</p> <p>Branch: <code>rawrecon</code></p> <p>Confidence: 80% (default)</p>"},{"location":"classification/provenance/#priority-order","title":"Priority Order","text":"<p>Provenances are checked in this order (first match wins):</p> <ol> <li>SyMRI - Synthetic MRI</li> <li>EPIMix - Multicontrast EPI (before SWI because NeuroMix can produce SWI)</li> <li>SWIRecon - Susceptibility-weighted</li> <li>DTIRecon - Diffusion tensor</li> <li>PerfusionRecon - Perfusion maps</li> <li>ASLRecon - Arterial spin labeling</li> <li>BOLDRecon - BOLD fMRI</li> <li>Localizer - Scout images (before ProjectionDerived)</li> <li>ProjectionDerived - MIP/MPR</li> <li>SubtractionDerived - Subtraction images</li> <li>RawRecon - Default fallback</li> </ol>"},{"location":"classification/provenance/#confidence-levels","title":"Confidence Levels","text":"Detection Method Confidence Exclusive flag 95% Alternative flags (OR) 85-90% Keywords match 85% Combination (AND) 75% Default (no match) 80%"},{"location":"classification/provenance/#output","title":"Output","text":"<p>Provenance is a single value (not CSV):</p> <pre><code>{\n    \"provenance\": \"SyMRI\",\n    # OR\n    \"provenance\": \"RawRecon\"\n}\n</code></pre>"},{"location":"classification/provenance/#examples","title":"Examples","text":"Series Provenance Branch Standard T1 MPRAGE <code>RawRecon</code> rawrecon MAGiC Synthetic T1 <code>SyMRI</code> symri SWI Phase image <code>SWIRecon</code> swi ADC map from DWI <code>DTIRecon</code> rawrecon CBF map from DSC <code>PerfusionRecon</code> rawrecon Resting-state fMRI <code>BOLDRecon</code> rawrecon TOF MRA MIP <code>ProjectionDerived</code> rawrecon 3-plane localizer <code>Localizer</code> rawrecon"},{"location":"classification/provenance/#branch-specific-classification","title":"Branch-Specific Classification","text":"<p>After provenance detection, NILS routes to the appropriate branch:</p> <pre><code>flowchart TB\n    A[\"Provenance Detected\"] --&gt; B{Branch Type?}\n\n    B --&gt;|SyMRI| C[\"SyMRI Branch\"]\n    B --&gt;|SWIRecon| D[\"SWI Branch\"]\n    B --&gt;|EPIMix| E[\"EPIMix Branch\"]\n    B --&gt;|Other| F[\"RawRecon Branch\"]\n\n    C --&gt; G[\"Special handling for&lt;br/&gt;synthetic/quantitative outputs\"]\n    D --&gt; G\n    E --&gt; G\n\n    F --&gt; H[\"Standard classification&lt;br/&gt;(base, technique, etc.)\"]</code></pre>"},{"location":"classification/provenance/#yaml-configuration","title":"YAML Configuration","text":"<p>Provenance is configured in <code>backend/src/classification/detection_yaml/provenance-detection.yaml</code>:</p> <pre><code>provenances:\n  SyMRI:\n    name: \"SyMRI\"\n    description: \"Synthetic MRI from quantitative acquisition\"\n    branch: \"symri\"\n\n    detection:\n      exclusive: null\n      keywords:\n        - \"symri\"\n        - \"magic\"\n        - \"synthetic\"\n      combination:\n        - is_synthetic\n        - is_derived\n\n    alternative_flags:\n      - has_t1_synthetic\n      - has_t2_synthetic\n      - is_mdme\n      - is_qalas\n\n  RawRecon:\n    name: \"RawRecon\"\n    branch: \"rawrecon\"\n    is_default: true\n\nrules:\n  priority_order:\n    - SyMRI\n    - EPIMix\n    - SWIRecon\n    # ... etc\n  default_provenance: RawRecon\n\nbranches:\n  symri:\n    provenances: [SyMRI]\n  swi:\n    provenances: [SWIRecon]\n  epimix:\n    provenances: [EPIMix]\n  rawrecon:\n    provenances: [DTIRecon, PerfusionRecon, ...]\n</code></pre>"},{"location":"classification/provenance/#convenience-methods","title":"Convenience Methods","text":"<pre><code># Get classification branch for a provenance\ndetector.get_branch(\"SyMRI\")  # Returns \"symri\"\ndetector.get_branch(\"DTIRecon\")  # Returns \"rawrecon\"\n\n# Get all provenances in priority order\ndetector.get_all_provenances()\n\n# Get branch mapping\ndetector.get_branches()\n# Returns: {\"symri\": [\"SyMRI\"], \"swi\": [\"SWIRecon\"], ...}\n</code></pre>"},{"location":"classification/technique/","title":"Technique Axis","text":"<p>The Technique axis identifies the MRI pulse sequence family used for acquisition. It answers the question: \"What pulse sequence was used to acquire this image?\"</p>"},{"location":"classification/technique/#overview","title":"Overview","text":"<p>MRI techniques are grouped into four physics-based families:</p> Family Physics Key Characteristic Examples SE Spin Echo 180\u00b0 refocusing pulse TSE, HASTE, SPACE GRE Gradient Echo Gradient refocusing only FLASH, MPRAGE, FIESTA EPI Echo Planar Ultra-fast k-space traversal Single/multi-shot EPI MIXED Hybrid Combines physics or application-specific DWI-EPI, BOLD, ASL, GRASE"},{"location":"classification/technique/#detection-strategy","title":"Detection Strategy","text":"<p>NILS uses a three-tier detection approach (first match wins):</p>"},{"location":"classification/technique/#tier-1-exclusive-flag-95-confidence","title":"Tier 1: Exclusive Flag (95% confidence)","text":"<p>A single <code>unified_flag</code> that definitively identifies the technique:</p> <pre><code>MPRAGE:\n  detection:\n    exclusive: is_mprage  # If True \u2192 MPRAGE\n</code></pre>"},{"location":"classification/technique/#tier-2-keywords-match-85-confidence","title":"Tier 2: Keywords Match (85% confidence)","text":"<p>Text pattern matching in series description:</p> <pre><code>MPRAGE:\n  keywords:\n    - \"mprage\"\n    - \"bravo\"\n    - \"3d tfe\"\n    - \"ir-fspgr\"\n</code></pre>"},{"location":"classification/technique/#tier-3-combination-75-confidence","title":"Tier 3: Combination (75% confidence)","text":"<p>Multiple flags that must ALL be True (AND logic):</p> <pre><code>MPRAGE:\n  detection:\n    combination:  # All must be True\n      - has_ir\n      - has_gre\n      - is_3d\n</code></pre>"},{"location":"classification/technique/#priority-based-detection","title":"Priority-Based Detection","text":"<p>Techniques are checked in priority order - more specific techniques before generic ones:</p> <pre><code>Specific \u2192 Generic\n\nMPRAGE \u2192 checked before \u2192 GRE\nRESOLVE \u2192 checked before \u2192 DWI-EPI \u2192 checked before \u2192 EPI\nSPACE \u2192 checked before \u2192 TSE \u2192 checked before \u2192 SE\n</code></pre> <p>This ensures that MPRAGE (a specific IR-prepared 3D GRE) is detected rather than falling through to generic GRE.</p>"},{"location":"classification/technique/#se-family-spin-echo","title":"SE Family (Spin Echo)","text":"<p>Uses 180\u00b0 RF refocusing pulse. Produces \"true\" T2 contrast without susceptibility artifacts.</p>"},{"location":"classification/technique/#mdme-multi-dynamic-multi-echo","title":"MDME (Multi-Dynamic Multi-Echo)","text":"<p>Vendor names: SyMRI, MAGiC</p> <p>Physics: 2D TSE with multiple echoes at multiple TR/saturation times.</p> <p>Detection: - Exclusive flag: <code>is_mdme</code> - Keywords: <code>mdme</code>, <code>symri</code>, <code>magic</code></p> <p>Purpose: Acquisition for synthetic MRI - generates T1, T2, PD maps and synthetic contrasts.</p>"},{"location":"classification/technique/#space-3d-tse","title":"SPACE (3D-TSE)","text":"<p>Vendor names: Siemens: SPACE, GE: CUBE, Philips: VISTA</p> <p>Physics: 3D volumetric TSE with variable flip angle refocusing (reduces SAR).</p> <p>Detection: - Exclusive flag: <code>is_space</code> - Keywords: <code>space</code>, <code>cube</code>, <code>vista</code>, <code>3d tse</code> - Combination: <code>is_tse</code> + <code>is_3d</code></p> <p>Purpose: Isotropic high-resolution 3D imaging.</p>"},{"location":"classification/technique/#haste-single-shot-tse","title":"HASTE (Single-Shot TSE)","text":"<p>Vendor names: Siemens: HASTE, GE: SSFSE, Philips: SSH-TSE</p> <p>Physics: Acquires entire k-space in one TR (single-shot).</p> <p>Detection: - Exclusive flag: <code>is_haste</code> - Keywords: <code>haste</code>, <code>ssfse</code>, <code>ss-tse</code></p> <p>Characteristics: - Very fast acquisition - Motion-robust - Has T2 blurring from long echo train</p>"},{"location":"classification/technique/#tirm-ir-tse","title":"TIRM (IR-TSE)","text":"<p>Physics: Inversion recovery preparation + TSE readout.</p> <p>Detection: - Keywords: <code>tirm</code>, <code>stir</code>, <code>ir-tse</code> - Combination: <code>has_ir</code> + <code>is_tse</code></p> <p>Variants: - STIR: Short TI for fat suppression - TIRM: Siemens IR-TSE variant</p> <p>FLAIR vs IR-TSE</p> <p>FLAIR is a modifier, not a technique. FLAIR uses IR-TSE physics but is captured in the Modifier axis. The technique would be TSE or IR-TSE.</p>"},{"location":"classification/technique/#mese-multi-echo-se","title":"MESE (Multi-Echo SE)","text":"<p>Physics: Multiple spin echoes at different TEs from single excitation.</p> <p>Detection: - Exclusive flag: <code>is_me_se</code> - Keywords: <code>mese</code>, <code>me-se</code>, <code>dual echo se</code> - Combination: <code>is_multi_echo</code> + <code>has_se</code></p> <p>Purpose: T2 mapping, proton density estimation.</p> <p>Note: Different from TSE - MESE has separate echoes; TSE has an echo train.</p>"},{"location":"classification/technique/#restore-vfa-tse","title":"RESTORE (VFA-TSE)","text":"<p>Vendor names: Siemens: RESTORE, GE: FRFSE, Philips: DRIVE</p> <p>Physics: Variable flip angle within echo train + driven equilibrium.</p> <p>Detection: Keywords only (<code>restore</code>, <code>frfse</code>, <code>drive</code>)</p> <p>Purpose: Optimized T2 contrast with improved SNR.</p>"},{"location":"classification/technique/#tse-turbo-spin-echo","title":"TSE (Turbo Spin Echo)","text":"<p>Vendor names: Siemens: TSE, GE: FSE, Philips: TSE</p> <p>Physics: Echo train of refocusing pulses - multiple echoes per TR.</p> <p>Detection: - Exclusive flag: <code>is_tse</code> - Keywords: <code>tse</code>, <code>fse</code>, <code>turbo spin echo</code>, <code>rare</code></p> <p>Clinical role: The workhorse of clinical MRI. Used for T1w, T2w, PD, FLAIR.</p>"},{"location":"classification/technique/#se-basic-spin-echo","title":"SE (Basic Spin Echo)","text":"<p>Physics: Simple 90\u00b0-180\u00b0 pulse pair, single echo.</p> <p>Detection: - Exclusive flag: <code>has_se</code> (fallback) - Keywords: <code>spin-echo</code></p> <p>Note: Fallback for SE family when no specific variant matches.</p>"},{"location":"classification/technique/#gre-family-gradient-echo","title":"GRE Family (Gradient Echo)","text":"<p>Uses gradient reversal only (no 180\u00b0 pulse). Faster than SE but susceptible to field inhomogeneities.</p>"},{"location":"classification/technique/#quantitativespecial-techniques","title":"Quantitative/Special Techniques","text":""},{"location":"classification/technique/#qalas-3d-qalas","title":"QALAS (3D-QALAS)","text":"<p>Vendor: GE</p> <p>Physics: Interleaved IR-GRE for multiparametric mapping.</p> <p>Detection: - Exclusive flag: <code>is_qalas</code> - Keywords: <code>qalas</code>, <code>3d qalas</code></p> <p>Purpose: T1, T2, PD quantification.</p>"},{"location":"classification/technique/#mp2rage","title":"MP2RAGE","text":"<p>Physics: Two-inversion MPRAGE - acquires at two TI times.</p> <p>Detection: - Keywords: <code>mp2rage</code> - Combination: <code>is_multi_ti</code> + <code>has_gre</code> + <code>has_ir</code> + <code>is_3d</code></p> <p>Purpose: Bias-reduced T1 mapping, uniform T1w images.</p>"},{"location":"classification/technique/#memprage-multi-echo-mprage","title":"MEMPRAGE (Multi-Echo MPRAGE)","text":"<p>Physics: MPRAGE with multiple GRE echoes.</p> <p>Detection: - Keywords: <code>memprage</code>, <code>me-mprage</code> - Combination: <code>is_multi_echo</code> + <code>has_ir</code> + <code>has_gre</code> + <code>is_3d</code></p> <p>Purpose: T2* mapping alongside structural T1w.</p>"},{"location":"classification/technique/#mprage","title":"MPRAGE","text":"<p>Vendor names: Siemens: MPRAGE, GE: BRAVO/IR-SPGR, Philips: 3D-TFE</p> <p>Physics: IR-prepared 3D spoiled GRE.</p> <p>Detection: - Exclusive flag: <code>is_mprage</code> - Keywords: <code>mprage</code>, <code>bravo</code>, <code>3d tfe</code> - Combination: <code>has_ir</code> + <code>has_gre</code> + <code>is_3d</code></p> <p>Clinical role: Standard 3D T1-weighted structural sequence.</p>"},{"location":"classification/technique/#mraflow-techniques","title":"MRA/Flow Techniques","text":""},{"location":"classification/technique/#tof-mra-time-of-flight","title":"TOF-MRA (Time-of-Flight)","text":"<p>Physics: Inflow enhancement - fresh spins appear bright.</p> <p>Detection: - Exclusive flag: <code>is_tof</code> - Keywords: <code>tof</code>, <code>time of flight</code></p> <p>Purpose: Bright-blood angiography without contrast.</p>"},{"location":"classification/technique/#pc-mra-phase-contrast","title":"PC-MRA (Phase Contrast)","text":"<p>Physics: Bipolar gradients encode velocity.</p> <p>Detection: - Exclusive flag: <code>is_pc</code> - Keywords: <code>pc-mra</code>, <code>phase contrast</code>, <code>velocity</code></p> <p>Purpose: Flow quantification, 4D flow imaging.</p>"},{"location":"classification/technique/#multi-echo-gre","title":"Multi-Echo GRE","text":""},{"location":"classification/technique/#medic-combined-me-gre","title":"MEDIC (Combined ME-GRE)","text":"<p>Vendor names: Siemens: MEDIC, GE: MERGE, Philips: mFFE</p> <p>Physics: Fused multi-echo GRE.</p> <p>Detection: Keywords: <code>medic</code>, <code>merge</code>, <code>mffe</code></p> <p>Implied base: T2*w (85% confidence)</p>"},{"location":"classification/technique/#megre-multi-echo-gre","title":"MEGRE (Multi-Echo GRE)","text":"<p>Physics: Multiple gradient echoes at different TEs.</p> <p>Detection: - Keywords: <code>megre</code>, <code>me-gre</code>, <code>multi echo gre</code> - Combination: <code>is_multi_echo</code> + <code>has_gre</code></p> <p>Purpose: T2* mapping, QSM, Dixon fat/water separation.</p> <p>Implied base: T2*w (80% confidence)</p>"},{"location":"classification/technique/#ssfp-variants","title":"SSFP Variants","text":""},{"location":"classification/technique/#ciss","title":"CISS","text":"<p>Vendor names: Siemens: CISS, GE: FIESTA-C, Philips: 3D-DRIVE</p> <p>Physics: Phase-cycled balanced SSFP.</p> <p>Detection: - Exclusive flag: <code>is_ciss</code> - Keywords: <code>ciss</code>, <code>fiesta-c</code></p> <p>Purpose: High-SNR imaging of cisterns, cranial nerves.</p>"},{"location":"classification/technique/#fiesta-bssfp","title":"FIESTA (bSSFP)","text":"<p>Vendor names: Siemens: TrueFISP, GE: FIESTA, Philips: bFFE</p> <p>Physics: Fully balanced gradients - high SNR, mixed T2/T1 contrast.</p> <p>Detection: - Exclusive flag: <code>is_ssfp</code> - Keywords: <code>bssfp</code>, <code>truefisp</code>, <code>fiesta</code>, <code>balanced ffe</code> - Combination: <code>has_steady_state</code> + <code>has_gre</code></p>"},{"location":"classification/technique/#dess-dual-echo-ssfp","title":"DESS (Dual-Echo SSFP)","text":"<p>Physics: Combines FID and echo signals.</p> <p>Detection: Keywords: <code>dess</code>, <code>mensa</code></p> <p>Purpose: Musculoskeletal/cartilage imaging.</p>"},{"location":"classification/technique/#psif-generic-ssfp","title":"PSIF (Generic SSFP)","text":"<p>Physics: Reversed echo SSFP (T2-like contrast).</p> <p>Detection: - Keywords: <code>ssfp</code>, <code>psif</code>, <code>t2-ffe</code> - Combination: <code>has_steady_state</code> + <code>has_gre</code></p>"},{"location":"classification/technique/#volumetric-gre","title":"Volumetric GRE","text":""},{"location":"classification/technique/#vibe-3d-volumetric-spoiled-gre","title":"VIBE (3D Volumetric Spoiled GRE)","text":"<p>Vendor names: Siemens: VIBE, GE: LAVA, Philips: THRIVE</p> <p>Physics: 3D spoiled GRE for volumetric T1 imaging.</p> <p>Detection: - Keywords: <code>vibe</code>, <code>lava</code>, <code>thrive</code> - Combination: <code>has_spoiled</code> + <code>is_3d</code> + <code>has_gre</code></p>"},{"location":"classification/technique/#vfa-gre-variable-flip-angle","title":"VFA-GRE (Variable Flip Angle)","text":"<p>Physics: Multiple flip angles for T1 mapping.</p> <p>Detection: - Keywords: <code>vfa</code>, <code>despot</code> - Combination: <code>is_multi_fa</code> + <code>has_gre</code> + <code>is_3d</code></p>"},{"location":"classification/technique/#fastbasic-gre","title":"Fast/Basic GRE","text":""},{"location":"classification/technique/#turboflash-fast-spoiled-gre","title":"TurboFLASH (Fast Spoiled GRE)","text":"<p>Vendor names: Siemens: TurboFLASH, GE: FSPGR, Philips: TFE</p> <p>Detection: - Exclusive flag: <code>is_tfl</code> - Keywords: <code>turboflash</code>, <code>fspgr</code>, <code>tfe</code></p> <p>Purpose: Rapid T1w for dynamic imaging.</p>"},{"location":"classification/technique/#flash-spoiled-gre","title":"FLASH (Spoiled GRE)","text":"<p>Vendor names: Siemens: FLASH, GE: SPGR, Philips: T1-FFE</p> <p>Physics: RF/gradient spoiling for pure T1 contrast.</p> <p>Detection: - Exclusive flag: <code>is_flash</code> - Keywords: <code>flash</code>, <code>spgr</code>, <code>t1-ffe</code> - Combination: <code>has_spoiled</code> + <code>has_gre</code></p>"},{"location":"classification/technique/#gre-generic","title":"GRE (Generic)","text":"<p>Detection: - Exclusive flag: <code>has_gre</code> (fallback) - Keywords: <code>gre</code>, <code>gradient-echo</code>, <code>ffe</code></p> <p>Note: Fallback for GRE family.</p>"},{"location":"classification/technique/#epi-family-echo-planar-imaging","title":"EPI Family (Echo Planar Imaging)","text":"<p>Ultra-fast k-space traversal. Backbone for functional and diffusion imaging.</p>"},{"location":"classification/technique/#resolve-multi-shot-epi","title":"RESOLVE (Multi-Shot EPI)","text":"<p>Vendor names: Siemens: RESOLVE, GE: MUSE</p> <p>Physics: Splits k-space over several shots - reduces distortion.</p> <p>Detection: - Exclusive flag: <code>is_epi_diff_resolve</code> - Keywords: <code>resolve</code>, <code>muse</code>, <code>multishot epi</code> - Combination: <code>has_segmented_kspace</code> + <code>has_epi</code></p>"},{"location":"classification/technique/#epi-generic","title":"EPI (Generic)","text":"<p>Detection: - Exclusive flag: <code>has_epi</code> (fallback) - Keywords: <code>epi</code>, <code>echo planar</code></p>"},{"location":"classification/technique/#mixed-family-hybrid-physics","title":"MIXED Family (Hybrid Physics)","text":"<p>Combines SE+GRE, SE+EPI physics, or application-specific sequences.</p>"},{"location":"classification/technique/#diffusion","title":"Diffusion","text":""},{"location":"classification/technique/#dwi-epi","title":"DWI-EPI","text":"<p>Physics: SE-EPI with diffusion-sensitizing gradients.</p> <p>Detection: - Exclusive flag: <code>is_dwi</code> - Keywords: <code>dwi</code>, <code>dti</code>, <code>diffusion</code>, <code>hardi</code></p> <p>Implied base: DWI (95% confidence)</p>"},{"location":"classification/technique/#dwi-steam","title":"DWI-STEAM","text":"<p>Physics: Stimulated echo diffusion.</p> <p>Detection: Keywords: <code>steam</code>, <code>dwi-steam</code></p>"},{"location":"classification/technique/#functionalperfusion","title":"Functional/Perfusion","text":""},{"location":"classification/technique/#bold-bold-epi","title":"BOLD (BOLD-EPI)","text":"<p>Physics: GRE-EPI sensitive to deoxyhemoglobin.</p> <p>Detection: - Exclusive flag: <code>is_bold</code> - Keywords: <code>bold</code>, <code>fmri</code>, <code>functional</code>, <code>resting state</code></p> <p>Note: No tissue contrast - functional imaging.</p>"},{"location":"classification/technique/#asl-arterial-spin-labeling","title":"ASL (Arterial Spin Labeling)","text":"<p>Physics: RF labeling for non-contrast perfusion.</p> <p>Detection: - Exclusive flag: <code>is_asl</code> - Keywords: <code>asl</code>, <code>pcasl</code>, <code>pasl</code>, <code>arterial spin</code></p> <p>Implied base: PWI</p>"},{"location":"classification/technique/#perfusion-epi","title":"Perfusion-EPI","text":"<p>Physics: DSC (T2*-based) or DCE (T1-based) perfusion.</p> <p>Detection: - Exclusive flag: <code>is_perfusion</code> - Keywords: <code>perfusion</code>, <code>dsc</code>, <code>dce</code>, <code>pwi</code></p>"},{"location":"classification/technique/#hybrid-physics","title":"Hybrid Physics","text":""},{"location":"classification/technique/#grase","title":"GRASE","text":"<p>Physics: SE refocusing with GRE readouts.</p> <p>Detection: - Keywords: <code>grase</code>, <code>turbogse</code>, <code>tgse</code> - Combination: <code>has_se</code> + <code>has_gre</code></p> <p>Characteristics: Faster than pure TSE, less T2* than EPI.</p>"},{"location":"classification/technique/#se-epi","title":"SE-EPI","text":"<p>Physics: 180\u00b0 SE preparation + EPI readout.</p> <p>Detection: - Keywords: <code>se-epi</code>, <code>spin echo epi</code> - Combination: <code>has_se</code> + <code>has_epi</code></p> <p>Benefit: Less T2* artifact than GRE-EPI.</p>"},{"location":"classification/technique/#gre-epi","title":"GRE-EPI","text":"<p>Physics: GRE preparation + EPI readout.</p> <p>Detection: - Keywords: <code>gre-epi</code>, <code>epi-gre</code> - Combination: <code>has_gre</code> + <code>has_epi</code></p> <p>Note: Backbone for BOLD and DSC perfusion.</p>"},{"location":"classification/technique/#mrf-mr-fingerprinting","title":"MRF (MR Fingerprinting)","text":"<p>Physics: Pseudo-randomized parameters + dictionary matching.</p> <p>Detection: - Exclusive flag: <code>is_mrf</code> - Keywords: <code>mrf</code>, <code>fingerprinting</code></p> <p>Purpose: Quantitative T1/T2 mapping.</p>"},{"location":"classification/technique/#important-notes","title":"Important Notes","text":""},{"location":"classification/technique/#swi-is-not-a-technique","title":"SWI is NOT a Technique","text":"<p>SWI (Susceptibility-Weighted Imaging) is a provenance/processing method, not an acquisition technique. The actual acquisition is GRE or EPI. SWI processing is captured in <code>provenance=\"SWIRecon\"</code>.</p>"},{"location":"classification/technique/#radialspiral-are-modifiers","title":"Radial/Spiral are Modifiers","text":"<p>Radial and Spiral are trajectory modifiers, not techniques: - Radial GRE = GRE technique + Radial modifier - Spiral EPI = EPI technique + Spiral modifier</p> <p>These are captured in the Modifier axis.</p>"},{"location":"classification/technique/#confidence-levels","title":"Confidence Levels","text":"Detection Method Confidence Rationale Exclusive flag 95% Definitive single flag Keywords match 85% Text-based identification Combination (AND) 75% Multiple flags required Family fallback 60% Generic family detection"},{"location":"classification/technique/#conflict-detection","title":"Conflict Detection","text":"<p>NILS checks for physics family conflicts:</p> <ul> <li>GRE technique detected but SE flags present \u2192 conflict</li> <li>SE technique detected but GRE keywords in text \u2192 conflict</li> </ul> <p>Conflicts trigger manual review. MIXED family techniques skip conflict checks (they inherently combine physics).</p>"},{"location":"classification/technique/#technique-to-base-inference","title":"Technique-to-Base Inference","text":"<p>Some techniques strongly imply a base contrast:</p> Technique Implied Base Confidence MPRAGE T1w 95% DWI-EPI DWI 95% TOF-MRA T1w 90% ME-GRE T2*w 85% ASL-EPI PWI 95% BOLD-EPI None - <p>BOLD-EPI has no tissue contrast inference (functional imaging).</p>"},{"location":"classification/technique/#yaml-configuration","title":"YAML Configuration","text":"<p>Techniques are configured in <code>backend/src/classification/detection_yaml/technique-detection.yaml</code>:</p> <pre><code>techniques:\n  MPRAGE:\n    name: \"MPRAGE\"\n    family: \"GRE\"\n    description: \"IR-prepped 3D T1w\"\n    keywords:\n      - \"mprage\"\n      - \"bravo\"\n    detection:\n      exclusive: is_mprage\n      combination:\n        - has_ir\n        - has_gre\n        - is_3d\n\nrules:\n  priority_order:\n    - \"MS-EPI\"      # Specific first\n    - \"DWI-EPI\"\n    - \"MPRAGE\"\n    # ... more specific ...\n    - \"GRE\"         # Generic last\n    - \"EPI\"\n</code></pre>"},{"location":"classification/branches/","title":"Classification Branches","text":"<p>The standard six-axis classification works well for conventional MRI acquisitions where one acquisition produces one contrast in one series. However, several advanced MRI technologies break this paradigm by producing multiple distinct outputs from a single acquisition, each requiring specialized classification logic.</p>"},{"location":"classification/branches/#why-branches-exist","title":"Why Branches Exist","text":""},{"location":"classification/branches/#the-multi-output-problem","title":"The Multi-Output Problem","text":"<p>Modern MRI sequences can generate many DICOM series from a single acquisition:</p> Technology Acquisition Time Output Series Challenge SyMRI/MAGiC ~5 minutes 1-20+ series Raw data, quantitative maps, synthetic contrasts SWI ~4 minutes 2-6 series Magnitude, phase, processed SWI, MinIP, QSM EPIMix/NeuroMix ~1 minute 6 series T1-FLAIR, T2-FLAIR, T2w, DWI, ADC, T2*w <p>Standard axis detectors cannot handle this because:</p> <ol> <li>Shared source sequence - All outputs share the same sequence name</li> <li>Specialized ImageType tokens - Tokens have technology-specific meanings</li> <li>Variable base contrast - Some outputs have NO tissue contrast (base=NULL)</li> <li>Provenance determines logic - How data was created dictates classification</li> </ol>"},{"location":"classification/branches/#the-solution-provenance-first-branching","title":"The Solution: Provenance-First Branching","text":"<p>NILS detects provenance first (Stage 1), then routes to specialized branch logic:</p> <pre><code>flowchart TB\n    subgraph stage1[\"ProvenanceDetector (Stage 1)\"]\n        pd[\"Detects: SyMRI, SWIRecon, EPIMix, DTIRecon, etc.\"]\n    end\n\n    stage1 --&gt; symri[\"SyMRI Branch\"]\n    stage1 --&gt; swi[\"SWI Branch\"]\n    stage1 --&gt; epimix[\"EPIMix Branch\"]\n\n    symri --&gt; s1[\"Specialized output type detection\"]\n    swi --&gt; s2[\"Specialized output type detection\"]\n    epimix --&gt; s3[\"Specialized output type detection\"]</code></pre>"},{"location":"classification/branches/#available-branches","title":"Available Branches","text":""},{"location":"classification/branches/#symri-branch","title":"SyMRI Branch","text":"<p>Handles Synthetic MRI outputs from SyMRI, MAGiC (GE), and QALAS sequences.</p> <p>Provenance triggers: <code>SyMRI</code></p> <p>Output types: - Raw source (Magnitude, Phase) - Quantitative maps (T1map, T2map, PDmap, R1map, R2map, B1map, MyelinMap) - Synthetic weighted images (SyntheticT1w, SyntheticT2w, SyntheticPDw) - Synthetic IR contrasts (SyntheticFLAIR, SyntheticDIR, SyntheticPSIR, SyntheticSTIR)</p> <p>Key insight: Quantitative maps have <code>base=NULL</code> (no tissue contrast), while synthetic weighted images have proper base contrast (T1w, T2w, PDw).</p>"},{"location":"classification/branches/#swi-branch","title":"SWI Branch","text":"<p>Handles Susceptibility-Weighted Imaging outputs.</p> <p>Provenance triggers: <code>SWIRecon</code></p> <p>Output types: - Magnitude (T2*-weighted source) - Phase (filtered phase map) - SWI (processed: magnitude \u00d7 phase mask) - MinIP (minimum intensity projection) - MIP (maximum intensity projection) - QSM (quantitative susceptibility mapping)</p> <p>Key insight: All SWI outputs have <code>base=SWI</code>. The technique (GRE or EPI) indicates the acquisition method.</p>"},{"location":"classification/branches/#epimix-branch","title":"EPIMix Branch","text":"<p>Handles EPIMix and NeuroMix multicontrast EPI sequences.</p> <p>Provenance triggers: <code>EPIMix</code></p> <p>Output types (EPIMix): - T1-FLAIR (SE-EPI, short TI) - T2-FLAIR (SE-EPI, long TI) - T2w (b=0 from DWI block) - isoDWI (averaged 3-direction) - ADC (apparent diffusion coefficient) - T2*w (GRE-EPI)</p> <p>Output types (NeuroMix additions): - T2-FLAIR with SSFSE readout (no EPI distortion) - T2w with SSFSE or FSE readout - T1w 3D-EPI - SWI 3D-EPI</p> <p>Key insight: NeuroMix uses SSFSE readout for some outputs, eliminating EPI distortion.</p>"},{"location":"classification/branches/#rawrecon-branch-default","title":"RawRecon Branch (Default)","text":"<p>The default branch for standard scanner-reconstructed images. Also handles:</p> <ul> <li>DTI-derived maps (ADC, FA, MD, Trace)</li> <li>Perfusion maps (CBF, CBV, MTT, Tmax, TTP)</li> <li>ASL perfusion</li> <li>BOLD fMRI</li> <li>MIP/MPR reformats</li> <li>Subtraction images</li> <li>Localizers</li> </ul> <p>The rawrecon branch uses standard axis detectors without special overrides.</p>"},{"location":"classification/branches/#how-branches-work","title":"How Branches Work","text":""},{"location":"classification/branches/#branch-result-structure","title":"Branch Result Structure","text":"<p>Each branch returns a <code>BranchResult</code> that can override axis detectors:</p> <pre><code>@dataclass\nclass BranchResult:\n    # Override values\n    base: Optional[str] = None          # Override base contrast\n    construct: str = \"\"                  # Override construct\n    modifiers_add: List[str] = None      # Additional modifiers\n    technique: Optional[str] = None      # Override technique\n\n    # Skip flags\n    skip_base_detection: bool = False    # Skip BaseContrastDetector\n    skip_construct_detection: bool = False\n    skip_technique_detection: bool = False\n\n    # Intent\n    directory_type: Optional[str] = None  # BIDS directory type\n\n    # Confidence\n    confidence: float = 0.0\n    evidence: List[Evidence] = []\n</code></pre>"},{"location":"classification/branches/#override-logic","title":"Override Logic","text":"<p>When a branch sets <code>skip_*_detection=True</code>, the pipeline uses the branch's value instead of running the standard detector:</p> <pre><code># Example: SyMRI T1 map\nBranchResult(\n    base=None,              # No tissue contrast\n    construct=\"T1map\",\n    technique=\"MDME\",\n    skip_base_detection=True,\n    skip_construct_detection=True,\n    skip_technique_detection=True,\n    directory_type=\"anat\",\n    confidence=0.95,\n)\n</code></pre>"},{"location":"classification/branches/#detection-priority-within-branches","title":"Detection Priority Within Branches","text":"<p>Branches typically use this priority (first match wins):</p> <ol> <li>Unified flags (95% confidence) - DICOM-derived boolean flags</li> <li>Text keywords (85-90% confidence) - Pattern matching in text_search_blob</li> <li>Physics parameters (70-80% confidence) - TR, TE, TI ranges</li> <li>Fallback (60-70% confidence) - Default output type</li> </ol>"},{"location":"classification/branches/#adding-a-new-branch","title":"Adding a New Branch","text":"<p>To add a new classification branch:</p>"},{"location":"classification/branches/#1-create-branch-module","title":"1. Create Branch Module","text":"<p>Create <code>backend/src/classification/branches/new_branch.py</code>:</p> <pre><code>from ..core.context import ClassificationContext\nfrom ..core.evidence import Evidence, EvidenceSource\nfrom .common import BranchResult\n\ndef apply_new_branch_logic(ctx: ClassificationContext) -&gt; BranchResult:\n    \"\"\"Apply branch-specific classification logic.\"\"\"\n    uf = ctx.unified_flags\n    text_blob = (ctx.text_search_blob or \"\").lower()\n\n    # Detection logic here...\n\n    return BranchResult(\n        base=\"...\",\n        construct=\"...\",\n        skip_base_detection=True,\n        skip_construct_detection=True,\n        confidence=0.95,\n        evidence=[...],\n    )\n</code></pre>"},{"location":"classification/branches/#2-define-output-types","title":"2. Define Output Types","text":"<p>Add output type definitions to <code>backend/src/classification/branches/common.py</code>:</p> <pre><code>NEW_BRANCH_OUTPUT_TYPES = {\n    \"output_1\": {\n        \"base\": \"T1w\",\n        \"construct\": \"OutputConstruct\",\n        \"description\": \"Description of output type\",\n    },\n    # ...\n}\n</code></pre>"},{"location":"classification/branches/#3-add-provenance-detection","title":"3. Add Provenance Detection","text":"<p>Update <code>backend/src/classification/detection_yaml/provenance-detection.yaml</code>:</p> <pre><code>provenances:\n  NewProvenance:\n    name: \"NewProvenance\"\n    description: \"Description of the new provenance\"\n    branch: \"new_branch\"\n\n    detection:\n      exclusive: is_new_type\n      keywords:\n        - \"new_keyword\"\n</code></pre>"},{"location":"classification/branches/#4-register-in-pipeline","title":"4. Register in Pipeline","text":"<p>Update <code>backend/src/classification/pipeline.py</code> to call your branch:</p> <pre><code>if provenance == \"NewProvenance\":\n    branch_result = apply_new_branch_logic(ctx)\n</code></pre>"},{"location":"classification/branches/#branch-detection-examples","title":"Branch Detection Examples","text":""},{"location":"classification/branches/#symri-t1-map-vs-synthetic-t1w","title":"SyMRI: T1 Map vs Synthetic T1w","text":"<p>Both contain \"T1\" but have different meanings:</p> Series Description ImageType Branch Output <code>SyMRI T1 Map</code> <code>DERIVED\\PRIMARY\\T1</code> base=NULL, construct=T1map <code>SyMRI T1w</code> <code>DERIVED\\PRIMARY\\T1\\SYNTHETIC</code> base=T1w, construct=SyntheticT1w <p>The <code>SYNTHETIC</code> token is the key differentiator.</p>"},{"location":"classification/branches/#swi-magnitude-vs-processed-swi","title":"SWI: Magnitude vs Processed SWI","text":"<p>Both have magnitude data but different processing:</p> Series Description ImageType Branch Output <code>SWI Magnitude</code> <code>ORIGINAL\\PRIMARY\\M</code> base=SWI, construct=Magnitude <code>SWI Processed</code> <code>ORIGINAL\\PRIMARY\\M\\SWI</code> base=SWI, construct=SWI <p>The <code>SWI</code> token indicates processed output.</p>"},{"location":"classification/branches/#epimix-t1-flair-vs-t2-flair","title":"EPIMix: T1-FLAIR vs T2-FLAIR","text":"<p>Same sequence, different TI:</p> Series Description TI Branch Output <code>EPIMix T1-FLAIR</code> ~600ms base=T1w, modifiers=[FLAIR] <code>EPIMix T2-FLAIR</code> ~2800ms base=T2w, modifiers=[FLAIR] <p>The TI value distinguishes T1-FLAIR (short TI) from T2-FLAIR (long TI).</p>"},{"location":"classification/branches/#see-also","title":"See Also","text":"<ul> <li>Provenance Axis - How provenance is detected</li> <li>Detection Infrastructure - Unified flags and text search</li> <li>SyMRI Branch - Synthetic MRI classification</li> <li>SWI Branch - Susceptibility-weighted imaging</li> <li>EPIMix Branch - Multicontrast EPI</li> </ul>"},{"location":"classification/branches/epimix/","title":"EPIMix/NeuroMix Branch","text":"<p>The EPIMix branch handles classification of EPIMix and NeuroMix multicontrast outputs, rapid brain MRI sequences that produce multiple distinct contrasts from a single ~1-2 minute acquisition.</p>"},{"location":"classification/branches/epimix/#overview","title":"Overview","text":"<p>EPIMix and NeuroMix represent a paradigm shift in brain MRI: instead of acquiring each contrast separately (10-30 min total), these sequences produce all five essential contrasts in a single, motion-robust scan.</p> Aspect Description Provenance <code>EPIMix</code> Classification Branch <code>epimix</code> Source Module <code>backend/src/classification/branches/epimix.py</code> Output Types 12 distinct types Series per Acquisition 5-9 typically Scan Time 55-75s (EPIMix), 80s-4min (NeuroMix)"},{"location":"classification/branches/epimix/#the-physics-multicontrast-epi","title":"The Physics: Multicontrast EPI","text":""},{"location":"classification/branches/epimix/#the-clinical-problem","title":"The Clinical Problem","text":"<p>Standard brain MRI requires multiple sequences:</p> Contrast Typical Acquisition Purpose T1-FLAIR 3-5 min Gray/white matter T2-FLAIR 4-6 min White matter lesions T2-w 2-3 min Edema, inflammation DWI/ADC 2-3 min Stroke, restricted diffusion T2*-w 2-3 min Hemorrhage, iron Total 15-20 min <p>Problems: Patient discomfort, motion artifacts, expensive scanner time, delays in acute stroke.</p>"},{"location":"classification/branches/epimix/#the-epimix-solution","title":"The EPIMix Solution","text":"<p>EPIMix uses 11 modular sequence blocks that can be dynamically combined:</p> <pre><code>flowchart LR\n    subgraph inv[\"Inversion Modules\"]\n        a[\"a) T1-FLAIR inversion\"]\n        b[\"b) T2-FLAIR inversion\"]\n    end\n\n    subgraph prep[\"Preparation Modules\"]\n        c[\"c) SE excitation (90\u00b0)\"]\n        d[\"d) GRE excitation (low flip)\"]\n        e[\"e) SE with 180\u00b0 refocus\"]\n    end\n\n    subgraph diff[\"Diffusion Modules\"]\n        f[\"f) Stejskal-Tanner prep\"]\n        g[\"g) Partial-Fourier EPI readout\"]\n    end\n\n    subgraph readout[\"Readout Modules\"]\n        h[\"h) Full-Fourier EPI readout\"]\n        i[\"i) FLEET calibration\"]\n    end\n\n    subgraph padding[\"Padding Modules\"]\n        j[\"j) Wait for magnetization recovery\"]\n        k[\"k) TR padding\"]\n    end</code></pre>"},{"location":"classification/branches/epimix/#acquisition-timeline-75-seconds","title":"Acquisition Timeline (~75 seconds)","text":"Time Contrast Modules Used 0-17s T1-FLAIR Inversion (a) + SE-EPI (c+h) 17-45s T2-w/DWI/ADC SE-EPI (e+g) + Diffusion (f) 45-47s T2*-w GRE-EPI (d+h) 47-52s FLEET cal. Sequential GRE (i+h) 52-75s T2-FLAIR Inversion (b) + SE-EPI (e+g)"},{"location":"classification/branches/epimix/#why-single-shot-epi","title":"Why Single-Shot EPI?","text":"<p>Each slice is acquired in 30-50 ms, effectively \"freezing\" patient motion:</p> Readout Time per Slice Motion Robustness Multishot FSE 1-3 s Motion \u2192 ghosting PROPELLER 2-4 s Motion-robust but slower Single-shot EPI 30-50 ms Motion frozen <p>Trade-off: EPI suffers from geometric distortion near air-tissue interfaces (skull base, sinuses).</p>"},{"location":"classification/branches/epimix/#neuromix-the-evolution","title":"NeuroMix: The Evolution","text":"<p>NeuroMix addresses EPIMix's main limitation\u2014geometric distortion\u2014by replacing EPI readouts with SSFSE (Single-Shot FSE) for critical contrasts.</p>"},{"location":"classification/branches/epimix/#key-improvements","title":"Key Improvements","text":"Contrast EPIMix Readout NeuroMix Readout T1-FLAIR SE-EPI SE-EPI (unchanged) T2-FLAIR SE-EPI SSFSE (no distortion) T2-w SE-EPI (b=0) SSFSE (no distortion) isoDWI/ADC SE-EPI SE-EPI (unchanged) T2*-w GRE-EPI GRE-EPI (unchanged)"},{"location":"classification/branches/epimix/#neuromix-optional-contrasts","title":"NeuroMix Optional Contrasts","text":"<p>NeuroMix adds three optional high-resolution sequences:</p> Optional Contrast Readout Resolution Time Added T1w 3D-EPI 3D GRE-EPI 1.2\u00d71.2\u00d71.2 mm\u00b3 (isotropic) 22.5s SWI 3D-EPI 3D GRE-EPI 0.8\u00d70.8\u00d72.0 mm\u00b3 28.3s T2w FSE Multishot FSE 0.6\u00d70.6\u00d74.0 mm\u00b3 44.7s <p>Scan time range: 1:20 (minimal) to 4:00 (all options + 20 averages)</p>"},{"location":"classification/branches/epimix/#output-types","title":"Output Types","text":""},{"location":"classification/branches/epimix/#epimix-core-both-epimix-and-neuromix","title":"EPIMix Core (Both EPIMix and NeuroMix)","text":"Output Base Construct Modifiers Technique Description T1-FLAIR T1w - FLAIR SE-EPI CSF-nulled T1w (TI ~580-670ms) isoDWI DWI <code>isoDWI</code> - SE-EPI Averaged 3-direction DWI ADC DWI <code>ADC</code> - SE-EPI Apparent diffusion coefficient T2*-w T2*w - - GRE-EPI Gradient echo (no 180\u00b0 refocus)"},{"location":"classification/branches/epimix/#epimix-only-epi-readouts","title":"EPIMix-Only (EPI readouts)","text":"Output Base Construct Modifiers Technique Description T2-FLAIR (EPI) T2w - FLAIR SE-EPI CSF-nulled T2w, EPI readout T2-w (EPI) T2w - - SE-EPI b=0 from DWI block"},{"location":"classification/branches/epimix/#neuromix-only-ssfsefse-readouts","title":"NeuroMix-Only (SSFSE/FSE readouts)","text":"Output Base Construct Modifiers Technique Description T2-FLAIR (SSFSE) T2w - FLAIR HASTE No EPI distortion T2-w (SSFSE) T2w - - HASTE 1.0\u00d71.0 mm\u00b2 resolution T2-w (FSE) T2w - - TSE High-res multishot (0.6\u00d70.6 mm\u00b2)"},{"location":"classification/branches/epimix/#neuromix-optional-3d-epi","title":"NeuroMix Optional (3D-EPI)","text":"Output Base Construct Modifiers Technique Description T1w 3D-EPI T1w - - EPI Isotropic resolution, reformattable SWI 3D-EPI SWI <code>SWI</code> - EPI High-res susceptibility-weighted"},{"location":"classification/branches/epimix/#detection-strategy","title":"Detection Strategy","text":""},{"location":"classification/branches/epimix/#primary-detection-text-keywords-90-confidence","title":"Primary Detection: Text Keywords (90% confidence)","text":"<p>The EPIMix branch primarily uses text_search_blob pattern matching:</p> <pre><code>flowchart TB\n    start[\"EPIMix Branch Input\"] --&gt; q1{T1 + FLAIR?}\n    q1 --&gt;|Yes| t1flair[\"1. T1-FLAIR\"]\n    q1 --&gt;|No| q2{T2 + FLAIR?}\n\n    q2 --&gt;|Yes| q2a{SSFSE/HASTE?}\n    q2a --&gt;|Yes| t2flairssfse[\"2. T2-FLAIR (SSFSE)\"]\n    q2a --&gt;|No| t2flairepi[\"2. T2-FLAIR (EPI)\"]\n    q2 --&gt;|No| q3{'swi' in text?}\n\n    q3 --&gt;|Yes| swi[\"3. SWI (NeuroMix)\"]\n    q3 --&gt;|No| q4{ADC keyword?}\n\n    q4 --&gt;|Yes| adc[\"4. ADC\"]\n    q4 --&gt;|No| q5{isoDWI keyword?}\n\n    q5 --&gt;|Yes| isodwi[\"5. isoDWI\"]\n    q5 --&gt;|No| q6{T2* indicators?}\n\n    q6 --&gt;|Yes| t2star[\"6. T2*-w\"]\n    q6 --&gt;|No| q7{T1 + 3D-EPI?}\n\n    q7 --&gt;|Yes| t1epi[\"7. T1w 3D-EPI\"]\n    q7 --&gt;|No| q8{T2 without FLAIR?}\n\n    q8 --&gt;|Yes| t2w[\"8. T2-w (EPI/SSFSE/FSE)\"]\n    q8 --&gt;|No| fallback[\"Fallback\"]</code></pre>"},{"location":"classification/branches/epimix/#secondary-detection-physics-fallback-70-75-confidence","title":"Secondary Detection: Physics Fallback (70-75% confidence)","text":"<p>When text keywords are unavailable, physics parameters distinguish outputs:</p> Output TI Range TE Range Logic T2-FLAIR &gt; 2000 ms any Long TI for CSF nulling T1-FLAIR 500-750 ms &lt; 40 ms Short TI, short TE T2*-w 0 &lt; 60 ms No TI, short TE (GRE) T2-w 0 \u2265 60 ms No TI, long TE (ambiguous with DWI) <p>Database analysis (216 EPIMix stacks): - T2-FLAIR: TI 2461-3119ms (avg 2753) - T1-FLAIR: TI 548-671ms (avg 604) - T2*-w: TI=0, TE 16-51ms (avg 34) - T2-w/ADC/isoDWI: TI=0, TE 35-120ms (avg 93)</p>"},{"location":"classification/branches/epimix/#neuromix-vs-epimix-detection","title":"NeuroMix vs EPIMix Detection","text":"<pre><code>def _is_neuromix(text_blob: str) -&gt; bool:\n    \"\"\"NeuroMix-specific keywords: neuromix, mix2, mix3\"\"\"\n    return any(kw in text_blob for kw in [\"neuromix\", \"mix2\", \"mix3\"])\n\ndef _has_ssfse_readout(text_blob: str) -&gt; bool:\n    \"\"\"SSFSE/HASTE indicates NeuroMix readout for T2-FLAIR/T2w\"\"\"\n    return any(kw in text_blob for kw in [\n        \"ssfse\", \"ss-fse\", \"haste\",\n        \"single shot fse\", \"single-shot fse\"\n    ])\n</code></pre>"},{"location":"classification/branches/epimix/#technique-mapping","title":"Technique Mapping","text":"<p>Each output maps to a specific technique from the technique-detection system:</p> Output Type Technique Technique Family T1-FLAIR, T2-FLAIR (EPI), T2-w (EPI), isoDWI, ADC SE-EPI MIXED T2*-w GRE-EPI MIXED T2-FLAIR (SSFSE), T2-w (SSFSE) HASTE TSE (SS-TSE) T2-w (FSE) TSE TSE T1w 3D-EPI, SWI 3D-EPI EPI EPI"},{"location":"classification/branches/epimix/#clinical-significance","title":"Clinical Significance","text":""},{"location":"classification/branches/epimix/#why-epimix-matters","title":"Why EPIMix Matters","text":"Application EPIMix Advantage Acute stroke Complete brain assessment in 1 min Pediatric imaging Reduced sedation need (short scan) Uncooperative patients Motion-robust single-shot acquisition Screening Cost-effective, high throughput Emergency CT-like door-to-scan time with MRI contrast"},{"location":"classification/branches/epimix/#epimix-vs-conventional-imaging","title":"EPIMix vs Conventional Imaging","text":"Aspect EPIMix Conventional Scan time 55-75 s 15-20 min Motion robustness Excellent Variable Resolution 1.3\u00d71.3 mm\u00b2 0.5-1.0 mm\u00b2 Geometric distortion Present (EPI) Minimal SNR Lower Higher"},{"location":"classification/branches/epimix/#neuromix-vs-epimix","title":"NeuroMix vs EPIMix","text":"Aspect EPIMix NeuroMix T2-FLAIR distortion Present Eliminated (SSFSE) T2-w distortion Present Eliminated (SSFSE) Scan time (minimal) 72 s 80 s Optional 3D contrasts No Yes (T1w, SWI) Standalone capability Limited Suitable"},{"location":"classification/branches/epimix/#correct-classification-importance","title":"Correct Classification Importance","text":"Without EPIMix Branch With EPIMix Branch T1-FLAIR \u2192 \"T1-weighted\" T1-FLAIR \u2192 base=T1w, modifiers=[FLAIR], technique=SE-EPI T2-FLAIR \u2192 \"FLAIR\" (generic) T2-FLAIR \u2192 base=T2w, modifiers=[FLAIR], technique=SE-EPI or HASTE isoDWI \u2192 \"DWI\" (generic) isoDWI \u2192 base=DWI, construct=isoDWI T2*-w \u2192 confused with T2-w T2-w \u2192 base=T2w, technique=GRE-EPI"},{"location":"classification/branches/epimix/#configuration-reference","title":"Configuration Reference","text":""},{"location":"classification/branches/epimix/#text-pattern-detection","title":"Text Pattern Detection","text":"Pattern Output Type <code>t1</code> + <code>flair</code> T1-FLAIR <code>t2</code> + <code>flair</code> (no <code>t1</code>) + <code>ssfse</code>/<code>haste</code> T2-FLAIR (SSFSE) <code>t2</code> + <code>flair</code> (no <code>t1</code>) T2-FLAIR (EPI) <code>swi</code> SWI 3D-EPI <code>adc</code> ADC <code>iso dwi</code> or <code>isodwi</code> isoDWI <code>t2star</code> or <code>t2*</code> or <code>gradient echo</code> T2*-w <code>t1</code> + <code>3d-epi</code>/<code>3depi</code> T1w 3D-EPI <code>t2w</code> + <code>ssfse</code> T2w (SSFSE) <code>t2w</code> + <code>fse</code> (not SSFSE) T2w (FSE) <code>t2w</code> (no FLAIR, no SSFSE) T2w (EPI)"},{"location":"classification/branches/epimix/#output-type-mapping","title":"Output Type Mapping","text":"<p>From <code>backend/src/classification/branches/common.py</code>:</p> <pre><code>EPIMIX_OUTPUT_TYPES = {\n    # Shared (EPIMix + NeuroMix)\n    \"t1_flair\": {\n        \"base\": \"T1w\",\n        \"construct\": \"\",\n        \"modifiers\": [\"FLAIR\"],\n        \"technique\": \"SE-EPI\",\n        \"directory_type\": \"anat\",\n    },\n    \"t2star\": {\n        \"base\": \"T2*w\",\n        \"construct\": \"\",\n        \"modifiers\": None,\n        \"technique\": \"GRE-EPI\",\n        \"directory_type\": \"anat\",\n    },\n    \"iso_dwi\": {\n        \"base\": \"DWI\",\n        \"construct\": \"isoDWI\",\n        \"modifiers\": None,\n        \"technique\": \"SE-EPI\",\n        \"directory_type\": \"dwi\",\n    },\n    \"adc\": {\n        \"base\": \"DWI\",\n        \"construct\": \"ADC\",\n        \"modifiers\": None,\n        \"technique\": \"SE-EPI\",\n        \"directory_type\": \"dwi\",\n    },\n\n    # EPIMix-only (EPI readouts)\n    \"t2_flair_epi\": {\n        \"base\": \"T2w\",\n        \"modifiers\": [\"FLAIR\"],\n        \"technique\": \"SE-EPI\",\n    },\n    \"t2w_epi\": {\n        \"base\": \"T2w\",\n        \"technique\": \"SE-EPI\",\n    },\n\n    # NeuroMix-only (SSFSE readouts)\n    \"t2_flair_ssfse\": {\n        \"base\": \"T2w\",\n        \"modifiers\": [\"FLAIR\"],\n        \"technique\": \"HASTE\",  # SSFSE = HASTE\n    },\n    \"t2w_ssfse\": {\n        \"base\": \"T2w\",\n        \"technique\": \"HASTE\",\n    },\n    \"t2w_fse\": {\n        \"base\": \"T2w\",\n        \"technique\": \"TSE\",\n    },\n\n    # NeuroMix optional (3D-EPI)\n    \"t1w_3depi\": {\n        \"base\": \"T1w\",\n        \"technique\": \"EPI\",\n    },\n    \"swi_3depi\": {\n        \"base\": \"SWI\",\n        \"construct\": \"SWI\",\n        \"technique\": \"EPI\",\n    },\n}\n</code></pre>"},{"location":"classification/branches/epimix/#examples","title":"Examples","text":""},{"location":"classification/branches/epimix/#example-1-epimix-t1-flair","title":"Example 1: EPIMix T1-FLAIR","text":"<p>DICOM Fields: <pre><code>SeriesDescription: EPIMix T1 FLAIR\nScanningSequence: IR\\SE\\EP\nInversionTime: 580\nEchoTime: 17.9\n</code></pre></p> <p>Classification: <pre><code>base = \"T1w\"\nconstruct = \"\"\nmodifiers = [\"FLAIR\"]\ntechnique = \"SE-EPI\"\ndirectory_type = \"anat\"\n</code></pre></p>"},{"location":"classification/branches/epimix/#example-2-epimix-t2-flair","title":"Example 2: EPIMix T2-FLAIR","text":"<p>DICOM Fields: <pre><code>SeriesDescription: EPIMix T2 FLAIR\nScanningSequence: IR\\SE\\EP\nInversionTime: 2750\nEchoTime: 120\n</code></pre></p> <p>Classification: <pre><code>base = \"T2w\"\nconstruct = \"\"\nmodifiers = [\"FLAIR\"]\ntechnique = \"SE-EPI\"\ndirectory_type = \"anat\"\n</code></pre></p>"},{"location":"classification/branches/epimix/#example-3-neuromix-t2-flair-ssfse","title":"Example 3: NeuroMix T2-FLAIR (SSFSE)","text":"<p>DICOM Fields: <pre><code>SeriesDescription: NeuroMix T2-FLAIR SSFSE\nScanningSequence: IR\\SE\nInversionTime: 2900\nEchoTime: 108.8\n</code></pre></p> <p>Classification: <pre><code>base = \"T2w\"\nconstruct = \"\"\nmodifiers = [\"FLAIR\"]\ntechnique = \"HASTE\"       # SSFSE \u2192 HASTE in technique taxonomy\ndirectory_type = \"anat\"\n</code></pre></p> <p>Note: No EPI distortion compared to EPIMix T2-FLAIR.</p>"},{"location":"classification/branches/epimix/#example-4-epimix-isodwi","title":"Example 4: EPIMix isoDWI","text":"<p>DICOM Fields: <pre><code>SeriesDescription: EPIMix isoDWI\nScanningSequence: SE\\EP\nbValue: 1000\n</code></pre></p> <p>Classification: <pre><code>base = \"DWI\"\nconstruct = \"isoDWI\"\nmodifiers = None\ntechnique = \"SE-EPI\"\ndirectory_type = \"dwi\"\n</code></pre></p>"},{"location":"classification/branches/epimix/#example-5-epimix-t2-w","title":"Example 5: EPIMix T2*-w","text":"<p>DICOM Fields: <pre><code>SeriesDescription: EPIMix T2*\nScanningSequence: GR\\EP\nEchoTime: 30\n</code></pre></p> <p>Classification: <pre><code>base = \"T2*w\"\nconstruct = \"\"\nmodifiers = None\ntechnique = \"GRE-EPI\"\ndirectory_type = \"anat\"\n</code></pre></p> <p>Note: GRE (gradient echo) readout, no 180\u00b0 refocusing pulse.</p>"},{"location":"classification/branches/epimix/#example-6-neuromix-swi-3d-epi","title":"Example 6: NeuroMix SWI 3D-EPI","text":"<p>DICOM Fields: <pre><code>SeriesDescription: NeuroMix SWI 3D-EPI\nScanningSequence: GR\\EP\nImageType: ORIGINAL\\PRIMARY\\M\\SWI\n</code></pre></p> <p>Classification: <pre><code>base = \"SWI\"\nconstruct = \"SWI\"\nmodifiers = None\ntechnique = \"EPI\"\ndirectory_type = \"anat\"\n</code></pre></p>"},{"location":"classification/branches/epimix/#troubleshooting","title":"Troubleshooting","text":""},{"location":"classification/branches/epimix/#common-issues","title":"Common Issues","text":"<p>Issue: T1-FLAIR and T2-FLAIR confused - Cause: Both contain \"FLAIR\" keyword - Solution: TI range distinguishes them (T1: 500-750ms, T2: &gt;2000ms)</p> <p>Issue: T2-w classified as DWI - Cause: Both from same SE-EPI block, identical physics - Solution: Text keyword detection preferred; physics fallback is ambiguous</p> <p>Issue: NeuroMix SSFSE detected as EPI - Cause: Missing SSFSE/HASTE keyword - Solution: Check text_search_blob for SSFSE indicators</p> <p>Issue: SWI 3D-EPI routed to SWI branch - Cause: Provenance detected as SWIRecon instead of EPIMix - Solution: EPIMix provenance should take precedence for NeuroMix outputs</p> <p>Issue: Physics fallback gives low confidence - Cause: Text keywords unavailable, TI/TE values ambiguous - Solution: This is expected; physics detection has 70-75% confidence</p>"},{"location":"classification/branches/epimix/#research-context","title":"Research Context","text":"<p>EPIMix and NeuroMix were developed at Karolinska Institutet, Stockholm, Sweden:</p> <ul> <li>EPIMix (2018): Skare et al., \"A 1-minute full brain MR exam using a multicontrast EPI sequence.\" Magn Reson Med 79:3045-3054.</li> <li>NeuroMix (2022): Sprenger et al., \"NeuroMix\u2014A single-scan brain exam.\" Magn Reson Med 87:2178-2193.</li> </ul> <p>Key contributors: Stefan Skare, Tim Sprenger, Ola Norbeck, Henric Ryd\u00e9n, Enrico Avventi.</p>"},{"location":"classification/branches/epimix/#see-also","title":"See Also","text":"<ul> <li>Branches Overview - Why branches exist</li> <li>Provenance Axis - EPIMix provenance detection</li> <li>Technique Axis - SE-EPI, GRE-EPI, HASTE techniques</li> <li>SWI Branch - For standalone SWI classification</li> </ul>"},{"location":"classification/branches/swi/","title":"SWI Branch","text":"<p>The SWI branch handles classification of Susceptibility-Weighted Imaging outputs, a post-processed modality that produces multiple distinct series from a single acquisition.</p>"},{"location":"classification/branches/swi/#overview","title":"Overview","text":"<p>Unlike conventional T1 or T2-weighted imaging that produces a single output, SWI is a computational reconstruction that synthesizes magnitude (anatomy) and phase (susceptibility) data into multiple diagnostic outputs.</p> Aspect Description Provenance <code>SWIRecon</code> Classification Branch <code>swi</code> Source Module <code>backend/src/classification/branches/swi.py</code> Output Types 6 distinct types Series per Acquisition 2-6 typically"},{"location":"classification/branches/swi/#the-physics-susceptibility-contrast","title":"The Physics: Susceptibility Contrast","text":""},{"location":"classification/branches/swi/#why-swi-is-different","title":"Why SWI is Different","text":"<p>Traditional MRI contrast (T1, T2) arises from proton relaxation properties. SWI contrast arises from magnetic susceptibility\u2014how tissues distort the local magnetic field.</p> <pre><code>flowchart LR\n    subgraph diamagnetic[\"Diamagnetic (\u03c7 &lt; 0)\"]\n        d1[\"Calcium, Water, Soft tissue\"]\n        d2[\"\u2192 Lower local field\"]\n        d3[\"\u2192 Negative phase shift\"]\n    end\n\n    subgraph paramagnetic[\"Paramagnetic (\u03c7 &gt; 0)\"]\n        p1[\"Deoxyhemoglobin (blood)\"]\n        p2[\"Hemosiderin (old blood)\"]\n        p3[\"Ferritin (iron storage)\"]\n        p4[\"\u2192 Higher local field\"]\n        p5[\"\u2192 Positive phase shift\"]\n    end</code></pre>"},{"location":"classification/branches/swi/#key-insight-phase-differentiates-iron-from-calcium","title":"Key Insight: Phase Differentiates Iron from Calcium","text":"<p>On magnitude images, both iron (paramagnetic) and calcium (diamagnetic) appear dark due to signal dephasing. Only phase images can distinguish them:</p> Substance Magnitude Phase (Right-Handed) Phase (Left-Handed) Iron/Blood Dark (blooming) Bright (+) Dark (-) Calcium Dark (blooming) Dark (-) Bright (+)"},{"location":"classification/branches/swi/#why-gre-not-spin-echo","title":"Why GRE, Not Spin Echo","text":"<p>SWI must use Gradient Echo (GRE) acquisition:</p> <ul> <li>Spin Echo: The 180\u00b0 refocusing pulse nullifies susceptibility-induced phase shifts</li> <li>Gradient Echo: No refocusing pulse, allowing T2* effects to accumulate</li> </ul> <p>This is why all SWI outputs are inherently T2*-weighted.</p>"},{"location":"classification/branches/swi/#the-four-series-output","title":"The Four-Series Output","text":"<p>A single SWI acquisition produces multiple series, each representing a distinct processing stage:</p>"},{"location":"classification/branches/swi/#processing-pipeline","title":"Processing Pipeline","text":"<pre><code>flowchart TB\n    raw[\"Raw k-space Data (Complex)\"]\n\n    raw --&gt; mag[\"Series 1: Magnitude&lt;br/&gt;|S| = \u221a(R\u00b2 + I\u00b2)&lt;br/&gt;T2*-weighted anatomy\"]\n    raw --&gt; phase[\"Series 2: Phase&lt;br/&gt;High-pass filtered&lt;br/&gt;Removes background field\"]\n\n    mag --&gt; mask\n    phase --&gt; mask[\"Phase Mask Creation&lt;br/&gt;Negative phase \u2192 0-1 range&lt;br/&gt;Positive phase \u2192 1\"]\n\n    mask --&gt; swi[\"Series 3: SWI (Processed)&lt;br/&gt;I_SWI = I_Mag \u00d7 [Mask]^n (n=4)&lt;br/&gt;Extreme vein/microbleed sensitivity\"]\n\n    swi --&gt; minip[\"Series 4: MinIP (Venogram)&lt;br/&gt;Minimum across slab of slices&lt;br/&gt;Shows 3D venous continuity\"]</code></pre>"},{"location":"classification/branches/swi/#why-each-series-matters","title":"Why Each Series Matters","text":"Series Purpose Clinical Use Magnitude Anatomical reference Localization, size estimation Phase Iron vs calcium differentiation Definitive lesion characterization SWI Maximum sensitivity Microbleed detection, tumor characterization MinIP 3D vascular visualization DVA evaluation, venography"},{"location":"classification/branches/swi/#output-types","title":"Output Types","text":"<p>All SWI outputs share <code>base=SWI</code> to indicate the contrast type. The construct specifies the output:</p> Output Base Construct Description Magnitude SWI <code>Magnitude</code> Source T2*-weighted image Phase SWI <code>Phase</code> Filtered phase map SWI SWI <code>SWI</code> Processed (Mag \u00d7 Phase mask^4) MinIP SWI <code>MinIP</code> Minimum intensity projection MIP SWI <code>MIP</code> Maximum intensity projection QSM SWI <code>QSM</code> Quantitative susceptibility map (ppm)"},{"location":"classification/branches/swi/#detection-strategy","title":"Detection Strategy","text":""},{"location":"classification/branches/swi/#priority-order","title":"Priority Order","text":"<p>The SWI branch uses strict priority (first match wins):</p> <pre><code>flowchart TB\n    start[\"SWI Branch Input\"] --&gt; q1{has_qsm OR&lt;br/&gt;'qsm' in text?}\n    q1 --&gt;|Yes| qsm[\"1. QSM&lt;br/&gt;(Quantitative)\"]\n    q1 --&gt;|No| q2{is_minip OR&lt;br/&gt;'minip' in text?}\n\n    q2 --&gt;|Yes| minip[\"2. MinIP&lt;br/&gt;(Venogram)\"]\n    q2 --&gt;|No| q3{is_mip OR&lt;br/&gt;'mip' in text?}\n\n    q3 --&gt;|Yes| mip[\"3. MIP\"]\n    q3 --&gt;|No| q4{has_phase&lt;br/&gt;without magnitude?}\n\n    q4 --&gt;|Yes| phase[\"4. Phase\"]\n    q4 --&gt;|No| q5{has_swi token&lt;br/&gt;in ImageType?}\n\n    q5 --&gt;|Yes| swi[\"5. SWI Processed\"]\n    q5 --&gt;|No| q6{is_projection?}\n\n    q6 --&gt;|Yes| swi2[\"5.5. SWI (projection)\"]\n    q6 --&gt;|No| q7{has_magnitude?}\n\n    q7 --&gt;|Yes| mag[\"6. Magnitude\"]\n    q7 --&gt;|No| fallback[\"7. Fallback \u2192 SWI\"]</code></pre>"},{"location":"classification/branches/swi/#key-detection-insight","title":"Key Detection Insight","text":"<p>The SWI token in ImageType is the critical differentiator between source magnitude and processed SWI:</p> ImageType Detection Output <code>ORIGINAL\\PRIMARY\\M</code> has_magnitude, no has_swi Magnitude <code>ORIGINAL\\PRIMARY\\M\\SWI</code> has_magnitude AND has_swi SWI <p>Both contain the M (magnitude) token, but only processed SWI has the SWI token.</p>"},{"location":"classification/branches/swi/#technique-detection","title":"Technique Detection","text":"<p>SWI is a processing method, not a technique. The actual acquisition is either GRE or EPI:</p>"},{"location":"classification/branches/swi/#technique-priority","title":"Technique Priority","text":"<pre><code>if has_epi:\n    technique = \"EPI\"       # Fast SWI (1-2 min)\nelif has_gre:\n    technique = \"GRE\"       # Standard SWI (4-6 min)\nelif \"epi\" in text_blob or \"3depi\" in text_blob:\n    technique = \"EPI\"       # Text fallback for GE\nelse:\n    technique = \"GRE\"       # Default\n</code></pre>"},{"location":"classification/branches/swi/#acquisition-variants","title":"Acquisition Variants","text":"Variant Physics Time Trade-offs Standard GRE 3D Flow-compensated GRE 4-6 min Highest resolution, motion sensitive EPI-SWI Echo Planar Imaging 1-2 min Fast, geometric distortion SWAN Multi-echo GRE 4-5 min Higher SNR, better skull base coverage"},{"location":"classification/branches/swi/#quantitative-susceptibility-mapping-qsm","title":"Quantitative Susceptibility Mapping (QSM)","text":""},{"location":"classification/branches/swi/#from-qualitative-to-quantitative","title":"From Qualitative to Quantitative","text":"<p>SWI produces qualitative contrast (dark = susceptibility source). QSM produces quantitative measurements in parts per million (ppm).</p> Aspect SWI QSM Output Contrast image Susceptibility map (ppm) Blooming Artifacts appear larger True geometry Orientation Angle-dependent Angle-independent Iron/Calcium Both appear dark Iron=bright, Calcium=dark"},{"location":"classification/branches/swi/#qsm-processing-pipeline","title":"QSM Processing Pipeline","text":"<p>QSM uses the same raw data as SWI but with additional processing:</p> <ol> <li>Phase Unwrapping - Remove 2\u03c0 aliasing</li> <li>Background Field Removal - Remove air-tissue interface effects</li> <li>Dipole Inversion - Solve inverse problem: \u0394B = D \u2297 \u03c7</li> </ol>"},{"location":"classification/branches/swi/#detection","title":"Detection","text":"<p>QSM is detected with highest priority because it represents the most specific output type:</p> <pre><code>if uf.get(\"has_qsm\") or \"qsm\" in text_blob:\n    return BranchResult(\n        base=\"SWI\",\n        construct=\"QSM\",\n        confidence=0.95,\n    )\n</code></pre>"},{"location":"classification/branches/swi/#imagetype-token-patterns","title":"ImageType Token Patterns","text":""},{"location":"classification/branches/swi/#standard-swi-tokens","title":"Standard SWI Tokens","text":"Pattern Meaning Output <code>ORIGINAL\\PRIMARY\\M</code> Magnitude only Magnitude <code>ORIGINAL\\PRIMARY\\M\\SWI</code> SWI token present SWI <code>ORIGINAL\\PRIMARY\\P</code> Phase Phase <code>ORIGINAL\\PRIMARY\\PHASE MAP</code> Phase map Phase <code>DERIVED\\PRIMARY\\MINIP</code> Minimum IP MinIP <code>DERIVED\\PRIMARY\\MIP</code> Maximum IP MIP <code>DERIVED\\PRIMARY\\QSM</code> Quantitative susceptibility QSM"},{"location":"classification/branches/swi/#vendor-variations","title":"Vendor Variations","text":"Vendor Sequence Names Notes Siemens SWI, fl3d_swi Standard implementation GE SWAN, 3DEPIks Multi-echo (SWAN), EPI variants Philips SWI, PRESTO Various implementations"},{"location":"classification/branches/swi/#clinical-significance","title":"Clinical Significance","text":""},{"location":"classification/branches/swi/#why-swi-matters","title":"Why SWI Matters","text":"Application SWI Advantage Microbleeds 6x more sensitive than T2*-GRE Trauma Detects diffuse axonal injury Tumors Visualizes neovascularization, calcification Stroke Susceptibility vessel sign, penumbra Parkinson's \"Swallow tail\" sign in substantia nigra MS Central vein sign in lesions"},{"location":"classification/branches/swi/#correct-classification-importance","title":"Correct Classification Importance","text":"Without SWI Branch With SWI Branch Magnitude \u2192 \"T2*-weighted\" Magnitude \u2192 base=SWI, construct=Magnitude Phase \u2192 unknown Phase \u2192 base=SWI, construct=Phase Processed SWI \u2192 confused with magnitude SWI \u2192 base=SWI, construct=SWI MinIP \u2192 \"MIP\" MinIP \u2192 base=SWI, construct=MinIP QSM \u2192 unknown QSM \u2192 base=SWI, construct=QSM"},{"location":"classification/branches/swi/#configuration-reference","title":"Configuration Reference","text":""},{"location":"classification/branches/swi/#unified-flags-used","title":"Unified Flags Used","text":"Flag Description <code>has_qsm</code> QSM token in ImageType <code>is_minip</code> MinIP/MNIP token <code>is_mip</code> MIP token (excluding MinIP) <code>has_phase</code> Phase (P, PHASE, PHASE MAP) <code>has_swi</code> SWI token in ImageType <code>has_magnitude</code> Magnitude (M, M_FFE, etc.) <code>is_projection</code> PROJECTION IMAGE token <code>has_epi</code> EPI readout <code>has_gre</code> GRE readout"},{"location":"classification/branches/swi/#output-type-mapping","title":"Output Type Mapping","text":"<p>From <code>backend/src/classification/branches/common.py</code>:</p> <pre><code>SWI_OUTPUT_TYPES = {\n    \"magnitude\": {\n        \"base\": \"SWI\",\n        \"construct\": \"Magnitude\",\n        \"description\": \"SWI magnitude source image (T2*-weighted)\",\n    },\n    \"phase\": {\n        \"base\": \"SWI\",\n        \"construct\": \"Phase\",\n        \"description\": \"SWI phase map (iron/calcium differentiation)\",\n    },\n    \"swi\": {\n        \"base\": \"SWI\",\n        \"construct\": \"SWI\",\n        \"description\": \"Processed SWI image (magnitude \u00d7 phase mask)\",\n    },\n    \"minip\": {\n        \"base\": \"SWI\",\n        \"construct\": \"MinIP\",\n        \"description\": \"Minimum intensity projection (venogram)\",\n    },\n    \"mip\": {\n        \"base\": \"SWI\",\n        \"construct\": \"MIP\",\n        \"description\": \"Maximum intensity projection\",\n    },\n    \"qsm\": {\n        \"base\": \"SWI\",\n        \"construct\": \"QSM\",\n        \"description\": \"Quantitative susceptibility map (ppm)\",\n    },\n}\n</code></pre>"},{"location":"classification/branches/swi/#examples","title":"Examples","text":""},{"location":"classification/branches/swi/#example-1-source-magnitude","title":"Example 1: Source Magnitude","text":"<p>DICOM Fields: <pre><code>ImageType: ORIGINAL\\PRIMARY\\M\\ND\nSeriesDescription: SWI Magnitude\nScanningSequence: GR\n</code></pre></p> <p>Classification: <pre><code>base = \"SWI\"\nconstruct = \"Magnitude\"\ntechnique = \"GRE\"\ndirectory_type = \"anat\"\n</code></pre></p>"},{"location":"classification/branches/swi/#example-2-processed-swi","title":"Example 2: Processed SWI","text":"<p>DICOM Fields: <pre><code>ImageType: ORIGINAL\\PRIMARY\\M\\SWI\\ND\nSeriesDescription: SWI\nScanningSequence: GR\n</code></pre></p> <p>Classification: <pre><code>base = \"SWI\"\nconstruct = \"SWI\"\ntechnique = \"GRE\"\ndirectory_type = \"anat\"\n</code></pre></p> <p>Note: Both examples have magnitude (M) token, but the SWI token differentiates them.</p>"},{"location":"classification/branches/swi/#example-3-phase-map","title":"Example 3: Phase Map","text":"<p>DICOM Fields: <pre><code>ImageType: ORIGINAL\\PRIMARY\\P\\ND\nSeriesDescription: SWI Phase\n</code></pre></p> <p>Classification: <pre><code>base = \"SWI\"\nconstruct = \"Phase\"\ntechnique = \"GRE\"\ndirectory_type = \"anat\"\n</code></pre></p>"},{"location":"classification/branches/swi/#example-4-minip-venogram","title":"Example 4: MinIP (Venogram)","text":"<p>DICOM Fields: <pre><code>ImageType: DERIVED\\SECONDARY\\MINIP\nSeriesDescription: SWI mIP\n</code></pre></p> <p>Classification: <pre><code>base = \"SWI\"\nconstruct = \"MinIP\"\ntechnique = \"GRE\"\ndirectory_type = \"anat\"\n</code></pre></p>"},{"location":"classification/branches/swi/#example-5-qsm","title":"Example 5: QSM","text":"<p>DICOM Fields: <pre><code>ImageType: DERIVED\\PRIMARY\\QSM\nSeriesDescription: QSM\n</code></pre></p> <p>Classification: <pre><code>base = \"SWI\"\nconstruct = \"QSM\"\ntechnique = \"GRE\"\ndirectory_type = \"anat\"\n</code></pre></p>"},{"location":"classification/branches/swi/#example-6-epi-swi","title":"Example 6: EPI-SWI","text":"<p>DICOM Fields: <pre><code>ImageType: ORIGINAL\\PRIMARY\\M\\SWI\nSeriesDescription: 3DEPIks SWI\nScanningSequence: EP\n</code></pre></p> <p>Classification: <pre><code>base = \"SWI\"\nconstruct = \"SWI\"\ntechnique = \"EPI\"      # Detected from has_epi flag\ndirectory_type = \"anat\"\n</code></pre></p>"},{"location":"classification/branches/swi/#troubleshooting","title":"Troubleshooting","text":""},{"location":"classification/branches/swi/#common-issues","title":"Common Issues","text":"<p>Issue: Magnitude classified as SWI - Cause: Both have M token; branch checking SWI token last - Solution: Detection priority ensures has_swi is checked before fallback to Magnitude</p> <p>Issue: MinIP classified as MIP - Cause: Both contain \"mip\" substring - Solution: MinIP is checked first with explicit \"minip\" pattern</p> <p>Issue: Phase not detected - Cause: has_phase AND has_magnitude both true - Solution: Check <code>has_phase AND NOT has_magnitude</code></p> <p>Issue: EPI-SWI detected as GRE - Cause: GE uses \"RM\" in ScanningSequence, not \"EP\" - Solution: Text fallback checks for \"epi\" or \"3depi\" in text_search_blob</p> <p>Issue: Unknown SWI output - Cause: No matching tokens or keywords - Solution: Falls back to SWI (construct=\"SWI\") with lower confidence</p>"},{"location":"classification/branches/swi/#see-also","title":"See Also","text":"<ul> <li>Branches Overview - Why branches exist</li> <li>Provenance Axis - SWIRecon provenance detection</li> <li>Construct Axis - Construct definitions</li> <li>Base Axis - SWI as base contrast</li> </ul>"},{"location":"classification/branches/symri/","title":"SyMRI Branch","text":"<p>The SyMRI branch handles classification of Synthetic MRI outputs from SyMRI, MAGiC (GE), MDME, and QALAS sequences.</p>"},{"location":"classification/branches/symri/#overview","title":"Overview","text":"<p>Synthetic MRI represents a paradigm shift from qualitative contrast-weighted imaging to quantitative tissue property measurement. A single acquisition produces multiple output types, each requiring specialized classification.</p> Aspect Description Provenance <code>SyMRI</code> Classification Branch <code>symri</code> Source Module <code>backend/src/classification/branches/symri.py</code> Output Types 17+ distinct types Series per Acquisition 1-20+ (highly variable)"},{"location":"classification/branches/symri/#the-physics-multi-dynamic-multi-echo-mdme","title":"The Physics: Multi-Dynamic Multi-Echo (MDME)","text":""},{"location":"classification/branches/symri/#how-symri-works","title":"How SyMRI Works","text":"<p>Unlike conventional MRI that produces a single contrast-weighted image, SyMRI uses the MDME (Multi-Dynamic Multi-Echo) sequence to sample tissue signal evolution:</p> <pre><code>flowchart TB\n    subgraph acquisition[\"MDME Acquisition\"]\n        acq1[\"4 Saturation Delays \u00d7 2 Echo Times = 8 Volumes\"]\n        acq2[\"Dynamic 1 (TI ~100ms) \u2192 Echo 1 + Echo 2\"]\n        acq3[\"Dynamic 2 (TI ~600ms) \u2192 Echo 1 + Echo 2\"]\n        acq4[\"Dynamic 3 (TI ~1500ms) \u2192 Echo 1 + Echo 2\"]\n        acq5[\"Dynamic 4 (TI ~4000ms) \u2192 Echo 1 + Echo 2\"]\n        acq6[\"Each volume: Magnitude + Phase = 16 potential series\"]\n    end\n\n    subgraph quant[\"Quantification Algorithm\"]\n        q1[\"Solves Bloch equations for T1, T2, PD at each voxel\"]\n    end\n\n    subgraph outputs[\"Outputs\"]\n        o1[\"Quantitative Maps (T1map, T2map, PDmap)\"]\n        o2[\"Synthetic Weighted Images (any contrast!)\"]\n        o3[\"Derived Maps (Myelin, B1, R1, R2)\"]\n    end\n\n    acquisition --&gt; quant --&gt; outputs</code></pre>"},{"location":"classification/branches/symri/#why-series-count-varies","title":"Why Series Count Varies","text":"<p>A single SyMRI acquisition can produce 1 to 20+ DICOM series:</p> Export Configuration Series Count Contents Single synthetic contrast 1 Just T2w or FLAIR Magnitude + Phase pairs 2 Complex data for each output Quantitative maps only 3-5 T1map, T2map, PDmap, B1map Full raw data 8 4 dynamics \u00d7 2 echoes Full raw + Phase 16 All magnitude and phase Clinical protocol 12+ Maps + multiple synthetic contrasts <p>This variability is deterministic, not random - it depends on the export configuration.</p>"},{"location":"classification/branches/symri/#output-types","title":"Output Types","text":""},{"location":"classification/branches/symri/#critical-distinction-basenull-vs-baset1wt2w","title":"Critical Distinction: base=NULL vs base=T1w/T2w","text":"<p>The SyMRI branch understands a crucial physics distinction:</p> <ul> <li>Quantitative maps have NO tissue contrast \u2192 <code>base=NULL</code></li> <li>A T1 map pixel value of \"800\" means \"800 milliseconds\"</li> <li>This is a measurement, not an image contrast</li> <li> <p>Cannot be meaningfully labeled as \"T1-weighted\"</p> </li> <li> <p>Synthetic weighted images HAVE tissue contrast \u2192 <code>base=T1w/T2w/PDw</code></p> </li> <li>Simulate what a real acquisition would look like</li> <li>Get proper base contrast labels</li> </ul>"},{"location":"classification/branches/symri/#raw-source-data","title":"Raw Source Data","text":"<p>The MDME/QALAS acquisition produces complex (magnitude + phase) data:</p> Output Base Construct Description Magnitude NULL <code>Magnitude</code> Raw magnitude source (4\u00d72 volumes) Phase NULL <code>Phase</code> Raw phase source (for T1 polarity detection) <p>Detection: - Magnitude: <code>has_magnitude</code> flag, M_SE in ImageType - Phase: <code>has_phase</code> flag (without <code>has_magnitude</code>)</p>"},{"location":"classification/branches/symri/#quantitative-maps","title":"Quantitative Maps","text":"<p>Parametric maps with physical units - NO tissue contrast:</p> Output Base Construct Units Description T1 Map NULL <code>T1map</code> ms Longitudinal relaxation time T2 Map NULL <code>T2map</code> ms Transverse relaxation time PD Map NULL <code>PDmap</code> % Proton density R1 Map NULL <code>R1map</code> 1/s 1/T1 rate R2 Map NULL <code>R2map</code> 1/s 1/T2 rate B1 Map NULL <code>B1map</code> % RF field inhomogeneity MultiQmap NULL <code>MultiQmap</code> - GE MAGiC bundled T1/T2/PD Myelin Map NULL <code>MyelinMap</code> % Myelin water fraction <p>Detection priority: 1. Unified flags: <code>has_t1_map</code>, <code>has_t2_map</code>, <code>has_pd_map</code>, <code>has_myelin</code> 2. QMAP tokens: <code>has_qmap_t1</code>, <code>has_qmap_t2</code>, <code>has_qmap_pd</code> 3. Text keywords: \"t1 map\", \"t2map\", \"myelin\"</p>"},{"location":"classification/branches/symri/#synthetic-weighted-images","title":"Synthetic Weighted Images","text":"<p>Simulated contrast-weighted images - HAVE tissue contrast:</p> Output Base Construct Modifiers Description Synthetic T1w T1w <code>SyntheticT1w</code> - Synthetic T1-weighted Synthetic T2w T2w <code>SyntheticT2w</code> - Synthetic T2-weighted Synthetic PDw PDw <code>SyntheticPDw</code> - Synthetic PD-weighted <p>Detection: - Unified flags: <code>has_t1_synthetic</code>, <code>has_t2_synthetic</code>, <code>has_pd_synthetic</code> - ImageType pattern: <code>T1\\SYNTHETIC</code> or <code>T1W_SYNTHETIC</code></p>"},{"location":"classification/branches/symri/#synthetic-ir-contrasts","title":"Synthetic IR Contrasts","text":"<p>Synthetic versions of inversion recovery sequences:</p> Output Base Construct Modifiers Description Synthetic FLAIR T2w <code>SyntheticFLAIR</code> FLAIR CSF-nulled T2w Synthetic DIR T2w <code>SyntheticDIR</code> DIR Double inversion recovery Synthetic PSIR T1w <code>SyntheticPSIR</code> PSIR Phase-sensitive IR Synthetic STIR T2w <code>SyntheticSTIR</code> STIR Fat-suppressed <p>Detection: - Unified flags: <code>has_flair_synthetic</code>, <code>has_dir_synthetic</code>, <code>has_psir_synthetic</code> - Text keywords: \"flair\" + \"synthetic\"</p>"},{"location":"classification/branches/symri/#detection-strategy","title":"Detection Strategy","text":""},{"location":"classification/branches/symri/#priority-order","title":"Priority Order","text":"<p>The SyMRI branch uses a strict detection priority (first match wins):</p> <pre><code>flowchart TB\n    start[\"SyMRI Branch Input\"] --&gt; q1{Myelin indicators?}\n    q1 --&gt;|Yes| myelin[\"1. Myelin Map\"]\n    q1 --&gt;|No| q2{MultiQmap?}\n\n    q2 --&gt;|Yes| multi[\"2. MultiQmap\"]\n    q2 --&gt;|No| q3{Quantitative map?}\n\n    q3 --&gt;|Yes| qmaps[\"3. T1map / T2map / PDmap&lt;br/&gt;R1map / R2map / B1map\"]\n    q3 --&gt;|No| q4{Synthetic IR?}\n\n    q4 --&gt;|Yes| ir[\"4. FLAIR / DIR / PSIR / STIR\"]\n    q4 --&gt;|No| q5{Synthetic weighted?}\n\n    q5 --&gt;|Yes| synth[\"5. SyntheticT1w / T2w / PDw\"]\n    q5 --&gt;|No| q6{Phase only?}\n\n    q6 --&gt;|Yes| phase[\"6. Raw Phase\"]\n    q6 --&gt;|No| q7{Magnitude?}\n\n    q7 --&gt;|Yes| mag[\"7. Raw Magnitude\"]\n    q7 --&gt;|No| fallback[\"8. Fallback \u2192 Magnitude\"]</code></pre>"},{"location":"classification/branches/symri/#why-myelin-is-first","title":"Why Myelin is First","text":"<p>Myelin maps often contain the T1 token (e.g., <code>DERIVED\\PRIMARY\\MYC\\T1</code>). If T1 map detection ran first, myelin maps would be misclassified as T1 maps.</p>"},{"location":"classification/branches/symri/#technique-detection","title":"Technique Detection","text":"<p>SyMRI determines the acquisition technique:</p> Technique Detection Description QALAS <code>is_qalas</code> flag OR <code>qalas</code> in sequence name 3D quantitative acquisition MDME Default 2D multi-dynamic multi-echo"},{"location":"classification/branches/symri/#imagetype-token-patterns","title":"ImageType Token Patterns","text":""},{"location":"classification/branches/symri/#quantitative-map-tokens","title":"Quantitative Map Tokens","text":"Pattern Meaning Output <code>DERIVED\\PRIMARY\\T1</code> T1 map (no SYNTHETIC) T1map <code>DERIVED\\PRIMARY\\T2</code> T2 map T2map <code>DERIVED\\PRIMARY\\PD</code> PD map PDmap <code>DERIVED\\PRIMARY\\QMAP\\T1</code> Explicit qmap T1 T1map <code>DERIVED\\PRIMARY\\MYC</code> Myelin fraction MyelinMap <code>DERIVED\\PRIMARY\\MULTI_QMAP\\T1\\T2\\PD</code> GE bundled maps MultiQmap"},{"location":"classification/branches/symri/#synthetic-weighted-tokens","title":"Synthetic Weighted Tokens","text":"Pattern Meaning Output <code>DERIVED\\PRIMARY\\T1\\SYNTHETIC</code> Synthetic T1w SyntheticT1w <code>DERIVED\\PRIMARY\\T1W_SYNTHETIC</code> Synthetic T1w (alt) SyntheticT1w <code>DERIVED\\PRIMARY\\T2\\SYNTHETIC</code> Synthetic T2w SyntheticT2w <code>DERIVED\\PRIMARY\\FLAIR\\SYNTHETIC</code> Synthetic FLAIR SyntheticFLAIR <code>DERIVED\\PRIMARY\\DIR_SYNTHETIC</code> Synthetic DIR SyntheticDIR"},{"location":"classification/branches/symri/#raw-source-tokens","title":"Raw Source Tokens","text":"Pattern Meaning Output <code>ORIGINAL\\PRIMARY\\M</code> Magnitude Magnitude <code>ORIGINAL\\PRIMARY\\M_SE</code> SE magnitude (Philips) Magnitude <code>ORIGINAL\\PRIMARY\\P</code> Phase Phase <code>ORIGINAL\\PRIMARY\\PHASE MAP</code> Phase map Phase"},{"location":"classification/branches/symri/#vendor-implementations","title":"Vendor Implementations","text":""},{"location":"classification/branches/symri/#ge-magic","title":"GE: MAGiC","text":"<ul> <li>Sequence name: Often contains \"MAGIC\" or proprietary identifiers</li> <li>Private tags: GEHC_SyMR group (3005) for re-quantification</li> <li>MultiQmap: Bundles T1/T2/PD in single series</li> <li>Report Card: May include brain parenchymal fraction series</li> </ul>"},{"location":"classification/branches/symri/#siemens-symri-openapps","title":"Siemens: SyMRI OpenApps","text":"<ul> <li>Sequence name: MDME patterns</li> <li>Explicit saves: Users manually export maps vs synthetic images</li> <li>Series description: Often includes \"SyMRI\" or \"Synthetic\"</li> </ul>"},{"location":"classification/branches/symri/#philips-syntac","title":"Philips: SyntAc","text":"<ul> <li>Integration: With SmartSpeed pipeline</li> <li>Complex data: May bundle magnitude/phase in legacy formats</li> </ul>"},{"location":"classification/branches/symri/#clinical-significance","title":"Clinical Significance","text":""},{"location":"classification/branches/symri/#why-symri-matters","title":"Why SyMRI Matters","text":"<ol> <li>Time efficiency: Single 5-min acquisition replaces multiple sequences</li> <li>Quantitative biomarkers: T1/T2 values for tissue characterization</li> <li>Retrospective contrast: Generate any weighting post-acquisition</li> <li>Myelin mapping: Direct visualization of demyelination (MS research)</li> </ol>"},{"location":"classification/branches/symri/#correct-classification-importance","title":"Correct Classification Importance","text":"Without SyMRI Branch With SyMRI Branch T1 map \u2192 \"T1-weighted\" \u274c T1 map \u2192 base=NULL, construct=T1map \u2705 Synthetic T1w \u2192 unknown \u274c Synthetic T1w \u2192 base=T1w, construct=SyntheticT1w \u2705 Myelin map \u2192 T1 map \u274c Myelin map \u2192 base=NULL, construct=MyelinMap \u2705 8 raw volumes \u2192 confusion \u274c Raw Magnitude/Phase correctly identified \u2705"},{"location":"classification/branches/symri/#configuration-reference","title":"Configuration Reference","text":""},{"location":"classification/branches/symri/#unified-flags-used","title":"Unified Flags Used","text":"Flag Description <code>has_myelin</code> Myelin (MYC) token detected <code>has_multi_qmap</code> MULTI_QMAP token (GE MAGiC) <code>has_qmap_t1</code>, <code>has_qmap_t2</code>, <code>has_qmap_pd</code> QMAP\\Tx tokens <code>has_t1_map</code>, <code>has_t2_map</code>, <code>has_pd_map</code> TxMAP tokens <code>has_r1</code>, <code>has_r2</code> R1/R2 rate maps <code>has_b1_map</code> B1 field map <code>has_t1_synthetic</code>, <code>has_t2_synthetic</code>, <code>has_pd_synthetic</code> Synthetic weighted <code>has_flair_synthetic</code>, <code>has_dir_synthetic</code>, <code>has_psir_synthetic</code> Synthetic IR <code>is_qalas</code> 3D-QALAS acquisition <code>is_magic_raw</code> GE MAGiC raw source <code>has_magnitude</code>, <code>has_phase</code> Complex components"},{"location":"classification/branches/symri/#output-type-mapping","title":"Output Type Mapping","text":"<p>From <code>backend/src/classification/branches/common.py</code>:</p> <pre><code>SYMRI_OUTPUT_TYPES = {\n    # Raw source\n    \"magnitude\": {\"base\": None, \"construct\": \"Magnitude\"},\n    \"phase\": {\"base\": None, \"construct\": \"Phase\"},\n\n    # Quantitative maps\n    \"t1_map\": {\"base\": None, \"construct\": \"T1map\"},\n    \"t2_map\": {\"base\": None, \"construct\": \"T2map\"},\n    \"pd_map\": {\"base\": None, \"construct\": \"PDmap\"},\n    \"r1_map\": {\"base\": None, \"construct\": \"R1map\"},\n    \"r2_map\": {\"base\": None, \"construct\": \"R2map\"},\n    \"b1_map\": {\"base\": None, \"construct\": \"B1map\"},\n    \"multi_qmap\": {\"base\": None, \"construct\": \"MultiQmap\"},\n    \"myelin_map\": {\"base\": None, \"construct\": \"MyelinMap\"},\n\n    # Synthetic weighted\n    \"synthetic_t1w\": {\"base\": \"T1w\", \"construct\": \"SyntheticT1w\"},\n    \"synthetic_t2w\": {\"base\": \"T2w\", \"construct\": \"SyntheticT2w\"},\n    \"synthetic_pdw\": {\"base\": \"PDw\", \"construct\": \"SyntheticPDw\"},\n\n    # Synthetic IR\n    \"synthetic_flair\": {\"base\": \"T2w\", \"construct\": \"SyntheticFLAIR\", \"modifiers\": [\"FLAIR\"]},\n    \"synthetic_dir\": {\"base\": \"T2w\", \"construct\": \"SyntheticDIR\", \"modifiers\": [\"DIR\"]},\n    \"synthetic_psir\": {\"base\": \"T1w\", \"construct\": \"SyntheticPSIR\", \"modifiers\": [\"PSIR\"]},\n    \"synthetic_stir\": {\"base\": \"T2w\", \"construct\": \"SyntheticSTIR\", \"modifiers\": [\"STIR\"]},\n}\n</code></pre>"},{"location":"classification/branches/symri/#examples","title":"Examples","text":""},{"location":"classification/branches/symri/#example-1-t1-map","title":"Example 1: T1 Map","text":"<p>DICOM Fields: <pre><code>ImageType: DERIVED\\PRIMARY\\T1\nSeriesDescription: SyMRI T1 Map\n</code></pre></p> <p>Classification: <pre><code>base = None           # No tissue contrast\nconstruct = \"T1map\"   # Quantitative T1 map\ntechnique = \"MDME\"    # Source sequence\ndirectory_type = \"anat\"\n</code></pre></p>"},{"location":"classification/branches/symri/#example-2-synthetic-flair","title":"Example 2: Synthetic FLAIR","text":"<p>DICOM Fields: <pre><code>ImageType: DERIVED\\PRIMARY\\FLAIR\\SYNTHETIC\nSeriesDescription: SyMRI Synthetic FLAIR\n</code></pre></p> <p>Classification: <pre><code>base = \"T2w\"                    # FLAIR is T2-weighted\nconstruct = \"SyntheticFLAIR\"    # Synthetic version\nmodifiers = [\"FLAIR\"]           # Add FLAIR modifier\ntechnique = \"MDME\"\ndirectory_type = \"anat\"\n</code></pre></p>"},{"location":"classification/branches/symri/#example-3-raw-mdme-magnitude","title":"Example 3: Raw MDME Magnitude","text":"<p>DICOM Fields: <pre><code>ImageType: ORIGINAL\\PRIMARY\\M\nSeriesDescription: MDME Dyn1 Echo1\nScanningSequence: SE\n</code></pre></p> <p>Classification: <pre><code>base = None              # Raw data, no contrast\nconstruct = \"Magnitude\"  # Magnitude component\ntechnique = \"MDME\"\ndirectory_type = \"anat\"\n</code></pre></p>"},{"location":"classification/branches/symri/#example-4-myelin-map","title":"Example 4: Myelin Map","text":"<p>DICOM Fields: <pre><code>ImageType: DERIVED\\PRIMARY\\MYC\\T1\nSeriesDescription: SyMRI Myelin\n</code></pre></p> <p>Classification: <pre><code>base = None              # Quantitative, no contrast\nconstruct = \"MyelinMap\"  # Myelin water fraction\ntechnique = \"MDME\"\ndirectory_type = \"anat\"\n</code></pre></p> <p>Note: The T1 token is present but myelin detection takes priority.</p>"},{"location":"classification/branches/symri/#troubleshooting","title":"Troubleshooting","text":""},{"location":"classification/branches/symri/#common-issues","title":"Common Issues","text":"<p>Issue: T1 map classified as T1-weighted - Cause: Branch not triggered (provenance not detected as SyMRI) - Solution: Check ProvenanceDetector, add keyword if needed</p> <p>Issue: Myelin map classified as T1 map - Cause: Detection order issue - Solution: Myelin must be checked before T1 map in priority</p> <p>Issue: Synthetic images missing construct - Cause: SYNTHETIC token not detected - Solution: Check ImageType parsing, add token pattern</p> <p>Issue: Unknown SyMRI output defaulting to Magnitude - Cause: No matching detection rules - Solution: Add new unified flag or keyword pattern</p>"},{"location":"classification/branches/symri/#see-also","title":"See Also","text":"<ul> <li>Branches Overview - Why branches exist</li> <li>Provenance Axis - SyMRI provenance detection</li> <li>Construct Axis - Construct definitions</li> <li>Detection Infrastructure - Unified flags</li> </ul>"},{"location":"cohort/","title":"Cohort Operations","text":"<p>A Cohort is a managed group of subjects with associated imaging data. This section covers the four main cohort operations.</p>"},{"location":"cohort/#pipeline-stages","title":"Pipeline Stages","text":"<p>The pipeline runs in a fixed order (anonymization is optional):</p> <ol> <li>Anonymization - Remove PHI from DICOM headers (optional)</li> <li>Extraction - Parse DICOM metadata into the staging catalog</li> <li>Sorting - Label, group, and QC imaging sequences</li> <li>BIDS Export - Organize outputs into BIDS or flat layouts</li> </ol>"},{"location":"cohort/#what-is-a-cohort","title":"What is a Cohort?","text":"<p>A cohort represents a dataset you want to process. It contains:</p> Field Description <code>name</code> Unique identifier for the cohort <code>source_path</code> Root directory containing raw DICOM files <code>description</code> Human-readable description <code>owner</code> Creator/owner of the cohort <code>tags</code> Categorization tags (JSON array) <code>anonymization_enabled</code> Whether to run anonymization stage"},{"location":"cohort/#cohort-status","title":"Cohort Status","text":"<p>Cohorts track their processing status:</p> <ul> <li>idle - Not currently processing</li> <li>in_progress - Pipeline is running</li> <li>completed - All processing finished</li> </ul>"},{"location":"cohort/#cohort-metrics","title":"Cohort Metrics","text":"<p>Progress metrics are tracked:</p> <ul> <li><code>total_subjects</code> - Number of subjects in cohort</li> <li><code>total_sessions</code> - Number of imaging sessions</li> <li><code>total_series</code> - Number of series</li> <li><code>completion_percentage</code> - Overall progress (0-100)</li> </ul>"},{"location":"cohort/#the-cohort-pipeline","title":"The Cohort Pipeline","text":"<pre><code>flowchart TB\n    subgraph anonymize[\"1. ANONYMIZATION (optional)\"]\n        a1[\"Remove PHI from DICOM headers\"]\n        a2[\"Remap patient IDs via folder structure\"]\n        a3[\"Generate encrypted audit logs\"]\n    end\n\n    subgraph extract[\"2. EXTRACTION\"]\n        e1[\"Scan DICOM files recursively\"]\n        e2[\"Parse metadata into staging catalog\"]\n        e3[\"Create Subject, Study, Series, Instance records\"]\n    end\n\n    subgraph sort[\"3. SORTING (4 sub-steps)\"]\n        s1[\"Checkup \u2192 Stack Fingerprint \u2192 Classification \u2192 Completion\"]\n        s2[\"Output: StackFingerprint, SeriesClassificationCache\"]\n    end\n\n    subgraph bids[\"4. BIDS EXPORT\"]\n        b1[\"Filter by intent and provenance\"]\n        b2[\"Convert to DICOM or NIfTI\"]\n        b3[\"Generate BIDS or flat structure\"]\n    end\n\n    anonymize --&gt; extract\n    extract --&gt; sort\n    sort --&gt; bids</code></pre>"},{"location":"cohort/#stage-details","title":"Stage Details","text":""},{"location":"cohort/#1-anonymization-optional","title":"1. Anonymization (Optional)","text":"<p>Runs first when enabled. Removes Protected Health Information (PHI) from DICOM headers before any metadata is extracted.</p> Configuration Description <code>patient_id.strategy</code> How to derive new patient IDs (<code>folder</code>, <code>hash</code>, <code>sequential</code>) <code>study_dates.enabled</code> Whether to shift study dates <code>audit_export.format</code> Audit log format (<code>encrypted_excel</code>, <code>csv</code>) <code>anonymize_categories</code> DICOM tag categories to scrub"},{"location":"cohort/#2-extraction","title":"2. Extraction","text":"<p>Scans the source directory and parses DICOM metadata into the database.</p> Configuration Description <code>process_pool_workers</code> Parallel processes for parsing <code>scan_thread_workers</code> Threads for file scanning <code>folder_thread_workers</code> Threads for folder traversal <p>Output tables: Subject, Study, Series, Instance, SeriesStack</p>"},{"location":"cohort/#3-sorting","title":"3. Sorting","text":"<p>A multi-step stage that classifies all series using the detection infrastructure.</p> Step Description Checkup Verify cohort scope and data integrity Stack Fingerprint Build classification features for each stack Classification Apply detection rules (10-stage pipeline) Completion Fill gaps and flag for manual review Configuration Description <code>profile</code> Detection profile (<code>standard</code>, <code>research</code>) <code>selectedModalities</code> Modalities to process (<code>MR</code>, <code>CT</code>, <code>PT</code>) <code>skipClassified</code> Skip already-classified stacks <code>forceReprocess</code> Force re-classification of all stacks"},{"location":"cohort/#4-bids-export","title":"4. BIDS Export","text":"<p>Generates the final output in BIDS or flat directory structure.</p> Configuration Description <code>outputModes</code> Output formats (<code>dcm</code>, <code>nii</code>, <code>nii.gz</code>) <code>layout</code> Directory structure (<code>bids</code>, <code>flat</code>) <code>includeIntents</code> BIDS intents to include (<code>anat</code>, <code>dwi</code>, <code>func</code>, <code>fmap</code>, <code>perf</code>) <code>includeProvenance</code> Provenance types to include (<code>SyMRI</code>, <code>SWIRecon</code>, <code>EPIMix</code>) <code>groupSyMRI</code> Group SyMRI outputs in subdirectory"},{"location":"cohort/#creating-a-cohort","title":"Creating a Cohort","text":"<ol> <li>Navigate to Cohorts in the sidebar</li> <li>Click New Cohort</li> <li>Enter:</li> <li>Name: Unique identifier (e.g., \"MS_Study_2024\")</li> <li>Source Path: Path to DICOM data (e.g., <code>/data/raw/ms_study</code>)</li> <li>Description: Study description</li> <li>Anonymization: Enable if processing PHI data</li> <li>Click Create</li> </ol> <p>The cohort is now ready for processing.</p>"},{"location":"cohort/#operation-order","title":"Operation Order","text":"<p>Stages must run in sequence:</p> <ol> <li>Anonymization (if enabled) must complete before Extraction</li> <li>Extraction must complete before Sorting</li> <li>Sorting must complete before BIDS Export</li> </ol> <p>Each stage depends on the output of the previous stage.</p>"},{"location":"cohort/#job-management","title":"Job Management","text":"<p>All cohort operations run as Jobs. Jobs provide:</p> <ul> <li>Progress tracking - Percentage complete, items processed</li> <li>Status monitoring - Pending, running, completed, failed</li> <li>Error reporting - Detailed error messages</li> <li>Cancellation - Stop a running job</li> </ul> <p>View jobs in the Jobs tab of the web interface.</p>"},{"location":"cohort/#next-steps","title":"Next Steps","text":"<ul> <li>Anonymization - Remove PHI from DICOM data</li> <li>Extraction - Import DICOM metadata</li> <li>Sorting - Classify series</li> <li>BIDS Export - Generate output</li> </ul>"},{"location":"cohort/anonymization/","title":"Anonymization","text":"<p>Anonymization (pseudo-anonymization) de-identifies DICOM files for research use. NILS provides comprehensive privacy protection with audit logging.</p>"},{"location":"cohort/anonymization/#what-anonymization-does","title":"What Anonymization Does","text":"<ol> <li>DICOM Tag Scrubbing - Removes or modifies 80+ patient-identifiable tags</li> <li>Patient ID Remapping - Multiple strategies for ID substitution</li> <li>Date Manipulation - Maps study dates to relative timepoints</li> <li>Audit Logging - Records all modifications for compliance</li> <li>Folder Renaming - Renames directories to new IDs</li> <li>Output Export - Generates CSV/Excel audit reports</li> </ol>"},{"location":"cohort/anonymization/#tag-categories","title":"Tag Categories","text":"<p>Tags are organized into categories that can be enabled/disabled:</p>"},{"location":"cohort/anonymization/#patient-information","title":"Patient Information","text":"<ul> <li>Patient Name</li> <li>Patient Birth Date</li> <li>Patient Age</li> <li>Patient Address</li> <li>Patient Phone</li> <li>Patient Email</li> <li>Patient Occupation</li> <li>Patient ID numbers</li> </ul>"},{"location":"cohort/anonymization/#clinical-trial-information","title":"Clinical Trial Information","text":"<ul> <li>Protocol ID</li> <li>Enrollment Date</li> <li>Subject Number</li> <li>Site Information</li> </ul>"},{"location":"cohort/anonymization/#healthcare-provider-information","title":"Healthcare Provider Information","text":"<ul> <li>Physician Names</li> <li>Referring Physician</li> <li>Performing Physician</li> <li>Department</li> <li>Facility Codes</li> </ul>"},{"location":"cohort/anonymization/#institution-information","title":"Institution Information","text":"<ul> <li>Institution Name</li> <li>Institution Address</li> <li>Institution Contact</li> </ul>"},{"location":"cohort/anonymization/#time-and-date-information","title":"Time and Date Information","text":"<ul> <li>Study Date/Time</li> <li>Series Date/Time</li> <li>Acquisition Date/Time</li> <li>Content Date/Time</li> </ul>"},{"location":"cohort/anonymization/#patient-id-strategies","title":"Patient ID Strategies","text":"<p>NILS supports five patient ID remapping strategies:</p>"},{"location":"cohort/anonymization/#1-none","title":"1. NONE","text":"<p>No ID remapping. Original Patient IDs are preserved.</p> <p>Warning</p> <p>Use only when original IDs are already anonymized.</p>"},{"location":"cohort/anonymization/#2-sequential","title":"2. SEQUENTIAL","text":"<p>Discover patients and assign sequential IDs.</p> Option Description <code>starting_number</code> First ID number (default: 1) <code>prefix</code> ID prefix (default: \"P\") <code>discovery_mode</code> How to discover patients <p>Discovery Modes:</p> <ul> <li><code>per_top_folder</code> - Each top-level folder is one patient</li> <li><code>one_per_study</code> - Each StudyInstanceUID is one patient</li> <li><code>all</code> - Scan all DICOM files to discover unique PatientIDs</li> </ul> <p>Example output: P001, P002, P003, ...</p>"},{"location":"cohort/anonymization/#3-folder","title":"3. FOLDER","text":"<p>Extract ID from folder path using regex.</p> Option Description <code>regex_pattern</code> Pattern to extract ID <code>folder_depth</code> Directory depth to match <code>fallback_template</code> Template for unmatched folders <p>Example:</p> <ul> <li>Path: <code>/data/SUBJECT_001/session1/</code></li> <li>Pattern: <code>SUBJECT_(\\d+)</code></li> <li>Result: Patient ID = \"001\"</li> </ul>"},{"location":"cohort/anonymization/#4-deterministic","title":"4. DETERMINISTIC","text":"<p>Hash-based consistent ID mapping.</p> Option Description <code>salt</code> Salt for hash computation <code>prefix</code> ID prefix <p>How it works:</p> <ul> <li>Uses blake2b hash with configurable salt</li> <li>Same original ID always produces same new ID</li> <li>Reproducible across runs with same salt</li> </ul> <p>Example: Original \"PAT001\" \u2192 Hash \"A3F7B2C1\"</p>"},{"location":"cohort/anonymization/#5-csv","title":"5. CSV","text":"<p>Load mapping from external CSV file.</p> Option Description <code>csv_path</code> Path to mapping CSV <code>source_column</code> Column with original IDs <code>target_column</code> Column with new IDs <code>missing_mode</code> How to handle unmapped IDs <p>Missing Modes:</p> <ul> <li><code>SEQUENTIAL</code> - Assign sequential ID to unmapped</li> <li><code>HASH</code> - Use deterministic hash for unmapped</li> </ul>"},{"location":"cohort/anonymization/#study-date-mapping","title":"Study Date Mapping","text":"<p>NILS can map actual dates to relative timepoints:</p> Original Date Mapped Value Meaning 2020-01-15 M00 Baseline 2020-07-20 M06 6 months 2021-01-18 M12 12 months 2022-01-22 M24 24 months <p>How it works:</p> <ol> <li>First scan date becomes anchor (M00)</li> <li>Subsequent dates mapped to nearest timepoint</li> <li>Actual dates removed from DICOM</li> </ol> <p>This enables longitudinal tracking without exposing actual dates.</p>"},{"location":"cohort/anonymization/#running-anonymization","title":"Running Anonymization","text":""},{"location":"cohort/anonymization/#from-web-interface","title":"From Web Interface","text":"<ol> <li>Navigate to the cohort</li> <li>Click Anonymize</li> <li>Configure options:</li> <li>Select tag categories to scrub</li> <li>Choose ID strategy</li> <li>Enable/disable date mapping</li> <li>Click Start</li> </ol>"},{"location":"cohort/anonymization/#configuration-options","title":"Configuration Options","text":"Option Description Default <code>patient_id_strategy</code> ID remapping method SEQUENTIAL <code>map_study_dates</code> Map to relative timepoints true <code>categories</code> Tag categories to scrub all <code>output_dir</code> Where to write anonymized files required"},{"location":"cohort/anonymization/#audit-system","title":"Audit System","text":"<p>NILS maintains comprehensive audit logs:</p>"},{"location":"cohort/anonymization/#per-file-tracking","title":"Per-File Tracking","text":"<ul> <li>Tags removed</li> <li>Tags modified</li> <li>Original \u2192 New values</li> <li>Processing timestamp</li> </ul>"},{"location":"cohort/anonymization/#per-cohort-summary","title":"Per-Cohort Summary","text":"<ul> <li>Total files processed</li> <li>Total tags modified</li> <li>Files with errors</li> <li>Processing duration</li> </ul>"},{"location":"cohort/anonymization/#export-formats","title":"Export Formats","text":"<ul> <li>CSV - Plain text audit log</li> <li>Excel - Formatted with encryption option</li> </ul>"},{"location":"cohort/anonymization/#resume-capability","title":"Resume Capability","text":"<p>Anonymization supports resumable processing:</p> <ul> <li>Tracks completed StudyInstanceUIDs</li> <li>Skips already-processed studies on restart</li> <li>Enables recovery from interruptions</li> </ul>"},{"location":"cohort/anonymization/#leaf-level-granularity","title":"Leaf-Level Granularity","text":"<p>Each \"leaf\" (unique StudyInstanceUID) is tracked:</p> <ul> <li><code>files_written</code> - Count of files processed</li> <li><code>files_reused</code> - Count of files skipped (already done)</li> <li><code>errors</code> - Processing errors</li> </ul>"},{"location":"cohort/anonymization/#output-structure","title":"Output Structure","text":"<p>Anonymized files are written with new structure:</p> <p>Input: <pre><code>/raw/PATIENT_001/Study_2020/series1/file.dcm\n</code></pre></p> <p>Output (Sequential IDs): <pre><code>/anonymized/P001/M00/series1/file.dcm\n</code></pre></p> <p>Output (Folder-based): <pre><code>/anonymized/001/M00/series1/file.dcm\n</code></pre></p>"},{"location":"cohort/anonymization/#best-practices","title":"Best Practices","text":""},{"location":"cohort/anonymization/#before-anonymization","title":"Before Anonymization","text":"<ol> <li>Backup original data - Anonymization modifies files</li> <li>Verify extraction - Ensure all data is in database</li> <li>Review ID strategy - Choose appropriate method for your study</li> </ol>"},{"location":"cohort/anonymization/#during-anonymization","title":"During Anonymization","text":"<ol> <li>Monitor progress - Check Jobs tab for status</li> <li>Check errors - Review any failed files</li> <li>Verify output - Spot-check anonymized files</li> </ol>"},{"location":"cohort/anonymization/#after-anonymization","title":"After Anonymization","text":"<ol> <li>Review audit log - Verify all expected tags were removed</li> <li>Validate output - Check files can still be read</li> <li>Secure mapping file - Protect ID mapping for re-identification</li> </ol>"},{"location":"cohort/anonymization/#security-considerations","title":"Security Considerations","text":"<p>Protect the Mapping</p> <p>The ID mapping file (for SEQUENTIAL, CSV strategies) can be used to re-identify subjects. Store it securely and separately from anonymized data.</p> <p>Pseudo-anonymization</p> <p>NILS performs pseudo-anonymization, not full anonymization. Data can be re-linked using the mapping file if properly authorized.</p>"},{"location":"cohort/anonymization/#whats-not-removed","title":"What's NOT Removed","text":"<ul> <li>Imaging pixel data</li> <li>Acquisition parameters (TR, TE, etc.)</li> <li>Scanner information (can be identifying in small studies)</li> <li>Burned-in annotations (if present in pixel data)</li> </ul> <p>For stricter anonymization needs, consider:</p> <ul> <li>Additional pixel-level processing (face removal)</li> <li>Scanner model obfuscation</li> <li>Custom tag handling</li> </ul>"},{"location":"cohort/export/","title":"Export","text":"<p>Export generates BIDS-compliant output from classified data. It supports multiple output formats and layouts.</p>"},{"location":"cohort/export/#what-export-does","title":"What Export Does","text":"<ol> <li>Filters by Intent - Selects series by BIDS intent (anat, dwi, func, fmap)</li> <li>Provenance Routing - Organizes by processing pipeline</li> <li>Format Conversion - Generates DICOM or NIfTI output</li> <li>Naming Convention - Collision-safe BIDS naming</li> <li>Parallel Processing - Multi-threaded copy and conversion</li> </ol>"},{"location":"cohort/export/#output-formats","title":"Output Formats","text":""},{"location":"cohort/export/#dicom-dcm","title":"DICOM (<code>dcm</code>)","text":"<p>Copies DICOM files to organized structure. No conversion.</p> <p>Use when:</p> <ul> <li>Downstream tools need DICOM</li> <li>Maximum data fidelity required</li> <li>Faster processing (no conversion)</li> </ul>"},{"location":"cohort/export/#nifti-nii","title":"NIfTI (<code>nii</code>)","text":"<p>Converts DICOM to uncompressed NIfTI using <code>dcm2niix</code>.</p> <p>Use when:</p> <ul> <li>Analysis tools need NIfTI</li> <li>JSON sidecars are needed</li> <li>Standard neuroimaging workflows</li> </ul>"},{"location":"cohort/export/#compressed-nifti-niigz","title":"Compressed NIfTI (<code>nii.gz</code>)","text":"<p>Converts DICOM to gzip-compressed NIfTI.</p> <p>Use when:</p> <ul> <li>Storage space is limited</li> <li>Data will be archived</li> <li>Compression overhead acceptable</li> </ul>"},{"location":"cohort/export/#output-layouts","title":"Output Layouts","text":""},{"location":"cohort/export/#bids-layout","title":"BIDS Layout","text":"<p>Standard Brain Imaging Data Structure:</p> <pre><code>dataset/\n\u251c\u2500\u2500 dataset_description.json\n\u251c\u2500\u2500 participants.tsv\n\u251c\u2500\u2500 sub-001/\n\u2502   \u2514\u2500\u2500 ses-M00/\n\u2502       \u251c\u2500\u2500 anat/\n\u2502       \u2502   \u251c\u2500\u2500 sub-001_ses-M00_T1w.nii.gz\n\u2502       \u2502   \u251c\u2500\u2500 sub-001_ses-M00_T1w.json\n\u2502       \u2502   \u251c\u2500\u2500 sub-001_ses-M00_T2w.nii.gz\n\u2502       \u2502   \u2514\u2500\u2500 sub-001_ses-M00_FLAIR.nii.gz\n\u2502       \u251c\u2500\u2500 dwi/\n\u2502       \u2502   \u251c\u2500\u2500 sub-001_ses-M00_dwi.nii.gz\n\u2502       \u2502   \u251c\u2500\u2500 sub-001_ses-M00_dwi.bval\n\u2502       \u2502   \u2514\u2500\u2500 sub-001_ses-M00_dwi.bvec\n\u2502       \u2514\u2500\u2500 func/\n\u2502           \u2514\u2500\u2500 sub-001_ses-M00_task-rest_bold.nii.gz\n\u2514\u2500\u2500 sub-002/\n    \u2514\u2500\u2500 ...\n</code></pre>"},{"location":"cohort/export/#flat-layout","title":"Flat Layout","text":"<p>Simple flat directory with descriptive filenames:</p> <pre><code>output/\n\u251c\u2500\u2500 sub-001_ses-M00_T1w.nii.gz\n\u251c\u2500\u2500 sub-001_ses-M00_T2w.nii.gz\n\u251c\u2500\u2500 sub-001_ses-M00_FLAIR.nii.gz\n\u251c\u2500\u2500 sub-001_ses-M00_dwi.nii.gz\n\u251c\u2500\u2500 sub-002_ses-M00_T1w.nii.gz\n\u2514\u2500\u2500 ...\n</code></pre>"},{"location":"cohort/export/#filtering-options","title":"Filtering Options","text":""},{"location":"cohort/export/#by-intent-directory_type","title":"By Intent (directory_type)","text":"<p>Include or exclude by BIDS intent:</p> Intent Description Typical Sequences <code>anat</code> Anatomical T1w, T2w, FLAIR, SWI <code>dwi</code> Diffusion DWI, DTI <code>func</code> Functional BOLD, ASL <code>fmap</code> Fieldmaps B0 maps, phase maps <p>Example: Export only anatomical data:</p> <pre><code>include_intents: [\"anat\"]\n</code></pre>"},{"location":"cohort/export/#by-provenance","title":"By Provenance","text":"<p>Include or exclude by processing pipeline:</p> Provenance Description <code>RawRecon</code> Standard reconstructions <code>SyMRI</code> Synthetic MRI <code>SWIRecon</code> SWI processing <code>DTIRecon</code> DTI maps <code>ProjectionDerived</code> MIP, MinIP projections <p>Example: Exclude derived projections:</p> <pre><code>exclude_provenance: [\"ProjectionDerived\"]\n</code></pre>"},{"location":"cohort/export/#provenance-routing","title":"Provenance Routing","text":"<p>Different provenances get special organization:</p>"},{"location":"cohort/export/#symri","title":"SyMRI","text":"<p>Synthetic MRI outputs grouped in subdirectory:</p> <pre><code>anat/\n\u251c\u2500\u2500 sub-001_T1w.nii.gz          # Raw T1w\n\u2514\u2500\u2500 SyMRI/\n    \u251c\u2500\u2500 sub-001_T1w_synth.nii.gz\n    \u251c\u2500\u2500 sub-001_T2w_synth.nii.gz\n    \u2514\u2500\u2500 sub-001_FLAIR_synth.nii.gz\n</code></pre>"},{"location":"cohort/export/#swi","title":"SWI","text":"<p>Susceptibility-weighted outputs with special naming:</p> <pre><code>anat/\n\u251c\u2500\u2500 sub-001_swi.nii.gz\n\u251c\u2500\u2500 sub-001_part-mag_swi.nii.gz\n\u251c\u2500\u2500 sub-001_part-phase_swi.nii.gz\n\u2514\u2500\u2500 sub-001_acq-qsm_T2starw.nii.gz\n</code></pre>"},{"location":"cohort/export/#collision-handling","title":"Collision Handling","text":"<p>When multiple series have the same classification:</p> <ol> <li>Time-ordered suffixes - Earlier acquisition first</li> <li>Run numbers - <code>_run-01</code>, <code>_run-02</code>, etc.</li> <li>Unique identifiers - Guaranteed uniqueness</li> </ol> <p>Example:</p> <pre><code>sub-001_ses-M00_run-01_T1w.nii.gz  # First T1w\nsub-001_ses-M00_run-02_T1w.nii.gz  # Second T1w\n</code></pre>"},{"location":"cohort/export/#subject-identifier","title":"Subject Identifier","text":""},{"location":"cohort/export/#default-subject_code","title":"Default: subject_code","text":"<p>Uses the <code>subject_code</code> from Subject table.</p>"},{"location":"cohort/export/#alternative-other-identifier","title":"Alternative: Other Identifier","text":"<p>Use an alternative ID from <code>subject_other_identifiers</code>:</p> <pre><code>subject_identifier_source: 3  # id_type_id for STUDY_ID\n</code></pre> <p>This allows subjects to be named by study-specific IDs rather than database IDs.</p>"},{"location":"cohort/export/#overwrite-modes","title":"Overwrite Modes","text":"Mode Description <code>SKIP</code> Skip existing files (default) <code>CLEAN</code> Delete target directory before export <code>OVERWRITE</code> Overwrite existing files in-place"},{"location":"cohort/export/#dcm2niix-configuration","title":"dcm2niix Configuration","text":"<p>For NIfTI conversion:</p> Option Description Default <code>dcm2niix_path</code> Path to dcm2niix executable auto-detect <code>convert_workers</code> Parallel conversion jobs 8 <code>copy_workers</code> Parallel copy threads 8"},{"location":"cohort/export/#running-export","title":"Running Export","text":""},{"location":"cohort/export/#from-web-interface","title":"From Web Interface","text":"<ol> <li>Navigate to the cohort</li> <li>Click Export</li> <li>Configure:</li> <li>Output directory</li> <li>Format (dcm/nii/nii.gz)</li> <li>Layout (BIDS/flat)</li> <li>Intent filters</li> <li>Provenance filters</li> <li>Click Start</li> </ol>"},{"location":"cohort/export/#example-configuration","title":"Example Configuration","text":"<pre><code>output_dir: /data/bids_output\noutput_mode: nii.gz\nlayout: bids\ninclude_intents:\n  - anat\n  - dwi\nexclude_provenance:\n  - ProjectionDerived\n  - SubtractionDerived\noverwrite: skip\n</code></pre>"},{"location":"cohort/export/#bids-validation","title":"BIDS Validation","text":"<p>After export, validate your dataset:</p> <pre><code># Install BIDS Validator\nnpm install -g bids-validator\n\n# Validate\nbids-validator /path/to/bids/dataset\n</code></pre> <p>Or use Docker:</p> <pre><code>docker run -v /path/to/bids:/data:ro bids/validator /data\n</code></pre>"},{"location":"cohort/export/#troubleshooting","title":"Troubleshooting","text":""},{"location":"cohort/export/#no-series-to-export","title":"\"No series to export\"","text":"<ul> <li>Check sorting completed successfully</li> <li>Verify intent filter matches available data</li> <li>Check provenance filters aren't too restrictive</li> </ul>"},{"location":"cohort/export/#conversion-errors","title":"Conversion Errors","text":"<ul> <li>Verify dcm2niix is installed and accessible</li> <li>Check DICOM files are valid</li> <li>Review error messages in job log</li> </ul>"},{"location":"cohort/export/#missing-sidecars","title":"Missing Sidecars","text":"<ul> <li>Ensure dcm2niix version supports JSON sidecar generation</li> <li>Check for DICOM metadata completeness</li> </ul>"},{"location":"cohort/extraction/","title":"Extraction","text":"<p>Extraction scans DICOM files and imports metadata into the NILS database. This is the first step in processing a cohort.</p>"},{"location":"cohort/extraction/#what-extraction-does","title":"What Extraction Does","text":"<ol> <li>Subject Discovery - Scans the raw directory for folder structure</li> <li>Series Grouping - Organizes files by Series/Study/Subject</li> <li>DICOM Parsing - Extracts metadata from each DICOM file</li> <li>Database Insertion - Writes to metadata database tables</li> <li>Stack Detection - Groups instances into homogeneous SeriesStacks</li> <li>Progress Tracking - Supports resumable extraction</li> </ol>"},{"location":"cohort/extraction/#extraction-phases","title":"Extraction Phases","text":""},{"location":"cohort/extraction/#phase-1-subject-discovery","title":"Phase 1: Subject Discovery","text":"<ul> <li>Scans <code>source_path</code> (raw root directory)</li> <li>Identifies subject folders based on naming convention</li> <li>Builds list of <code>SubjectFolder</code> objects</li> </ul>"},{"location":"cohort/extraction/#phase-2-series-planning","title":"Phase 2: Series Planning","text":"<ul> <li>Enumerates all DICOM files per subject</li> <li>Groups files by SeriesInstanceUID</li> <li>Groups series by StudyInstanceUID</li> <li>Groups studies by Subject</li> </ul>"},{"location":"cohort/extraction/#phase-3-parallel-extraction","title":"Phase 3: Parallel Extraction","text":"<ul> <li>Multiple workers parse DICOM files in parallel (ProcessPoolExecutor)</li> <li>Extracts full DICOM metadata from each file</li> <li>Writes results to batch buffers</li> </ul>"},{"location":"cohort/extraction/#phase-4-batch-database-insertion","title":"Phase 4: Batch Database Insertion","text":"<ul> <li>Bulk inserts to database with batching</li> <li>Atomic transactions per batch to prevent data corruption</li> <li>Prevents out-of-memory errors on large datasets</li> </ul>"},{"location":"cohort/extraction/#what-gets-extracted","title":"What Gets Extracted","text":""},{"location":"cohort/extraction/#study-level-metadata","title":"Study-Level Metadata","text":"Field DICOM Tag <code>study_instance_uid</code> (0020,000D) <code>study_date</code> (0008,0020) <code>study_time</code> (0008,0030) <code>study_description</code> (0008,1030) <code>modality</code> (0008,0060) <code>manufacturer</code> (0008,0070) <code>manufacturer_model_name</code> (0008,1090) <code>station_name</code> (0008,1010) <code>institution_name</code> (0008,0080)"},{"location":"cohort/extraction/#series-level-metadata","title":"Series-Level Metadata","text":"Field DICOM Tag <code>series_instance_uid</code> (0020,000E) <code>series_description</code> (0008,103E) <code>protocol_name</code> (0018,1030) <code>sequence_name</code> (0018,0024) <code>body_part_examined</code> (0018,0015) <code>scanning_sequence</code> (0018,0020) <code>sequence_variant</code> (0018,0021) <code>scan_options</code> (0018,0022)"},{"location":"cohort/extraction/#mr-specific-metadata","title":"MR-Specific Metadata","text":"Field DICOM Tag <code>repetition_time</code> (0018,0080) <code>echo_time</code> (0018,0081) <code>inversion_time</code> (0018,0082) <code>flip_angle</code> (0018,1314) <code>echo_train_length</code> (0018,0091) <code>mr_acquisition_type</code> (0018,0023) <code>diffusion_b_value</code> (0018,9087) <code>parallel_acquisition_technique</code> (0018,9078)"},{"location":"cohort/extraction/#ct-specific-metadata","title":"CT-Specific Metadata","text":"Field DICOM Tag <code>kvp</code> (0018,0060) <code>exposure_time</code> (0018,1150) <code>x_ray_tube_current</code> (0018,1151) <code>convolution_kernel</code> (0018,1210) <code>spiral_pitch_factor</code> (0018,9311) <code>ctdi_vol</code> (0018,9345)"},{"location":"cohort/extraction/#pet-specific-metadata","title":"PET-Specific Metadata","text":"Field DICOM Tag <code>radiopharmaceutical</code> (0018,0031) <code>radionuclide_total_dose</code> (0018,1074) <code>radionuclide_half_life</code> (0018,1075) <code>reconstruction_method</code> (0054,1103) <code>attenuation_correction_method</code> (0054,1101) <code>suv_type</code> (0054,1006)"},{"location":"cohort/extraction/#stack-detection","title":"Stack Detection","text":"<p>After parsing instances, NILS groups them into SeriesStacks.</p>"},{"location":"cohort/extraction/#what-defines-a-stack","title":"What Defines a Stack?","text":"<p>Instances are grouped by matching:</p> <p>MR Stacks:</p> <ul> <li>Echo Time (TE)</li> <li>Inversion Time (TI)</li> <li>Flip Angle</li> <li>Echo Number</li> <li>Image Type (MAGNITUDE, PHASE, etc.)</li> <li>Image Orientation</li> </ul> <p>CT Stacks:</p> <ul> <li>kVp</li> <li>Tube Current</li> <li>Exposure</li> </ul> <p>PET Stacks:</p> <ul> <li>Bed Index</li> <li>Frame Type</li> </ul>"},{"location":"cohort/extraction/#stack-key","title":"Stack Key","text":"<p>Each stack gets a deterministic <code>stack_key</code> - a string combining all defining parameters:</p> <pre><code>MR|TE=2.5|TI=900|FA=9|ECHO=1|TYPE=M|ORIENT=SAG\n</code></pre> <p>This enables idempotent classification across reruns.</p>"},{"location":"cohort/extraction/#resume-capability","title":"Resume Capability","text":"<p>Extraction supports resumable processing:</p> <ul> <li>Tracks previously extracted subjects/series</li> <li>On restart, skips already-processed data</li> <li>Enables recovery from interruptions</li> </ul> <p>The resume index stores:</p> <ul> <li>Subject folder paths already processed</li> <li>Series UIDs already in database</li> </ul>"},{"location":"cohort/extraction/#running-extraction","title":"Running Extraction","text":""},{"location":"cohort/extraction/#from-web-interface","title":"From Web Interface","text":"<ol> <li>Navigate to the cohort</li> <li>Click Extract</li> <li>Monitor progress in the Jobs tab</li> </ol>"},{"location":"cohort/extraction/#from-cli","title":"From CLI","text":"<pre><code>docker compose exec backend neuro-backend extract \\\n  --cohort my_cohort \\\n  --workers 4\n</code></pre>"},{"location":"cohort/extraction/#options","title":"Options","text":"Option Description Default <code>--workers</code> Parallel parsing workers 4 <code>--batch-size</code> DB insert batch size 1000 <code>--resume</code> Resume from last checkpoint true"},{"location":"cohort/extraction/#after-extraction","title":"After Extraction","text":"<p>Once extraction completes, the database contains:</p> <ul> <li>Subject records for each patient</li> <li>Study records for each imaging session</li> <li>Series records for each acquisition</li> <li>Instance records for each image</li> <li>SeriesStack records grouping instances</li> </ul> <p>The cohort is now ready for Sorting.</p>"},{"location":"cohort/extraction/#troubleshooting","title":"Troubleshooting","text":""},{"location":"cohort/extraction/#no-dicom-files-found","title":"\"No DICOM files found\"","text":"<ul> <li>Check that <code>source_path</code> points to actual DICOM files</li> <li>NILS scans recursively - files can be in subdirectories</li> <li>Verify files have .dcm extension or no extension</li> </ul>"},{"location":"cohort/extraction/#duplicate-series","title":"\"Duplicate series\"","text":"<ul> <li>This is normal for re-extractions</li> <li>Enable resume mode to skip already-imported data</li> <li>Or clear existing data before re-extraction</li> </ul>"},{"location":"cohort/extraction/#memory-issues","title":"Memory Issues","text":"<ul> <li>Reduce <code>--workers</code> count</li> <li>Reduce <code>--batch-size</code></li> <li>Ensure adequate system RAM (8GB+ recommended)</li> </ul>"},{"location":"cohort/sorting/","title":"Sorting","text":"<p>Sorting runs the classification pipeline on all extracted series. It consists of four steps that must run in sequence.</p>"},{"location":"cohort/sorting/#the-four-steps","title":"The Four Steps","text":"<pre><code>flowchart LR\n    A[\"Step 1: Checkup\"] --&gt; B[\"Step 2: Stack Fingerprint\"]\n    B --&gt; C[\"Step 3: Classification\"]\n    C --&gt; D[\"Step 4: Output Generation\"]</code></pre>"},{"location":"cohort/sorting/#step-1-checkup","title":"Step 1: Checkup","text":"<p>Purpose: Validate data and prepare series for processing.</p>"},{"location":"cohort/sorting/#what-it-does","title":"What It Does","text":"<ol> <li>Cohort Subject Resolution</li> <li>Gets all subjects in the cohort</li> <li> <p>Validates subject membership</p> </li> <li> <p>Study Discovery</p> </li> <li>Finds all studies for these subjects</li> <li> <p>Validates study-subject relationships</p> </li> <li> <p>Study Date Validation &amp; Repair</p> </li> <li>Checks for missing <code>study_date</code></li> <li>Attempts recovery from <code>acquisition_date</code> or <code>content_date</code></li> <li> <p>Flags studies with unrecoverable dates</p> </li> <li> <p>Series Collection</p> </li> <li>Gets all series from valid studies</li> <li> <p>Filters by modality if configured</p> </li> <li> <p>Existing Classification Filter</p> </li> <li>Checks if series already classified</li> <li>Skip or reprocess based on configuration</li> </ol>"},{"location":"cohort/sorting/#output","title":"Output","text":"<p><code>Step1Handover</code> containing:</p> <ul> <li>List of <code>SeriesForProcessing</code> (series_id, study_id, subject_id)</li> <li>Validation results</li> <li>Excluded series with reasons</li> </ul>"},{"location":"cohort/sorting/#step-2-stack-fingerprint","title":"Step 2: Stack Fingerprint","text":"<p>Purpose: Build classification-ready feature vectors for each stack.</p>"},{"location":"cohort/sorting/#what-it-does_1","title":"What It Does","text":"<ol> <li>Load Handover</li> <li> <p>Receives series IDs from Step 1</p> </li> <li> <p>Query Stack Data</p> </li> <li>Fetches all SeriesStack records</li> <li> <p>Joins with Series, Study, and modality-specific details</p> </li> <li> <p>Build Fingerprints (Polars)</p> </li> <li>Vectorized transformations using Polars</li> <li>Normalizes values across modalities</li> <li>Aggregates text fields into searchable blobs</li> <li> <p>Computes geometry features (FOV, aspect ratio)</p> </li> <li> <p>Database Upsert</p> </li> <li>Bulk COPY into <code>stack_fingerprint</code> table</li> <li> <p>UPSERT for existing fingerprints</p> </li> <li> <p>Batched Commits</p> </li> <li>Commits in batches to prevent OOM</li> <li>Enables progress tracking</li> </ol>"},{"location":"cohort/sorting/#performance","title":"Performance","text":"<ul> <li>Processes ~450K stacks in 45-60 seconds</li> <li>Previous ORM-based approach caused OOM on large datasets</li> <li>Polars vectorization provides 10-50x speedup</li> </ul>"},{"location":"cohort/sorting/#output_1","title":"Output","text":"<p><code>Step2Handover</code> containing:</p> <ul> <li>List of <code>fingerprint_id</code> values</li> <li>Processing statistics</li> </ul>"},{"location":"cohort/sorting/#step-3-classification","title":"Step 3: Classification","text":"<p>Purpose: Run the 10-stage classification pipeline on each fingerprint.</p>"},{"location":"cohort/sorting/#what-it-does_2","title":"What It Does","text":"<p>For each StackFingerprint:</p> <ol> <li>Stage 0: Exclusion Check</li> <li>Filters screenshots, secondary reformats</li> <li> <p>Checks ImageType flags</p> </li> <li> <p>Stage 1: Provenance Detection</p> </li> <li>Determines processing pipeline</li> <li> <p>Routes to appropriate branch</p> </li> <li> <p>Stage 2: Technique Detection</p> </li> <li> <p>Identifies pulse sequence family</p> </li> <li> <p>Stage 3: Branch Logic</p> </li> <li> <p>Executes provenance-specific logic:</p> <ul> <li><code>SWI Branch</code> \u2192 SWI/QSM classification</li> <li><code>SyMRI Branch</code> \u2192 Synthetic MRI classification</li> <li><code>EPIMix Branch</code> \u2192 Multi-contrast EPI</li> <li><code>RawRecon Branch</code> \u2192 Standard detection</li> </ul> </li> <li> <p>Stage 4: Modifier Detection</p> </li> <li> <p>Detects FLAIR, FatSat, MT, etc.</p> </li> <li> <p>Stage 5: Acceleration Detection</p> </li> <li> <p>Detects GRAPPA, SMS, etc.</p> </li> <li> <p>Stage 6: Contrast Agent Detection</p> </li> <li> <p>Pre/post contrast determination</p> </li> <li> <p>Stage 7: Body Part Detection</p> </li> <li> <p>Spinal cord flagging</p> </li> <li> <p>Stage 8: Intent Synthesis</p> </li> <li> <p>Maps to BIDS directory_type (anat, dwi, func, fmap)</p> </li> <li> <p>Stage 9: Review Flag Aggregation</p> <ul> <li>Combines all review triggers</li> <li>Sets <code>manual_review_required</code></li> </ul> </li> </ol>"},{"location":"cohort/sorting/#output_2","title":"Output","text":"<p><code>SeriesClassificationCache</code> records containing:</p> <ul> <li>All six classification axes</li> <li>Flags (post_contrast, localizer, spinal_cord)</li> <li>BIDS intent (directory_type)</li> <li>Review requirements</li> </ul>"},{"location":"cohort/sorting/#step-4-output-generation","title":"Step 4: Output Generation","text":"<p>Purpose: Export classified data to target structure.</p>"},{"location":"cohort/sorting/#what-it-does_3","title":"What It Does","text":"<ol> <li>Filter by Classification</li> <li>Include/exclude by provenance</li> <li> <p>Include/exclude by intent</p> </li> <li> <p>Organize Output</p> </li> <li>BIDS structure or flat layout</li> <li> <p>Provenance-specific routing</p> </li> <li> <p>Copy/Convert Files</p> </li> <li>DICOM copy or NIfTI conversion</li> <li>Parallel processing</li> </ol>"},{"location":"cohort/sorting/#output-modes","title":"Output Modes","text":"Mode Description <code>dcm</code> Copy DICOM files <code>nii</code> Convert to NIfTI <code>nii.gz</code> Convert to compressed NIfTI"},{"location":"cohort/sorting/#running-sorting","title":"Running Sorting","text":""},{"location":"cohort/sorting/#from-web-interface","title":"From Web Interface","text":"<ol> <li>Navigate to the cohort</li> <li>Click Sort</li> <li>Steps run automatically in sequence</li> <li>Monitor in Jobs tab</li> </ol>"},{"location":"cohort/sorting/#step-by-step-execution","title":"Step-by-Step Execution","text":"<p>You can also run steps individually:</p> <ol> <li>Run Step 1 (Checkup)</li> <li>Review validation results</li> <li>Run Step 2 (Fingerprint)</li> <li>Run Step 3 (Classification)</li> <li>Run Step 4 (Output) when ready</li> </ol>"},{"location":"cohort/sorting/#configuration-options","title":"Configuration Options","text":"Option Description Default <code>reprocess</code> Reclassify already-classified series false <code>include_modalities</code> Filter to specific modalities all <code>parallel_workers</code> Classification workers 4"},{"location":"cohort/sorting/#date-recovery","title":"Date Recovery","text":"<p>Step 1 attempts to repair missing <code>study_date</code>:</p> <ol> <li>Check <code>acquisition_date</code> from Instance</li> <li>Check <code>content_date</code> from Instance</li> <li>Mark as excluded if unrecoverable</li> </ol> <p>This handles DICOM files with missing or corrupted dates.</p>"},{"location":"cohort/sorting/#stack-key","title":"Stack Key","text":"<p>Each SeriesStack has a deterministic <code>stack_key</code>:</p> <pre><code>MR|TE=2.46|TI=900|FA=9|ECHO=1|TYPE=M|ORIENT=AX\n</code></pre> <p>This enables:</p> <ul> <li>Duplicate detection across reruns</li> <li>Idempotent classification</li> <li>Stack grouping within series</li> </ul>"},{"location":"cohort/sorting/#fingerprint-features","title":"Fingerprint Features","text":"<p>StackFingerprint contains normalized features:</p>"},{"location":"cohort/sorting/#general-features","title":"General Features","text":"<ul> <li><code>modality</code> - MR, CT, PET</li> <li><code>manufacturer</code> - Normalized (GE, SIEMENS, PHILIPS, etc.)</li> <li><code>text_search_blob</code> - Concatenated descriptions</li> </ul>"},{"location":"cohort/sorting/#geometry-features","title":"Geometry Features","text":"<ul> <li><code>stack_orientation</code> - Axial, Coronal, Sagittal</li> <li><code>fov_x</code>, <code>fov_y</code> - Field of view in mm</li> <li><code>aspect_ratio</code> - FOV ratio</li> </ul>"},{"location":"cohort/sorting/#mr-features","title":"MR Features","text":"<ul> <li><code>mr_te</code>, <code>mr_tr</code>, <code>mr_ti</code> - Timing parameters (ms)</li> <li><code>mr_flip_angle</code> - Flip angle (degrees)</li> <li><code>mr_acquisition_type</code> - 2D or 3D</li> <li><code>mr_diffusion_b_value</code> - Diffusion b-value</li> </ul>"},{"location":"cohort/sorting/#ct-features","title":"CT Features","text":"<ul> <li><code>ct_kvp</code> - Tube voltage</li> <li><code>ct_tube_current</code> - Tube current</li> <li><code>ct_convolution_kernel</code> - Reconstruction kernel</li> </ul>"},{"location":"cohort/sorting/#pet-features","title":"PET Features","text":"<ul> <li><code>pet_tracer</code> - Radiopharmaceutical</li> <li><code>pet_reconstruction_method</code> - Recon algorithm</li> <li><code>pet_suv_type</code> - SUV calculation type</li> </ul>"},{"location":"cohort/sorting/#troubleshooting","title":"Troubleshooting","text":""},{"location":"cohort/sorting/#no-series-to-process","title":"\"No series to process\"","text":"<ul> <li>Check extraction completed successfully</li> <li>Verify series exist in database</li> <li>Check modality filters</li> </ul>"},{"location":"cohort/sorting/#classification-issues","title":"Classification Issues","text":"<ul> <li>Review <code>manual_review_required</code> flags</li> <li>Check <code>manual_review_reasons_csv</code> for details</li> <li>Use QC interface to review flagged series</li> </ul>"},{"location":"cohort/sorting/#performance_1","title":"Performance","text":"<ul> <li>Step 2 is typically the bottleneck</li> <li>Ensure adequate RAM (8GB+ for large datasets)</li> <li>Reduce batch size if memory issues occur</li> </ul>"},{"location":"concepts/","title":"Core Concepts","text":"<p>This section explains the fundamental data models and terminology used in NILS.</p>"},{"location":"concepts/#data-hierarchy","title":"Data Hierarchy","text":"<p>NILS implements a hierarchical data model that mirrors the DICOM structure:</p> <pre><code>Subject\n\u251c\u2500\u2500 Study\n\u2502   \u251c\u2500\u2500 Series\n\u2502   \u2502   \u251c\u2500\u2500 SeriesStack (homogeneous instance group)\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 Instance\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 Instance\n\u2502   \u2502   \u2514\u2500\u2500 SeriesStack\n\u2502   \u2502       \u2514\u2500\u2500 Instance\n\u2502   \u2514\u2500\u2500 Series\n\u2514\u2500\u2500 Study\n</code></pre>"},{"location":"concepts/#entities","title":"Entities","text":""},{"location":"concepts/#subject","title":"Subject","text":"<p>A Subject represents an individual patient or participant in the study.</p> Field Description <code>subject_code</code> Unique identifier for the subject <code>patient_name</code> Original DICOM patient name (optional) <code>patient_birth_date</code> Date of birth <code>patient_sex</code> Sex (M/F/O) <code>ethnic_group</code> Ethnicity information <code>occupation</code> Patient occupation <code>additional_patient_history</code> Clinical history notes <p>Subjects can be linked to:</p> <ul> <li>Cohorts via <code>SubjectCohort</code> (many-to-many)</li> <li>Diseases via <code>SubjectDisease</code> with onset/diagnosis events</li> <li>Other identifiers via <code>SubjectOtherIdentifier</code> (multiple ID types)</li> </ul>"},{"location":"concepts/#study","title":"Study","text":"<p>A Study represents a single imaging session (one visit to the scanner).</p> Field Description <code>study_instance_uid</code> Unique DICOM Study Instance UID <code>study_date</code> Date of the imaging session <code>study_time</code> Time of the session <code>study_description</code> Description of the study <code>modality</code> Primary modality (MR, CT, PET) <code>manufacturer</code> Scanner manufacturer <code>manufacturer_model_name</code> Scanner model <code>station_name</code> Scanner station name <code>institution_name</code> Institution where scan was performed"},{"location":"concepts/#series","title":"Series","text":"<p>A Series represents a single acquisition within a study.</p> Field Description <code>series_instance_uid</code> Unique DICOM Series Instance UID <code>modality</code> Acquisition modality <code>series_description</code> Series description from DICOM <code>protocol_name</code> Protocol name <code>sequence_name</code> Sequence name <code>body_part_examined</code> Anatomical region <code>scanning_sequence</code> DICOM scanning sequence <code>sequence_variant</code> DICOM sequence variant <code>scan_options</code> Additional scan options <p>Modality-specific details are stored in separate tables:</p> <ul> <li><code>MRISeriesDetails</code> - MR-specific parameters (TR, TE, TI, flip angle, etc.)</li> <li><code>CTSeriesDetails</code> - CT-specific parameters (kVp, exposure, kernel, etc.)</li> <li><code>PETSeriesDetails</code> - PET-specific parameters (tracer, SUV, corrections, etc.)</li> </ul>"},{"location":"concepts/#seriesstack","title":"SeriesStack","text":"<p>A SeriesStack is a critical concept in NILS. It represents a homogeneous group of instances within a single Series that share identical acquisition parameters.</p> <p>Why SeriesStack?</p> <p>A single DICOM Series can contain multiple logically distinct stacks. For example:</p> <ul> <li>Multi-echo acquisitions (different TE values)</li> <li>Multi-flip-angle acquisitions</li> <li>Dixon fat/water separation (in-phase, out-of-phase, water, fat images)</li> <li>SWI magnitude and phase components</li> </ul> <p>SeriesStack allows NILS to classify each stack independently.</p> Field Description <code>stack_index</code> Numeric index within the series <code>stack_key</code> Deterministic string combining defining parameters <code>stack_modality</code> MR, CT, or PET <code>stack_n_instances</code> Number of instances in this stack <p>MR-specific stack fields:</p> <ul> <li><code>stack_echo_time</code>, <code>stack_repetition_time</code>, <code>stack_inversion_time</code></li> <li><code>stack_flip_angle</code>, <code>stack_echo_train_length</code></li> <li><code>stack_receive_coil_name</code>, <code>stack_image_orientation</code></li> <li><code>stack_image_type</code> (e.g., MAGNITUDE, PHASE, REAL, IMAGINARY)</li> </ul> <p>CT-specific stack fields:</p> <ul> <li><code>stack_kvp</code>, <code>stack_tube_current</code>, <code>stack_xray_exposure</code></li> </ul> <p>PET-specific stack fields:</p> <ul> <li><code>stack_pet_bed_index</code>, <code>stack_pet_frame_type</code></li> </ul>"},{"location":"concepts/#stackfingerprint","title":"StackFingerprint","text":"<p>A StackFingerprint is a flattened, feature-rich representation of a SeriesStack designed for the classification algorithm.</p> <p>It normalizes parameters across modalities and aggregates text fields for easy searching:</p> Category Fields General modality, manufacturer, manufacturer_model Text text_search_blob (concatenated descriptions), contrast_search_blob Geometry stack_orientation, fov_x, fov_y, aspect_ratio MR mr_te, mr_tr, mr_ti, mr_flip_angle, mr_acquisition_type (2D/3D), mr_angio_flag CT ct_kvp, ct_exposure_time, ct_tube_current, ct_convolution_kernel PET pet_tracer, pet_reconstruction_method, pet_suv_type, pet_units"},{"location":"concepts/#seriesclassificationcache","title":"SeriesClassificationCache","text":"<p>Stores the classification results for each SeriesStack:</p> Field Description <code>base</code> Base contrast weighting (T1w, T2w, etc.) <code>technique</code> Pulse sequence technique (MPRAGE, TSE, etc.) <code>modifier_csv</code> Comma-separated modifiers (FLAIR, FatSat, etc.) <code>construct_csv</code> Comma-separated derived types (ADC, FA, etc.) <code>provenance</code> Processing pipeline (SyMRI, SWIRecon, etc.) <code>acceleration_csv</code> Comma-separated acceleration methods <code>post_contrast</code> Contrast agent status (1=post, 0=pre, NULL=unknown) <code>localizer</code> Is this a localizer/scout? <code>spinal_cord</code> Spinal cord involvement flag <code>directory_type</code> BIDS intent (anat, dwi, func, fmap) <code>manual_review_required</code> Needs QC review? <code>manual_review_reasons_csv</code> Why review is needed"},{"location":"concepts/#clinical-data-models","title":"Clinical Data Models","text":"<p>NILS supports comprehensive clinical metadata:</p>"},{"location":"concepts/#disease-diseasetype","title":"Disease &amp; DiseaseType","text":"<pre><code>Disease (e.g., Multiple Sclerosis)\n\u2514\u2500\u2500 DiseaseType (e.g., RRMS, SPMS, PPMS)\n</code></pre>"},{"location":"concepts/#subjectdisease","title":"SubjectDisease","text":"<p>Links subjects to diseases with:</p> <ul> <li><code>diagnosis_notes</code> - Clinical notes</li> <li><code>family_history</code> - Family history information</li> <li><code>onset_event_id</code> - Reference to disease onset event</li> <li><code>diagnosis_event_id</code> - Reference to diagnosis event</li> </ul>"},{"location":"concepts/#events","title":"Events","text":"<p>Clinical events with:</p> <ul> <li><code>event_type</code> (category + name)</li> <li><code>event_date</code> and <code>event_time</code></li> <li><code>notes</code></li> </ul>"},{"location":"concepts/#clinical-measures","title":"Clinical Measures","text":"<p>Four measure types based on value type:</p> <ul> <li>NumericMeasure - Numeric values with units (e.g., EDSS score)</li> <li>TextMeasure - Text values (e.g., medication names)</li> <li>BooleanMeasure - Yes/No values (e.g., relapse occurred)</li> <li>JsonMeasure - Complex structured data</li> </ul> <p>Each measure links to a ClinicalMeasureType that defines:</p> <ul> <li>Category and name</li> <li>Unit of measurement</li> <li>Value type</li> <li>Min/max valid values</li> <li>Whether it's a primary outcome measure</li> </ul>"},{"location":"concepts/#cohorts","title":"Cohorts","text":"<p>A Cohort is a managed group of subjects with associated imaging data.</p> Field Description <code>name</code> Unique cohort name <code>source_path</code> Root directory containing DICOM files <code>description</code> Text description <code>owner</code> Owner/creator <code>tags</code> Categorization tags <p>Cohorts track pipeline progress:</p> <ul> <li><code>status</code>: idle, in_progress, completed</li> <li><code>completion_percentage</code>: 0-100</li> <li><code>total_subjects</code>, <code>total_sessions</code>, <code>total_series</code></li> </ul> <p>See Cohort Operations for details on cohort processing.</p>"},{"location":"concepts/#next-classification","title":"Next: Classification","text":"<p>Learn how NILS classifies series using the Six-Axis Classification System.</p>"},{"location":"getting-started/configuration/","title":"Configuration","text":"<p>NILS can be configured through environment variables and configuration files.</p>"},{"location":"getting-started/configuration/#environment-variables","title":"Environment Variables","text":"<p>Configuration is managed through the <code>.env</code> file in the project root.</p>"},{"location":"getting-started/configuration/#core-settings","title":"Core Settings","text":"Variable Default Description <code>API_URL</code> <code>http://backend:8000</code> Backend API URL (internal) <code>DATABASE_URL</code> <code>postgresql://...</code> Main database connection <code>METADATA_DATABASE_URL</code> <code>postgresql://...</code> Metadata database connection <code>APP_ACCESS_TOKEN</code> - Access token for API authentication"},{"location":"getting-started/configuration/#network-settings","title":"Network Settings","text":"Variable Default Description <code>BIND_ADDRESS</code> <code>127.0.0.1</code> Address to bind services <code>FRONTEND_PORT</code> <code>5173</code> Frontend web interface port <code>BACKEND_PORT</code> <code>8000</code> Backend API port"},{"location":"getting-started/configuration/#data-directories","title":"Data Directories","text":"Variable Default Description <code>DATA_MOUNT</code> <code>/data</code> Path to mount external data <code>DB_DATA_DIR</code> <code>./resource/db</code> PostgreSQL data directory <code>BACKUP_DIR</code> <code>./resource/backups</code> Backup storage location"},{"location":"getting-started/configuration/#example-configuration","title":"Example Configuration","text":"<pre><code># .env file\n\n# API Configuration\nAPI_URL=http://backend:8000\nAPP_ACCESS_TOKEN=your-secure-token-here\n\n# Database\nDATABASE_URL=postgresql://nils:nils@db:5432/nils\nMETADATA_DATABASE_URL=postgresql://nils:nils@db_metadata:5432/metadata\n\n# Network (localhost only by default)\nBIND_ADDRESS=127.0.0.1\nFRONTEND_PORT=5173\nBACKEND_PORT=8000\n\n# Data paths\nDATA_MOUNT=/path/to/your/dicom/data\n</code></pre>"},{"location":"getting-started/configuration/#network-access","title":"Network Access","text":"<p>By default, NILS binds to <code>127.0.0.1</code> (localhost only). To allow network access:</p> <pre><code># Enable network access\n./scripts/manage.sh start --forward\n</code></pre> <p>Security</p> <p>Enabling network access exposes NILS to your network. Ensure proper firewall rules and authentication are in place.</p>"},{"location":"getting-started/configuration/#database-configuration","title":"Database Configuration","text":"<p>NILS uses two PostgreSQL databases:</p> <ol> <li>Main Database - Application data (cohorts, jobs, settings)</li> <li>Metadata Database - DICOM metadata and classification results</li> </ol> <p>Both databases are managed by Docker and persist data in the configured directories.</p>"},{"location":"getting-started/configuration/#backup-and-restore","title":"Backup and Restore","text":"<pre><code># Create backup\n./scripts/manage.sh backup\n\n# Restore from backup\n./scripts/manage.sh restore backup-file.sql\n</code></pre>"},{"location":"getting-started/configuration/#classification-rules","title":"Classification Rules","text":"<p>Classification rules are configured via YAML files in <code>backend/src/classification/detection_yaml/</code>:</p> <ul> <li><code>base-detection.yaml</code> - Core sequence types</li> <li><code>technique-detection.yaml</code> - Acquisition techniques</li> <li><code>modifier-detection.yaml</code> - Sequence modifiers</li> <li><code>contrast-detection.yaml</code> - Contrast agent detection</li> </ul> <p>See Detection Infrastructure for detailed configuration.</p>"},{"location":"getting-started/configuration/#resource-limits","title":"Resource Limits","text":"<p>Docker Compose applies resource limits to prevent runaway processes:</p> <pre><code># docker-compose.yml\nservices:\n  frontend:\n    deploy:\n      resources:\n        limits:\n          memory: 2G\n</code></pre> <p>Adjust these limits based on your system resources.</p>"},{"location":"getting-started/installation/","title":"Installation","text":"<p>This guide covers how to install and run NILS on your system.</p>"},{"location":"getting-started/installation/#prerequisites","title":"Prerequisites","text":"<p>Before installing NILS, ensure you have:</p> <ul> <li>Docker (version 20.10 or later)</li> <li>Docker Compose (version 2.0 or later)</li> <li>Git (for cloning the repository)</li> </ul>"},{"location":"getting-started/installation/#verifying-prerequisites","title":"Verifying Prerequisites","text":"<pre><code># Check Docker version\ndocker --version\n# Docker version 24.0.0 or later\n\n# Check Docker Compose version\ndocker compose version\n# Docker Compose version v2.20.0 or later\n\n# Check Git\ngit --version\n</code></pre>"},{"location":"getting-started/installation/#installation-steps","title":"Installation Steps","text":""},{"location":"getting-started/installation/#1-clone-the-repository","title":"1. Clone the Repository","text":"<pre><code>git clone https://github.com/NeuroGranberg/NILS.git\ncd NILS\n</code></pre>"},{"location":"getting-started/installation/#2-configure-environment","title":"2. Configure Environment","text":"<p>Copy the example environment file and adjust settings if needed:</p> <pre><code>cp .env.example .env\n</code></pre> <p>The default configuration works for most setups. See Configuration for customization options.</p>"},{"location":"getting-started/installation/#3-start-nils","title":"3. Start NILS","text":"<pre><code>./scripts/manage.sh start\n</code></pre> <p>This command will:</p> <ol> <li>Pull required Docker images</li> <li>Build the application containers</li> <li>Initialize the databases</li> <li>Start all services</li> </ol> <p>First Start</p> <p>The first start may take several minutes as Docker downloads and builds images.</p>"},{"location":"getting-started/installation/#4-access-the-interface","title":"4. Access the Interface","text":"<p>Once started, open your browser and navigate to:</p> <pre><code>http://localhost:5173\n</code></pre>"},{"location":"getting-started/installation/#stopping-nils","title":"Stopping NILS","text":"<p>To stop all services:</p> <pre><code>./scripts/manage.sh stop\n</code></pre>"},{"location":"getting-started/installation/#updating-nils","title":"Updating NILS","text":"<p>To update to the latest version:</p> <pre><code>git pull\n./scripts/manage.sh stop\n./scripts/manage.sh start\n</code></pre>"},{"location":"getting-started/installation/#troubleshooting","title":"Troubleshooting","text":""},{"location":"getting-started/installation/#port-conflicts","title":"Port Conflicts","text":"<p>If port 5173 is already in use, you can modify the port in your <code>.env</code> file:</p> <pre><code>FRONTEND_PORT=8080\n</code></pre>"},{"location":"getting-started/installation/#permission-issues","title":"Permission Issues","text":"<p>On Linux, you may need to add your user to the docker group:</p> <pre><code>sudo usermod -aG docker $USER\n# Log out and back in for changes to take effect\n</code></pre>"},{"location":"getting-started/installation/#container-issues","title":"Container Issues","text":"<p>To clean up and start fresh:</p> <pre><code>./scripts/manage.sh stop --clean\n./scripts/manage.sh start\n</code></pre>"},{"location":"getting-started/installation/#next-steps","title":"Next Steps","text":"<ul> <li>Continue to Quick Start to import your first dataset</li> <li>See Configuration for advanced settings</li> </ul>"},{"location":"getting-started/quick-start/","title":"Quick Start","text":"<p>This guide walks you through importing and processing your first dataset with NILS.</p>"},{"location":"getting-started/quick-start/#overview","title":"Overview","text":"<p>A typical NILS workflow consists of:</p> <ol> <li>Import - Load DICOM data into the system</li> <li>Classify - Automatically identify sequence types</li> <li>Sort - Organize files into a structured hierarchy</li> <li>Anonymize - De-identify patient information</li> <li>Export - Convert to BIDS format (optional)</li> </ol>"},{"location":"getting-started/quick-start/#step-1-access-the-dashboard","title":"Step 1: Access the Dashboard","text":"<p>After starting NILS, navigate to <code>http://localhost:5173</code>. You'll see the main dashboard:</p> <p></p>"},{"location":"getting-started/quick-start/#step-2-import-dicom-data","title":"Step 2: Import DICOM Data","text":"<ol> <li>Click Import in the sidebar</li> <li>Specify the path to your DICOM folder</li> <li>Click Start Import</li> </ol> <p>NILS will scan the folder and extract metadata from all DICOM files.</p> <p>Supported Formats</p> <p>NILS supports standard DICOM files (.dcm) and files without extensions.</p>"},{"location":"getting-started/quick-start/#step-3-review-classification","title":"Step 3: Review Classification","text":"<p>After import, NILS automatically classifies each series:</p> <ul> <li>Navigate to Database to view all imported series</li> <li>Each series shows its detected sequence type (T1w, T2w, FLAIR, etc.)</li> <li>Review and correct any misclassifications if needed</li> </ul>"},{"location":"getting-started/quick-start/#step-4-create-a-cohort","title":"Step 4: Create a Cohort","text":"<p>Cohorts help organize subjects for processing:</p> <ol> <li>Go to Cohorts \u2192 New Cohort</li> <li>Enter a name and description</li> <li>Add subjects from the database</li> <li>Save the cohort</li> </ol>"},{"location":"getting-started/quick-start/#step-5-run-sorting-pipeline","title":"Step 5: Run Sorting Pipeline","text":"<ol> <li>Select your cohort</li> <li>Click Sort in the pipeline steps</li> <li>Configure output directory</li> <li>Start the sorting job</li> </ol> <p>Monitor progress in the Jobs tab.</p>"},{"location":"getting-started/quick-start/#step-6-anonymization-optional","title":"Step 6: Anonymization (Optional)","text":"<p>To de-identify data:</p> <ol> <li>Select sorted data</li> <li>Click Anonymize</li> <li>Review the anonymization profile</li> <li>Run the anonymization job</li> </ol>"},{"location":"getting-started/quick-start/#step-7-bids-export-optional","title":"Step 7: BIDS Export (Optional)","text":"<p>Export to BIDS format:</p> <ol> <li>Select anonymized data</li> <li>Click BIDS Export</li> <li>Configure BIDS metadata</li> <li>Export</li> </ol>"},{"location":"getting-started/quick-start/#next-steps","title":"Next Steps","text":"<ul> <li>Learn about Classification</li> <li>Configure Anonymization</li> <li>Explore the Sorting Workflow</li> </ul>"},{"location":"presentation/","title":"NILS Interactive Overview","text":"<p>Explore the Neuroimaging Intelligent Linked System through our interactive presentation.</p>"},{"location":"presentation/#key-features-used","title":"Key Features Used","text":"<ul> <li>6-Axis Classification: A novel approach to sorting medical images.</li> <li>FastAPI + React: Modern, performant architecture.</li> <li>BIDS Compliance: Ensuring FAIR data principles.</li> </ul> <p>Open Full Screen Presentation</p>"},{"location":"qc/","title":"Quality Control &amp; Viewer","text":"<p>NILS includes a comprehensive QC system for reviewing and correcting classification results, featuring automatic flagging, rules-based validation, and an integrated DICOM viewer.</p>"},{"location":"qc/#qc-system-overview","title":"QC System Overview","text":"<p>The Quality Control system provides:</p> <ol> <li>Automatic Flagging - Series requiring review are flagged during classification</li> <li>Priority Scoring - Issues ranked by severity for efficient workflow</li> <li>Rules Engine - Configurable validation rules detect inconsistencies</li> <li>Draft Pattern - Non-destructive edits until explicitly confirmed</li> <li>Integrated Viewer - WebGL-accelerated DICOM viewing with metadata overlays</li> </ol>"},{"location":"qc/#flagging-system","title":"Flagging System","text":""},{"location":"qc/#how-flagging-works","title":"How Flagging Works","text":"<p>During classification, NILS automatically flags series when:</p> <ol> <li>Detection confidence is low - Detector uncertain about result</li> <li>Conflicting signals exist - Multiple detectors disagree</li> <li>Values are missing - Expected classification absent</li> <li>Ambiguous interpretation - Multiple valid interpretations</li> </ol>"},{"location":"qc/#flag-types","title":"Flag Types","text":"Flag Type Color Icon Description <code>missing</code> Red <code>?</code> Value should be present but isn't <code>conflict</code> Orange <code>\u26a0</code> Conflicting signals from detectors <code>low_confidence</code> Yellow <code>\u2193</code> Detection confidence below threshold <code>ambiguous</code> Purple <code>\u2753</code> Multiple equally valid interpretations <code>review</code> Gray <code>\ud83d\udc41</code> General flag for manual review"},{"location":"qc/#flag-format","title":"Flag Format","text":"<p>Flags are stored as comma-separated reason codes:</p> <pre><code>{axis}:{flag_type}\n</code></pre> <p>Examples: - <code>base:missing</code> - Base contrast not detected - <code>technique:conflict</code> - Technique detectors disagree - <code>provenance:low_confidence</code> - Provenance detection uncertain - <code>body_part:ambiguous</code> - Brain vs spine unclear</p>"},{"location":"qc/#database-storage","title":"Database Storage","text":"<p>Flags are stored in <code>series_classification_cache</code>:</p> Field Type Description <code>manual_review_required</code> Integer (0/1) Binary flag indicating review needed <code>manual_review_reasons_csv</code> Text Comma-separated flag codes"},{"location":"qc/#priority-scoring","title":"Priority Scoring","text":"<p>Items are prioritized for efficient review workflow:</p>"},{"location":"qc/#priority-calculation","title":"Priority Calculation","text":"<pre><code>priority = 0\nif \"low_confidence\" in review_reasons: priority += 1\nif \"missing\" in review_reasons: priority += 2\nif \"ambiguous\" in review_reasons: priority += 2\nif \"conflict\" in review_reasons: priority += 3\n</code></pre>"},{"location":"qc/#priority-interpretation","title":"Priority Interpretation","text":"Priority Meaning Action 3+ Critical Review immediately (conflicts) 2 High Missing or ambiguous values 1 Medium Low confidence detection 0 Low General review flag"},{"location":"qc/#rules-engine","title":"Rules Engine","text":"<p>The rules engine provides configurable validation that evaluates classification results against expected patterns.</p>"},{"location":"qc/#rule-severity-levels","title":"Rule Severity Levels","text":"Level Meaning Action Required ERROR Definite mistake Must be fixed WARNING Likely issue Should review INFO Informational May not need action"},{"location":"qc/#rule-categories","title":"Rule Categories","text":"Category Purpose <code>base</code> Validate base contrast classification <code>technique</code> Validate technique assignment <code>provenance</code> Validate provenance-construct consistency <code>body_part</code> Validate anatomy classification <code>contrast</code> Validate contrast agent status"},{"location":"qc/#built-in-rules","title":"Built-in Rules","text":""},{"location":"qc/#technique-rules","title":"Technique Rules","text":"<p>TechniqueFamilyMismatchRule (ERROR) - Validates technique matches expected echo family - SE techniques (TSE, SPACE, HASTE) should not have GRE constructs - SWIRecon provenance expects GRE family</p> <p>TechniqueMissingRule (WARNING) - Flags when base is classified but technique is missing - Skips localizers and special provenances (SyMRI, SWI)</p>"},{"location":"qc/#body-part-rules","title":"Body Part Rules","text":"<p>BrainAspectRatioRule (WARNING) - Brain scans should have ~1:1 aspect ratio (0.7-1.4) - Elongated ratios (&gt;1.4) suggest spine misclassification</p> <p>SpineAspectRatioRule (WARNING) - Spine scans should have elongated ratio (&gt;1.3) - Near-square ratio suggests brain, not spine</p> <p>LocalizerSliceCountRule (WARNING) - Localizers should have &lt;20 slices - High slice count suggests full acquisition misclassified</p> <p>NonLocalizerLowSliceCountRule (INFO) - Anatomical scans should have &gt;10 slices - Low count may indicate misclassified localizer</p>"},{"location":"qc/#provenance-rules","title":"Provenance Rules","text":"<p>ProvenanceMismatchRule (WARNING) - Validates provenance matches expected constructs - SWIRecon \u2192 SWI, QSM, Phase, Magnitude - DTIRecon \u2192 ADC, FA, MD, Trace - SyMRI \u2192 T1map, T2map, PDmap, Myelin - PerfusionRecon \u2192 CBF, CBV, MTT, Tmax</p>"},{"location":"qc/#contrast-rules","title":"Contrast Rules","text":"<p>ContrastUndeterminedRule (INFO) - T1w anatomical scans should have known contrast status - Unknown pre/post gadolinium status flagged</p>"},{"location":"qc/#base-rules","title":"Base Rules","text":"<p>BaseMissingRule (WARNING) - Anatomical scans should have base contrast - Skips derived maps and special provenances</p>"},{"location":"qc/#rule-context","title":"Rule Context","text":"<p>Rules evaluate against a context containing:</p> <pre><code>@dataclass\nclass RuleContext:\n    # Classification fields\n    base: Optional[str]\n    technique: Optional[str]\n    provenance: Optional[str]\n    modifier_csv: Optional[str]\n    construct_csv: Optional[str]\n    directory_type: Optional[str]\n    post_contrast: Optional[int]\n    localizer: Optional[int]\n    spinal_cord: Optional[int]\n\n    # Geometry fields\n    aspect_ratio: Optional[float]\n    fov_x_mm: Optional[float]\n    fov_y_mm: Optional[float]\n    slices_count: Optional[int]\n\n    # Series info\n    series_description: Optional[str]\n    modality: Optional[str]\n</code></pre>"},{"location":"qc/#review-categories","title":"Review Categories","text":"<p>Items are categorized for focused review:</p> Category Description What to Check <code>base</code> Base contrast weighting Is T1w/T2w/FLAIR correct? <code>provenance</code> Processing pipeline Is SyMRI/SWI detection correct? <code>technique</code> Pulse sequence family Is MPRAGE/TSE/EPI correct? <code>body_part</code> Anatomical region Spinal cord vs brain? <code>contrast</code> Pre/post contrast Contrast agent status? <code>modifier</code> Acquisition modifiers FLAIR/FatSat detection? <code>construct</code> Derived maps ADC/FA map detection? <code>axes</code> All axes combined Full classification review"},{"location":"qc/#qc-workflow","title":"QC Workflow","text":""},{"location":"qc/#1-session-creation","title":"1. Session Creation","text":"<p>Start a QC session for a cohort:</p> <pre><code>User selects cohort \u2192 API creates QCSession\n\u2192 Query metadata_db for manual_review_required = 1\n\u2192 Parse manual_review_reasons_csv by axis\n\u2192 Create QCItem records with priority scores\n</code></pre>"},{"location":"qc/#2-filter-and-navigate","title":"2. Filter and Navigate","text":"<p>Focus on specific issues using filters:</p> <ul> <li>By Axis: base, technique, modifier, provenance, construct</li> <li>By Flag Type: missing, conflict, low_confidence, ambiguous</li> <li>Sorted by: subject_code, study_date, field_strength, manufacturer</li> </ul>"},{"location":"qc/#3-review-item","title":"3. Review Item","text":"<p>For each item:</p> <ol> <li>View DICOM - Examine image with metadata overlays</li> <li>See current classification - Check base, technique, etc.</li> <li>Review flags - Understand why item was flagged</li> <li>Check rule violations - See what rules are violated</li> </ol>"},{"location":"qc/#4-make-corrections-draft-pattern","title":"4. Make Corrections (Draft Pattern)","text":"<p>Edits are saved as drafts in the application database:</p> <pre><code>User selects axis \u2192 picks new value\n\u2192 API: PATCH /api/qc/cohorts/{id}/axes/items/{stack_id}\n\u2192 Creates QCDraftChange in app_db (NOT metadata_db)\n\u2192 UI immediately shows draft status\n</code></pre> <p>Key Benefit: Changes are reversible until explicitly confirmed.</p>"},{"location":"qc/#5-confirm-or-discard","title":"5. Confirm or Discard","text":"<p>Confirm - Push all drafts to metadata database: <pre><code>User clicks \"Submit\"\n\u2192 API: POST /api/qc/cohorts/{id}/axes/confirm\n\u2192 For each draft: UPDATE series_classification_cache\n\u2192 Clear manual_review_required flag\n\u2192 Delete draft records\n</code></pre></p> <p>Discard - Revert all pending changes: <pre><code>User clicks \"Discard\"\n\u2192 API: POST /api/qc/cohorts/{id}/axes/discard\n\u2192 Delete all draft records\n\u2192 No changes to metadata_db\n</code></pre></p>"},{"location":"qc/#6-complete-session","title":"6. Complete Session","text":"<p>When all items reviewed: - Session status \u2192 <code>completed</code> - Corrections persisted in metadata_db - Re-export to apply corrections to output</p>"},{"location":"qc/#dicom-viewer","title":"DICOM Viewer","text":""},{"location":"qc/#features","title":"Features","text":"<p>The integrated viewer supports visual QC:</p> Feature Description Window/Level Adjust contrast and brightness Zoom/Pan Navigate within image Scroll Navigate through slices Metadata Overlays Semi-transparent HUD on image"},{"location":"qc/#hud-overlays","title":"HUD Overlays","text":"<p>The viewer displays acquisition info directly on the image:</p> <p>Acquisition HUD (Top-left) - Modality and acquisition type - Timing parameters: TE, TR, TI, FA - ImageType tokens</p> <p>Sequence HUD (Bottom-left) - Sequence name and protocol - Scanning sequence - Scan options</p> <p>Classification HUD - Current axis values - Flagged axes with color-coded badges</p> <p>FOV HUD - Field of view dimensions - Aspect ratio</p>"},{"location":"qc/#badge-colors","title":"Badge Colors","text":"Color Meaning Red Missing value Orange Conflict detected Yellow Low confidence Purple Ambiguous Gray General review Green Value present (no issues)"},{"location":"qc/#viewer-technology","title":"Viewer Technology","text":"<p>Built on Cornerstone.js: - WebGL-accelerated rendering - Supports common DICOM transfer syntaxes - Runs entirely in browser - Fallback to server-side PNG rendering</p>"},{"location":"qc/#qc-data-models","title":"QC Data Models","text":""},{"location":"qc/#qcsession","title":"QCSession","text":"<p>Tracks overall QC progress for a cohort:</p> Field Type Description <code>cohort_id</code> Integer Associated cohort <code>status</code> Enum pending, in_progress, completed, abandoned <code>total_items</code> Integer Total items requiring review <code>reviewed_items</code> Integer Items reviewed so far <code>confirmed_items</code> Integer Items confirmed correct <code>created_at</code> Timestamp Session creation time <code>started_at</code> Timestamp When review began <code>completed_at</code> Timestamp When review finished"},{"location":"qc/#qcitem","title":"QCItem","text":"<p>Individual item requiring review:</p> Field Type Description <code>session_id</code> Integer Parent session <code>series_instance_uid</code> String Series identifier <code>stack_index</code> Integer Stack within series <code>category</code> Enum Review category (base, technique, etc.) <code>status</code> Enum pending, reviewed, confirmed, skipped <code>priority</code> Integer Prioritization score <code>review_reasons_csv</code> Text Flags triggering review"},{"location":"qc/#qcdraftchange","title":"QCDraftChange","text":"<p>Pending corrections (draft pattern):</p> Field Type Description <code>item_id</code> Integer Parent QCItem <code>field_name</code> String Column being changed <code>original_value</code> Text Value before change <code>new_value</code> Text Proposed new value <code>change_reason</code> Text Why change was made"},{"location":"qc/#api-reference","title":"API Reference","text":""},{"location":"qc/#session-management","title":"Session Management","text":"Endpoint Method Description <code>/api/qc/cohorts/{id}/axes/session</code> GET Get or create axes session <code>/api/qc/sessions/{id}</code> GET Get session details <code>/api/qc/sessions/{id}/summary</code> GET Stats by category/status <code>/api/qc/sessions/{id}/refresh</code> POST Reload from metadata DB"},{"location":"qc/#item-operations","title":"Item Operations","text":"Endpoint Method Description <code>/api/qc/cohorts/{id}/axes/items</code> GET Paginated items with filters <code>/api/qc/axes/items/{stack_id}</code> GET Single stack details <code>/api/qc/cohorts/{id}/axes/items/{stack_id}</code> PATCH Save axis draft"},{"location":"qc/#confirmation","title":"Confirmation","text":"Endpoint Method Description <code>/api/qc/cohorts/{id}/axes/confirm</code> POST Confirm all drafts <code>/api/qc/cohorts/{id}/axes/discard</code> POST Discard all drafts"},{"location":"qc/#options","title":"Options","text":"Endpoint Method Description <code>/api/qc/axes/options</code> GET Available values per axis <code>/api/qc/cohorts/{id}/axes/filters</code> GET Available filters for cohort"},{"location":"qc/#dicom-viewer_1","title":"DICOM Viewer","text":"Endpoint Method Description <code>/api/qc/dicom/{series_uid}/metadata</code> GET Cornerstone.js metadata <code>/api/qc/dicom/{series_uid}/instances</code> GET Instance IDs for navigation <code>/api/qc/dicom/{series_uid}/thumbnail</code> GET Middle slice thumbnail <code>/api/qc/dicom/image/{instance_id}</code> GET PNG rendering <code>/api/qc/dicom/wado</code> GET WADO-URI endpoint"},{"location":"qc/#best-practices","title":"Best Practices","text":""},{"location":"qc/#before-qc","title":"Before QC","text":"<ol> <li>Complete sorting - Ensure all series classified</li> <li>Review summary - Check overall classification distribution</li> <li>Identify patterns - Common misclassifications?</li> </ol>"},{"location":"qc/#during-qc","title":"During QC","text":"<ol> <li>Use filters - Focus on one category at a time</li> <li>Trust the system - Most classifications are correct</li> <li>Start with conflicts - Highest priority issues first</li> <li>Use keyboard navigation - Arrow keys for efficiency</li> </ol>"},{"location":"qc/#after-qc","title":"After QC","text":"<ol> <li>Confirm changes - Push drafts to metadata DB</li> <li>Re-export - Apply corrections to output</li> <li>Report issues - Note recurring problems</li> <li>Refine rules - Update YAML detection rules if needed</li> </ol>"},{"location":"qc/#troubleshooting","title":"Troubleshooting","text":""},{"location":"qc/#no-items-to-review","title":"\"No items to review\"","text":"<ul> <li>Check cohort has been sorted</li> <li>Verify <code>manual_review_required</code> flags exist</li> <li>Check filter settings (axis, flag_type)</li> </ul>"},{"location":"qc/#viewer-not-loading","title":"Viewer Not Loading","text":"<ul> <li>Check browser supports WebGL</li> <li>Verify DICOM file accessibility</li> <li>Check browser console for errors</li> <li>Try PNG fallback mode</li> </ul>"},{"location":"qc/#corrections-not-saving","title":"Corrections Not Saving","text":"<ul> <li>Ensure you clicked \"Submit\" to confirm</li> <li>Check API response for errors</li> <li>Verify database connection</li> <li>Drafts are only in app_db until confirmed</li> </ul>"},{"location":"qc/#rule-violations-not-showing","title":"Rule Violations Not Showing","text":"<ul> <li>Check rules are enabled in rules_engine</li> <li>Verify classification data is complete</li> <li>Check rule category matches review category</li> </ul>"},{"location":"qc/#extending-the-rules-engine","title":"Extending the Rules Engine","text":"<p>To add custom validation rules:</p> <pre><code>from backend.src.qc.rules_engine import QCRule, RuleSeverity, RuleCategory\n\nclass MyCustomRule(QCRule):\n    rule_id = \"my_custom_rule\"\n    category = RuleCategory.BASE\n    name = \"My Custom Rule\"\n    description = \"Validates something specific\"\n    severity = RuleSeverity.WARNING\n\n    def evaluate(self, ctx: RuleContext) -&gt; Optional[RuleViolation]:\n        if some_condition(ctx):\n            return self._create_violation(\n                \"Rule violated because...\",\n                {\"field\": ctx.some_field}\n            )\n        return None\n\n# Register in rules_engine\nrules_engine.register_rule(MyCustomRule())\n</code></pre>"},{"location":"qc/#see-also","title":"See Also","text":"<ul> <li>Classification System - How classification works</li> <li>Branches - Multi-output classification</li> <li>Sorting Workflow - Pre-QC workflow</li> </ul>"}]}